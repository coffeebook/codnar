<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>Code narrator - an inverse literate programming tool.</title>
<style type="text/css">
/*
 * Copyright (c) 2010, Yahoo! Inc. All rights reserved.
 * Code licensed under the BSD License:
 * http://developer.yahoo.com/yui/license.html
 * version: 2.8.2r1
 */
/*
 * YUI Reset
 * @module reset
 * @namespace
 * @requires 
 */
html {
	color: #000;
	background: #FFF;
}

body,
div,
dl,
dt,
dd,
ul,
ol,
li,
h1,
h2,
h3,
h4,
h5,
h6,
pre,
code,
form,
fieldset,
legend,
input,
button,
textarea,
p,
blockquote,
th,
td {
	margin: 0;
	padding: 0;
}

table {
	border-collapse: collapse;
	border-spacing: 0;
}

fieldset,
img {
	border: 0;
}

address,
caption,
cite,
code,
dfn,
em,
strong,
th,
var,
optgroup {
	font-style: inherit;
	font-weight: inherit;
}

del,
ins {
	text-decoration: none;
}

li {
	list-style: none;
}

caption,
th {
	text-align: left;
}

h1,
h2,
h3,
h4,
h5,
h6 {
	font-size: 100%;
	font-weight: normal;
}

q:before,
q:after {
	content: '';
}

abbr,
acronym {
	border: 0;
	font-variant: normal;
}

sup {
	vertical-align: baseline;
}

sub {
	vertical-align: baseline;
}

/*because legend doesn't inherit in IE */
legend {
	color: #000;
}

input,
button,
textarea,
select,
optgroup,
option {
	font-family: inherit;
	font-size: inherit;
	font-style: inherit;
	font-weight: inherit;
}

/*@purpose To enable resizing for IE */
/*@branch For IE6-Win, IE7-Win */
input,
button,
textarea,
select {
	*font-size: 100%;
}



/*
 * Copyright (c) 2010, Yahoo! Inc. All rights reserved.
 * Code licensed under the BSD License:
 * http://developer.yahoo.com/yui/license.html
 * version: 2.8.2r1
 */

/*
 * YUI Base
 * @module base
 * @namespace yui-
 * @requires reset, fonts
 */

body {
	/* For breathing room between content and viewport. */
	margin:10px;
}

h1 {
	/* 18px via YUI Fonts CSS foundation. */
	font-size: 138.5%;
}

h2 {
	/* 16px via YUI Fonts CSS foundation. */
	font-size: 123.1%;
}

h3 {
	/* 14px via YUI Fonts CSS foundation. */
	font-size: 108%;
}

h1,h2,h3 {
	/* Top & bottom margin based on font size. */
	margin: 1em 0;
}

h1,h2,h3,h4,h5,h6,strong,dt {
	/* Bringing boldness back to headers and the strong element. */
	font-weight: bold;
}
optgroup {
	font-weight:normal;
}

abbr,acronym {
	/* Indicating to users that more info is available. */
	border-bottom: 1px dotted #000;
	cursor: help;
}

em {
	/* Bringing italics back to the em element. */
	font-style: italic;
}

del {
	/* Striking deleted phrases. */
	text-decoration: line-through;
}

blockquote,ul,ol,dl {
	/* Giving blockquotes and lists room to breath. */
	margin: 1em;
}

ol,ul,dl {
	/* Bringing lists on to the page with breathing room. */
	margin-left: 2em;
}

ol li {
	/* Giving OL's LIs generated numbers. */
	list-style: decimal outside;
}

ul li {
	/* Giving UL's LIs generated disc markers. */
	list-style: disc outside;
}

dl dd {
	/* Giving UL's LIs generated numbers. */
	margin-left: 1em;
}

th,td {
	/* Borders and padding to make the table readable. */
	border: 1px solid #000;
	padding: .5em;
}

th {
	/* Distinguishing table headers from data cells. */
	font-weight: bold;
	text-align: center;
}

caption {
	/* Coordinated margin to match cell's padding. */
	margin-bottom: .5em;
	/* Centered so it doesn't blend in to other content. */
	text-align: center;
}

sup {
	/* to preserve line-height and selector appearance */
	vertical-align: super;
}

sub {
	/* to preserve line-height and selector appearance */
	vertical-align: sub;
}

p,
fieldset,
table,
pre {
	/* So things don't run into each other. */
	margin-bottom: 1em;
}
/* Opera requires 1px of passing to render with contemporary native chrome */
button,
input[type="checkbox"],
input[type="radio"],
input[type="reset"],
input[type="submit"] {
	padding:1px;
}
/* Margin & Padding */

div.chunk.name,
div.chunk.html,
div.chunk.containers,
div.chunk table,
div.chunk td,
div.chunk pre {
  margin: 0;
  padding: 0;
}
div.chunk *:last-child {
  margin-bottom: 0;
}
h4, h5, h6,
div.chunk,
div.comment pre {
  margin: 1em 0;
}
pre,
div.comment,
div.chunk.html {
  padding: 0.33em;
}

span.control.chunk {
  padding-left: 0.25em;
  padding-right: 0.25em;
}

/* Table of content */

div#contents ul {
  margin-top: 0;
  margin-bottom: 0;
  padding: 0;
}

div#contents li {
  list-style-type: none;
}

/* Lists */

ul.chunk.containers {
  padding: 0;
  margin: 0;
  display: inline;
}
ul.chunk.containers li {
  display: inline;
  list-style-type: none;
}

/* Borders */

pre,
span.control.chunk,
div.chunk.html {
  border: 1px solid #000;
}

table.layout td.indentation,
div.chunk pre {
  border: none;
}

/* Colors */

span.control.chunk,
table.layout td.html {
  background-color: Beige;
}

/* Fonts */

body {
  font-family: Sans-Serif;
}
pre {
  font-family: Consolas, Inconsolata, Monaco, "Courier New", Monospace;
}
div.chunk.name {
  font-weight: bold;
}
/* Colors for GVim classes */
span.Constant   { color: Crimson; }
span.Identifier { color: Teal; }
span.PreProc    { color: Indigo; }
span.Special    { color: Navy; }
span.Statement  { color: Maroon; }
span.Type       { color: Green; }
span.Comment    { color: Purple; }
</style>
</head>
<body>
<div id="contents"></div>
<div class='rdoc doc markup'>
<h1 id="label-Codnar">Codnar</h1>
<p>
Code Narrator - an inverse literate programming tool.
</p>
<h2 id="label-TL%3BDR">TL;DR</h2>

<h3 id="label-Description">Description</h3>
<p>
Code Narrator (Codnar) is an inverse literate programming tool. It splits
the source files into “chunks” (including structured comments) and
weaves them back into a narrative that describes the overall system.
</p>
<h3 id="label-Installation">Installation</h3>
<p>
A simple <code>gem install codnar</code> should do the trick, assuming you
have Ruby gems set up. If you want to use the VIM-based syntax
highlighting, you also need to install <code>gvim</code>. Similarly, you
need to install <code>GraphViz</code> to be able to embed SVG diagrams in
your HTML.
</p>
<h3 id="label-Usage">Usage</h3>
<p>
The basic usage is:
</p>
<pre>codnar-split [options] source-file &gt; chunks-file
codnar-weave [options] chunks-files... &gt; codnar.html</pre>
<p>
Both programs accept a <code>-h</code> or <code>--help</code> flag to print
more detailed usage messages. You can also invoke Codnar from a Rakefile:
</p>
<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;codnar/rake&quot;</span>

<span class="ruby-constant">Codnar</span><span class="ruby-operator">::</span><span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">SplitTask</span>([ <span class="ruby-identifier">source</span><span class="ruby-operator">-</span><span class="ruby-identifier">files</span><span class="ruby-operator">...</span> ], [ <span class="ruby-identifier">configurations</span><span class="ruby-operator">...</span> ])
<span class="ruby-constant">Codnar</span><span class="ruby-operator">::</span><span class="ruby-constant">Rake</span><span class="ruby-operator">::</span><span class="ruby-constant">WeaveTask</span>(<span class="ruby-identifier">root</span><span class="ruby-operator">-</span><span class="ruby-identifier">file</span>, [ <span class="ruby-identifier">configurations</span><span class="ruby-operator">...</span> ], <span class="ruby-identifier">output</span>)
</pre>
</div>
<div class='markdown doc markup'>
<h2>The Story</h2>
<p>
This is the story of the Code Narrator (Codnar) tool. It serves a dual purpose.
It describes the Codnar tool itself, but it also serves as an example of why it
exists in the first place. To explain this more fully, we'll have to make a
little detour into the issue of system documentation.
</p>
<h3>The Documentation Problem</h3>
<p>
Documentation for any system can be grouped to two kinds. The first kind is the
reference manual. If you know of a small piece of the system, this kind of
documentation will give you the details about it. A good reference will help
you find this piece even if you only have a rough idea of what it is named. A
really good reference will also link it to related pieces. A great reference
will even give you example of how to use the related pieces in a realistic
context.
</p>
<p>
Reference manuals are invaluable, and there are plenty of tools to help you
create them. The common approach is the use of structured comments (e.g.,
<a href="http://en.wikipedia.org/wiki/Javadoc">JavaDoc</a>,
<a href="http://en.wikipedia.org/wiki/Doxygen">Doxygen</a>, and a <a href="http://en.wikipedia.org/wiki/Comparison_of_documentation_generators">host of similar
tools</a>).
However, reference manuals by themselves are insufficient.
</p>
<p>
A reference manual only works if you have some idea about how the system works
as a whole. For that, you need some sort of overview. Here there is much less
to help you produce good documentation. The common practice is to sprinkle
small tutorials inside your reference documentation (the <a href="http://msdn.microsoft.com/en-us/library">MSDN
library</a> is a good example). This
doesn't really solve the problem: how do you sufficiently explain a complex new
system, so that references and small tutorials become useful?
</p>
<p>
One possible solution to this problem, <a href="http://en.wikipedia.org/wiki/Literate_programming">literate
programming</a>, was proposed
by Knuth. In a nutshell, the idea was that the source code for the system
fulfilled a dual role. You could compile it into the executable code, as
expected. But you could also generate documentation from it.
</p>
<p>
So far this sounds a lot like structured comments, and indeed structured
comments were inspired by literate programming. The key difference between the
two approaches is that in literate programming, the generated documentation was
not a reference manual. It was a linear narrative describing the system - a
story which walked you through the system in an specific path chosen for
optimal presentation.
</p>
<p>
To achieve this, the sources contained the linear documentation, with embedded
code "chunks". The order of the chunks in the sources was determined by the
narrative, not the programming language requirements. Extracting and
re-ordering these chunks was part of the build process, so the regular compiler
could process them as usual.
</p>
<p>
This was the great strength, but also the great weakness, of literate
programming. For example, it is next to impossible to create IDEs and similar
tools for literate programming source code. The code chunks are split any which
way and spread around the source files in any order; the same source file may
contain chunks in several languages; etc. Automatically figuring out, say, the
list of members of some class would be a daunting task.
</p>
<p>
In contrast, structured comments stay out of the way of the IDE and similar
tools. The source code is still structured exactly the way the compiler wants,
which allows for easy, localized processing. The trade-off, of course, is that
structured comments produce a reference manual, not a narrative.
</p>
<p>
Today, structured comments have taken over the coding world, and literate
programming has all but been forgotten. The problem it tried to solve, however,
is still very much with us. How do we explain a new complex system?
</p>
<h3>A Different Approach</h3>
<p>
Codnar is an example of a different approach for solving this problem, "inverse
literate programming" (similar to, for example,
<a href="http://packages.python.org/antiweb/">antiweb</a>). This approach is a combination
of structured comments and literate programming. Note that this approach is
similar to, but different in key aspects from, <a href="http://ssw.jku.at/Research/Projects/RevLitProg/">reverse literate
programming</a>.
</p>
<p>
In inverse literate programming, the source files are organized just
the way the compiler, IDE, and similar tools expect them to be. Structured
comments are used to document the pieces of code, and a reference manual can be
generated from the sources as usual.
</p>
<p>
In addition, the code is split into (possibly nested) named "chunks". This is
done using specially formatted comments. It turns out this functionality is
already supported by most coding editors and IDEs, in the form of "folds" or
"regions". These allow the developer to collapse or expand such chunks at will.
</p>
<p>
At this point, inverse literate programming kicks in. The developer writes
additional documentation source files, next to the usual code source files.
These documentation source files contain a narrative that describes the system,
much in the same way that a literate programming documentation would have done,
with two important differences.
</p>
<p>
The first difference is that the documentation source files refer to and embed
the code chunks (using their names), as opposed to a literate programming
system, where the documentation source files actually contain the code chunks.
</p>
<p>
The second difference is that the documentation source files do not need to
repeat the information that is already covered in the structured comments. When
a code chunk is embedded into the documentation, it includes these comments, so
all the documentation source files need to contain is the narrative "glue" for
placing these pieces into a comprehensible context for the reader.
</p>
<p>
In this way, inverse literate programming allows generating a linear narrative
describing the system, without abandoning the existing code processing tools.
It also makes it easy to retrofit such documentation to an existing code base;
all that's needed is to mark the already-documented code chunks (or even just
treat each source code file as a single chunk), and provide the narrative glue
around them.
</p>
<h3>Maintaining the Documentation</h3>
<p>
Structutred comments have the advantage that they are easy to maintain. Every
time you change a piece of code, change its comment to match. Simiarlt,
literate programming forced one to maintain the documentation as well, since
the same source file was used for code and documentation. Inverse literate
programming does not share this advantage. The linear documentation is in a
separate file, so it isn't immediately visible to the developer who is making
the changes. Also, it is easy to just forget to include some chunks of code in
the documentation.
</p>
<p>
These issues are very similar to the issues of unit testing. Unit tests live in
a separate file from the code they test, and it is easy to forget to test some
chunks of code. One way to ensure all code is tested is to use a code coverage
tool. Similarly, inverse literate programming tools should complain about code
chunks that are left out of the final narrative.
</p>
<p>
A different approach,
<a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a>, ensures that the
tests are up-to-date and complete by writing the tests before the code. The
same approach can be used for documentation.
<a href="http://thinkingphp.org/spliceit/docs/0.1_alpha/pages/ddd_info.html">DDD</a> means
that you first document what you are about to do, and only then follow up with
the actual coding. Inverse literate programming and TDD are an excellent
practical way to achieve that.
</p>
<p>
The unit tests are code like any other code. As such, they should be documented
using structured comments. Certain unit test tools like
<a href="http://rspec.info/">RSpec</a>, <a href="http://cukes.info/">Cucumber</a> and other
<a href="http://en.wikipedia.org/wiki/Behavior_Driven_Development">BDD</a> tools blur the
line between the tests-as-code and the tests-as-documentation anyway, so the
amount of unit test structured documentation should be small.
</p>
<p>
Therefore, if you are writing the tests first, you have done the heavy lifting
of documenting what the new code will do. All that is left is providing a bit
of surrounding context and embedding it all in the currect location in the
narrative. Then, when you write the new code itself, it should be easy to
connect it to the narrative at the appropriate point.
</p>
<p>
In the case of Code Narrator itself, the number of (raw) lines in the code
library itself is ~2100 lines, the number of test code lines is ~2200 lines,
and the number of narrative documentation lines is only ~900 lines. Given
narrative documentation are easier to write than system (or test) code, this
indicates maintaining a narrative is not an unreasonable burden for a
well-tested project.
</p>
<h3>Code Narrator</h3>
<p>
Codnar is an inverse literate programming tool. It allows you to tell a story
about your system, which will explain it to others: developers, maintainers,
and/or users. It builds on the structured comments you would write anyway to
generate a reference manual for the system, requires minimal or no changes to
your source code files, and works perfectly well inside your favorite IDE or
editor. If you follow TDD or BDD, Codnar will make it easier for you to
complement it with DDD.
</p>
<p>
Codnar is available under the MIT license:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="license">
<span>LICENSE</span>
</a>
</div>
<div class="chunk html">
<div class='rdoc doc markup'>
<p>
Copyright © 2010-2011 Oren Ben-Kiki
</p>
<p>
Permission is hereby granted, free of charge, to any person obtaining a
copy of this software and associated documentation files (the
“Software”), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to permit
persons to whom the Software is furnished to do so, subject to the
following conditions:
</p>
<p>
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
</p>
<p>
THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS
OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
</p>
</div>
</div>
</div>
</p>
<p>
And the current Codnar version is:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-version-rb">
<span>lib/codnar/version.rb</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
This module contains all the code narrator code.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
This version number. The third number is automatically updated to track the
number of Git commits by running <code>rake version</code>.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Type">VERSION</span> = <span class="Special">&quot;</span><span class="Constant">0.1.76</span><span class="Special">&quot;</span>

end
</pre>
</div>
</div>
</p>
<p>
The rest of this document goes into the details of Codnar's implementation. The
core of the system is the following simple data flow: A set of source files is
split into chunks; the chunks are woven into a single HTML. This simple flow
can be enhanced by pre-processing the sources, or post-processing the HTML. In
a realistic project, all this would be managed by some build tool; either using
the command-line (for arbitrary build tools) or using the provided Ruby classes
for Rake integration.
</p>
</div>
<div class='markdown doc markup'>
<h2>Data Flow</h2>
<p>
Here is a diagram showing the overall data flow in a system documented with
Codnar:
</p>
<p>
<div class="plain chunk">
<a name="doc-dataflow-dot"/>
<div class='graphviz doc markup'>
<svg width="512pt" height="98pt"
 viewBox="0.00 0.00 512.00 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph1" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>Codnar Dataflow</title>
<polygon fill="white" stroke="white" points="-4,5 -4,-94 509,-94 509,5 -4,5"/>
<!-- Documentation -->
<g id="node1" class="node"><title>Documentation</title>
<polygon fill="none" stroke="black" points="101,-90 1,-90 1,-54 101,-54 101,-90"/>
<text text-anchor="middle" x="51" y="-67.4" font-family="Times New Roman,serif" font-size="14.00">Documentation</text>
</g>
<!-- Split -->
<g id="node3" class="node"><title>Split</title>
<ellipse fill="none" stroke="black" cx="169" cy="-72" rx="28.1745" ry="18"/>
<text text-anchor="middle" x="169" y="-67.4" font-family="Times New Roman,serif" font-size="14.00">Split</text>
</g>
<!-- Documentation&#45;&gt;Split -->
<g id="edge2" class="edge"><title>Documentation&#45;&gt;Split</title>
<path fill="none" stroke="black" d="M101.727,-72C111.44,-72 121.457,-72 130.699,-72"/>
<polygon fill="black" stroke="black" points="130.745,-75.5001 140.745,-72 130.745,-68.5001 130.745,-75.5001"/>
</g>
<!-- Sources -->
<g id="node2" class="node"><title>Sources</title>
<polygon fill="none" stroke="black" points="82,-36 20,-36 20,-1.06581e-014 82,-0 82,-36"/>
<text text-anchor="middle" x="51" y="-13.4" font-family="Times New Roman,serif" font-size="14.00">Sources</text>
</g>
<!-- Sources&#45;&gt;Split -->
<g id="edge4" class="edge"><title>Sources&#45;&gt;Split</title>
<path fill="none" stroke="black" d="M82.0031,-32.1879C98.785,-39.8677 119.501,-49.3478 136.507,-57.1305"/>
<polygon fill="black" stroke="black" points="135.485,-60.5114 146.034,-61.4902 138.397,-54.1463 135.485,-60.5114"/>
</g>
<!-- Build -->
<g id="node7" class="node"><title>Build</title>
<ellipse fill="none" stroke="black" cx="169" cy="-18" rx="30.8577" ry="18"/>
<text text-anchor="middle" x="169" y="-13.4" font-family="Times New Roman,serif" font-size="14.00">Build</text>
</g>
<!-- Sources&#45;&gt;Build -->
<g id="edge9" class="edge"><title>Sources&#45;&gt;Build</title>
<path fill="none" stroke="black" d="M82.0031,-18C95.9842,-18 112.696,-18 127.718,-18"/>
<polygon fill="black" stroke="black" points="127.794,-21.5001 137.794,-18 127.794,-14.5001 127.794,-21.5001"/>
</g>
<!-- Chunks -->
<g id="node4" class="node"><title>Chunks</title>
<polygon fill="none" stroke="black" points="298,-90 240,-90 240,-54 298,-54 298,-90"/>
<text text-anchor="middle" x="269" y="-67.4" font-family="Times New Roman,serif" font-size="14.00">Chunks</text>
</g>
<!-- Split&#45;&gt;Chunks -->
<g id="edge5" class="edge"><title>Split&#45;&gt;Chunks</title>
<path fill="none" stroke="black" d="M197.122,-72C207.103,-72 218.533,-72 229.298,-72"/>
<polygon fill="black" stroke="black" points="229.346,-75.5001 239.346,-72 229.346,-68.5001 229.346,-75.5001"/>
</g>
<!-- Weave -->
<g id="node5" class="node"><title>Weave</title>
<ellipse fill="none" stroke="black" cx="375" cy="-72" rx="36.8951" ry="18"/>
<text text-anchor="middle" x="375" y="-67.4" font-family="Times New Roman,serif" font-size="14.00">Weave</text>
</g>
<!-- Chunks&#45;&gt;Weave -->
<g id="edge6" class="edge"><title>Chunks&#45;&gt;Weave</title>
<path fill="none" stroke="black" d="M298.527,-72C307.529,-72 317.663,-72 327.539,-72"/>
<polygon fill="black" stroke="black" points="327.677,-75.5001 337.677,-72 327.677,-68.5001 327.677,-75.5001"/>
</g>
<!-- HTML -->
<g id="node6" class="node"><title>HTML</title>
<polygon fill="none" stroke="black" points="504,-90 448,-90 448,-54 504,-54 504,-90"/>
<text text-anchor="middle" x="476" y="-67.4" font-family="Times New Roman,serif" font-size="14.00">HTML</text>
</g>
<!-- Weave&#45;&gt;HTML -->
<g id="edge7" class="edge"><title>Weave&#45;&gt;HTML</title>
<path fill="none" stroke="black" d="M412.035,-72C420.348,-72 429.186,-72 437.555,-72"/>
<polygon fill="black" stroke="black" points="437.83,-75.5001 447.83,-72 437.83,-68.5001 437.83,-75.5001"/>
</g>
<!-- Program -->
<g id="node8" class="node"><title>Program</title>
<polygon fill="none" stroke="black" points="301,-36 237,-36 237,-1.06581e-014 301,-0 301,-36"/>
<text text-anchor="middle" x="269" y="-13.4" font-family="Times New Roman,serif" font-size="14.00">Program</text>
</g>
<!-- Build&#45;&gt;Program -->
<g id="edge10" class="edge"><title>Build&#45;&gt;Program</title>
<path fill="none" stroke="black" d="M200.092,-18C208.334,-18 217.38,-18 226.128,-18"/>
<polygon fill="black" stroke="black" points="226.196,-21.5001 236.196,-18 226.196,-14.5001 226.196,-21.5001"/>
</g>
</g>
</svg>
</div>
</div>
</p>
<h2>Splitting files into chunks</h2>
<p>
Codnar makes the reasonable assumption that each source file can be effectively
processed as a sequence of lines. This works well in practice for all "text"
source files. It fails miserably for "binary" source files, but such files
don't work that well in most generic source management tools (such as version
management systems).
</p>
<p>
A second, less obvious assumption is that it is possible to classify the source
file lines to "kinds" using a simple state machine. The classified lines are
then grouped into nested chunks based on the two special line kinds
<code>begin_chunk</code> and <code>end_chunk</code>. The other line kinds are used to control how the
lines are formatted into HTML.
</p>
<p>
The collected chunks, with the formatted HTML for each one, are then stored in
a chunks file to be used later for weaving the overall HTML narrative.
</p>
<h3>Scanning Lines</h3>
<p>
Scanning a file into classified lines is done by the <code>Scanner</code> class.
Here is a simple test that demonstrates using the scanner:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-scan-lines-rb">
<span>test/scan_lines.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test scanning classified lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestScanLines</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>

  <span class="PreProc">def</span> <span class="Identifier">test_scan_lines</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">comments</span><span class="Special">&quot;</span>, <span class="Type">INPUT</span>)
    scanner = <span class="Type">Codnar</span>::<span class="Type">Scanner</span>.new(<span class="Identifier">@errors</span>, <span class="Type">SYNTAX</span>)
    scanner.lines(<span class="Special">&quot;</span><span class="Constant">comments</span><span class="Special">&quot;</span>).should == <span class="Type">LINES</span>
    <span class="Identifier">@errors</span>.should == <span class="Type">ERRORS</span>
  <span class="PreProc">end</span>

  <span class="Type">SYNTAX</span> = {
    <span class="Special">&quot;</span><span class="Constant">start_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">shell</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)#+</span><span class="Special">\\</span><span class="Constant">s*(.*)$</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">groups</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> ],
        <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>,
      },
      <span class="Special">&quot;</span><span class="Constant">c++</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">/</span><span class="Special">^</span><span class="Special">(</span><span class="Special">\s</span><span class="Special">*</span><span class="Special">)</span><span class="Special">\/\/</span><span class="Special">+</span><span class="Special">\s</span><span class="Special">*</span><span class="Special">(</span><span class="Special">.</span><span class="Special">*</span><span class="Special">)</span><span class="Special">$</span><span class="Special">/</span>,
        <span class="Special">&quot;</span><span class="Constant">groups</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> ],
        <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>,
      },
      <span class="Special">&quot;</span><span class="Constant">invalid</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">(</span><span class="Special">&quot;</span> },
    },
    <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
          { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">shell</span><span class="Special">&quot;</span> },
          { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">c++</span><span class="Special">&quot;</span> },
          { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">no-such-pattern</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">next_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">no-such-state</span><span class="Special">&quot;</span> },
        ],
      },
    },
  }

  <span class="Type">INPUT</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.gsub(<span class="Special">&quot;</span><span class="Constant">#!</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">#</span><span class="Special">&quot;</span>)
<span class="Constant">    #! foo</span>
<span class="Constant">     // bar</span>
<span class="Constant">      baz</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="Type">LINES</span> = [ {
    <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"># foo</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>,
  }, {
    <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> // bar</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>,
  }, {
    <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">error</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  baz</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  </span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">baz</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">3</span>,
  } ]

  <span class="Type">ERRORS</span> = [
    <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Invalid pattern: invalid regexp: ( error: premature end of regular expression: /(/</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Reference to a missing pattern: no-such-pattern</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Reference to a missing state: no-such-state</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: State: comment failed to classify line: baz in file: comments at line: 3</span><span class="Special">&quot;</span>
  ]

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-scanner-rb">
<span>lib/codnar/scanner.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Scan a file into classified lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Scanner</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Construct a scanner based on a syntax in the following structure:
</p>
<pre>patterns:
  &lt;name&gt;:
    name: &lt;name&gt;
    kind: &lt;kind&gt;
    regexp: &lt;regexp&gt;
    groups:
    - &lt;name&gt;
states:
  &lt;name&gt;:
    name: &lt;name&gt;
    transitions:
    - pattern: &lt;pattern&gt;
      kind: &lt;kind&gt;
      next_state: &lt;state&gt;
start_state: &lt;state&gt;</pre>
<p>
To allow for cleaner YAML files to specify the syntax, the following
shorthands are supported:
</p>
<ul><li>
<p>
A pattern or state reference can be presented by the string name of the
pattern or state.
</p>
</li><li>
<p>
The name field of a state or pattern can be ommitted. If specified, it must
be identical to the key in the states or patterns mapping.
</p>
</li><li>
<p>
The kind field of a pattern can be ommitted; by default it is assumed to be
identical to the pattern name.
</p>
</li><li>
<p>
A pattern regexp can be presented by a plain string.
</p>
</li><li>
<p>
The pattern groups field can be ommitted or contain <code>nil</code> if it
is equal to [ “indentation”, “payload” ].
</p>
</li><li>
<p>
The kind field of a transition can be ommitted; by default it is assumed to
be identical to the pattern kind. If it ends up <code>nil</code>, this
indicates that there’s no kind assigned by the pattern, and the current
line should be classified again by the next state.
</p>
</li><li>
<p>
The next state of a transition can be ommitted; by default it is assumed to
be identical to the containing state.
</p>
</li><li>
<p>
The start state can be ommitted; by default it is assumed to be named
<code>start</code>.
</p>
</li></ul>
<p>
When the Scanner is constructed, a deep clone of the syntax object is
created and modified to expand all the above shorthands. Any problems
detected during this process are pushed into the errors.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(errors, syntax)
      <span class="Identifier">@errors</span> = errors
      <span class="Identifier">@syntax</span> = syntax.deep_clone
      <span class="Identifier">@syntax</span>.patterns.each { |<span class="Identifier">name</span>, <span class="Identifier">pattern</span>| expand_pattern_shorthands(name, pattern) }
      <span class="Identifier">@syntax</span>.states.each { |<span class="Identifier">name</span>, <span class="Identifier">state</span>| expand_state_shorthands(name, state) }
      <span class="Identifier">@syntax</span>.start_state = resolve_start_state
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Scan a disk file into classified lines in the following format (where the
groups contain the text extracted by the matching pattern):
</p>
<pre>- kind: &lt;kind&gt;
  line: &lt;text&gt;
  &lt;group&gt;: &lt;text&gt;</pre>
<p>
By convention, each classified line has a “payload” group that contains
the “main” content of the line (chunk name for begin/end/nested chunk
lines, clean comment text for comment lines, etc.). In addition, most
classified lines have an “indentation” group that contains the leading
white space (which is not included in the payload).
</p>
<p>
If at some state, a file line does not match any pattern, the scanner will
push a message into the errors. In addition it will classify the line as
follows:
</p>
<pre>- kind: error
  state: &lt;name&gt;
  line: &lt;text&gt;
  indentation: &lt;leading white space&gt;
  payload: &lt;line text following the indentation&gt;</pre>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">lines</span>(path)
      <span class="Identifier">@path</span> = path
      <span class="Identifier">@lines</span> = []
      <span class="Identifier">@state</span> = <span class="Identifier">@syntax</span>.start_state
      <span class="Identifier">@errors</span>.in_file_lines(path) { |<span class="Identifier">line</span>| scan_line(line.chomp) }
      <span class="Statement">return</span> <span class="Identifier">@lines</span>
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#scanner-pattern-shorthands'>Scanner pattern shorthands</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#scanner-state-shorthands'>Scanner state shorthands</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#scanner-file-processing'>Scanner file processing</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#scanner-line-processing'>Scanner line processing</a>
</pre>
<pre class='ruby code syntax'>

  end

end
</pre>
</div>
</div>
</p>
<p>
As we can see, the implementation is split into two main parts. First, all
shorthands in the syntax definition are expanded (possibly generating errors).
Then, the expanded syntax is applied to a file, to generate a sequence of
classified lines.
</p>
<h4>Scanner Syntax Shorthands</h4>
<p>
The syntax is expected to be written by hand in a YAML file. We therefore
provide some convenient shorthands (listed above) to make YAML syntax files
more readable. These shorthands must be expanded to their full form before we
can apply the syntax to a file. There are two sets of shorthands we need to
expand:
</p>
<ul>
<li>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="scanner-pattern-shorthands">
<span>Scanner pattern shorthands</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Expand all the shorthands used in the pattern.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">expand_pattern_shorthands</span>(name, pattern)
  pattern.kind ||= fill_name(name, pattern, <span class="Special">&quot;</span><span class="Constant">Pattern</span><span class="Special">&quot;</span>)
  pattern.groups ||= [ <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> ]
  pattern.regexp = convert_to_regexp(name, pattern.regexp)
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert a string regexp to a real Regexp.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">convert_to_regexp</span>(name, regexp)
  <span class="Statement">return</span> regexp <span class="Statement">if</span> <span class="Type">Regexp</span> == regexp
  <span class="Statement">begin</span>
    <span class="Statement">return</span> <span class="Type">Regexp</span>.new(regexp)
  <span class="Statement">rescue</span>
    <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">Invalid pattern: </span><span class="Special">#{</span>name<span class="Special">}</span><span class="Constant"> regexp: </span><span class="Special">#{</span>regexp<span class="Special">}</span><span class="Constant"> error: </span><span class="Special">#{</span><span class="Identifier">$!</span><span class="Special">}</span><span class="Special">&quot;</span>
  <span class="Statement">end</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Fill in the name field for state or pattern object.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">fill_name</span>(name, data, type)
  data_name = data.name ||= name
  <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Special">#{</span>type<span class="Special">}</span><span class="Constant">: </span><span class="Special">#{</span>name<span class="Special">}</span><span class="Constant"> has wrong name: </span><span class="Special">#{</span>data_name<span class="Special">}</span><span class="Special">&quot;</span> <span class="Statement">if</span> data_name != name
  <span class="Statement">return</span> data_name
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-scanner-rb">lib/codnar/scanner.rb</a>
</li>
</ul>
</div>
</div>
</p>
</li>
<li>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="scanner-state-shorthands">
<span>Scanner state shorthands</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
A pattern that matches any line and extracts no data; is meant to be used
for catch-all transitions that transfer the scanning to a different state.
It is used if no explicit pattern is specified in a transition (that is,
you can think of this as the <code>nil</code> pattern).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CATCH_ALL_PATTERN</span> = {
  <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Constant">nil</span>,
  <span class="Special">&quot;</span><span class="Constant">groups</span><span class="Special">&quot;</span> =&gt; [],
  <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">//</span>
}

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Expand all the shorthands used in the state.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">expand_state_shorthands</span>(name, state)
  fill_name(name, state, <span class="Special">&quot;</span><span class="Constant">State</span><span class="Special">&quot;</span>)
  state.transitions.each <span class="Statement">do</span> |<span class="Identifier">transition</span>|
    pattern = transition.pattern = lookup(<span class="Identifier">@syntax</span>.patterns, <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span>, transition.pattern || <span class="Type">CATCH_ALL_PATTERN</span>)
    transition.kind ||= pattern.andand.kind
    transition.next_state = lookup(<span class="Identifier">@syntax</span>.states, <span class="Special">&quot;</span><span class="Constant">state</span><span class="Special">&quot;</span>, transition.next_state || state)
  <span class="Statement">end</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert a string name to an actual data reference.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">lookup</span>(mapping, type, reference)
  <span class="Statement">return</span> reference <span class="Statement">unless</span> <span class="Type">String</span> === reference
  data = mapping[reference]
  <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">Reference to a missing </span><span class="Special">#{</span>type<span class="Special">}</span><span class="Constant">: </span><span class="Special">#{</span>reference<span class="Special">}</span><span class="Special">&quot;</span> <span class="Statement">unless</span> data
  <span class="Statement">return</span> data
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Resolve the start state reference.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">resolve_start_state</span>
  <span class="Statement">return</span> lookup(<span class="Identifier">@syntax</span>.states, <span class="Special">&quot;</span><span class="Constant">state</span><span class="Special">&quot;</span>, <span class="Identifier">@syntax</span>.start_state || <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span>) || {
    <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">missing_start_state</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">error</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; []
  }
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-scanner-rb">lib/codnar/scanner.rb</a>
</li>
</ul>
</div>
</div>
</p>
</li>
</ul>
<p>
The above code modifies the syntax object in place. This is safe because we are
working on a <code>deep_clone</code> of the original syntax:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-hash-extensions-rb">
<span>lib/codnar/hash_extensions.rb</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Extend the core Hash class.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">Hash</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Obtain a deep clone which shares nothing with this hash.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">def</span> <span class="Identifier">deep_clone</span>
    <span class="Statement">return</span> <span class="Type">YAML</span>.load(to_yaml)
  <span class="PreProc">end</span>

</pre>
<pre class='nested chunk'>
  <a class='nested chunk' href='#deep-merge'>Deep merge</a>
</pre>
<pre class='ruby code syntax'>

end
</pre>
</div>
</div>
</p>
<h4>Classifying Source Lines</h4>
<p>
Scanning a file to classified lines is a simple matter of applying the current
state transitions to each line:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="scanner-file-processing">
<span>Scanner file processing</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Scan the next file line.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">scan_line</span>(line)
  <span class="Statement">until</span> state_classified_line(line)
</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Do nothing
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  end
end

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Scan the current line using the current state transitions. Return true if
the line was classified, of false if we need to try and classify it again
using the updated (next) state.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">state_classified_line</span>(line)
  <span class="Identifier">@state</span>.transitions.each <span class="Statement">do</span> |<span class="Identifier">transition</span>|
    match = transition.pattern.andand.regexp.andand.match(line) <span class="Statement">if</span> transition.next_state
    <span class="Statement">return</span> classify_matching_line(line, transition, match) <span class="Statement">if</span> match
  <span class="Statement">end</span>
  classify_error_line(line, <span class="Identifier">@state</span>.name)
  <span class="Statement">return</span> <span class="Constant">true</span>
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-scanner-rb">lib/codnar/scanner.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
If a line matches a state transition, it is classified accordingly. Otherwise,
it is reported as an error:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="scanner-line-processing">
<span>Scanner line processing</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Handle a file line, only if it matches the pattern.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">classify_matching_line</span>(line, transition, match)
  <span class="Identifier">@state</span> = transition.next_state
  kind = transition.kind
  <span class="Statement">return</span> <span class="Constant">false</span> <span class="Statement">unless</span> kind <span class="Comment"># A +nil+ kind indicates the next state will classify the line.</span>
  <span class="Identifier">@lines</span> &lt;&lt; <span class="Type">Scanner</span>.extracted_groups(match, transition.pattern.groups || []).update({
    <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; line,
    <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; kind,
    <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Identifier">@errors</span>.line_number
  })
  <span class="Statement">return</span> <span class="Constant">true</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Extract named groups from a match. As a special case, indentation is
deleted if there is no payload.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">extracted_groups</span>(match, groups)
  extracted = {}
  groups.each_with_index <span class="Statement">do</span> |<span class="Identifier">group</span>, <span class="Identifier">index</span>|
    extracted[group] = match[index + <span class="Constant">1</span>]
  <span class="Statement">end</span>
  extracted.delete(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span>) <span class="Statement">if</span> match[<span class="Constant">0</span>] == <span class="Special">&quot;&quot;</span>
  <span class="Statement">return</span> extracted
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Handle a file line that couldn’t be classified.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">classify_error_line</span>(line, state_name)
  <span class="Identifier">@lines</span> &lt;&lt; {
    <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; line,
    <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; line.indentation,
    <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; line.unindent,
    <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">error</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">state</span><span class="Special">&quot;</span> =&gt; state_name,
    <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Identifier">@errors</span>.line_number
  }
  <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">State: </span><span class="Special">#{</span>state_name<span class="Special">}</span><span class="Constant"> failed to classify line: </span><span class="Special">#{</span><span class="Identifier">@lines</span>.last.payload<span class="Special">}</span><span class="Special">&quot;</span>
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-scanner-rb">lib/codnar/scanner.rb</a>
</li>
</ul>
</div>
</div>
</p>
<h3>Merging scanned lines to chunks</h3>
<p>
Once we have the array of scanned classified lines, we need to merge them into
nested chunks. Here is a simple test that demonstrates using the merger:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-merge-lines-rb">
<span>test/merge_lines.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test merging classified lines to chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestMergeLines</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>

  <span class="PreProc">def</span> <span class="Identifier">test_merge_no_chunks</span>
    lines = [ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> } ]
    chunks = <span class="Type">Codnar</span>::<span class="Type">Merger</span>.chunks(<span class="Identifier">@errors</span>, <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, lines)
    <span class="Identifier">@errors</span>.should == []
    chunks.should == [ {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">lines</span><span class="Special">&quot;</span> =&gt; lines
    } ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_valid_merge</span>
    chunks = <span class="Type">Codnar</span>::<span class="Type">Merger</span>.chunks(<span class="Identifier">@errors</span>, <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, <span class="Type">VALID_LINES</span>)
    <span class="Identifier">@errors</span>.should == []
    chunks.should == <span class="Type">VALID_CHUNKS</span>
  <span class="PreProc">end</span>

  <span class="Type">VALID_LINES</span> = [
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>,        <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>,  <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">before top</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,     <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">before top</span><span class="Special">&quot;</span>          },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> {{{ top chunk</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>,    <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">top chunk</span><span class="Special">&quot;</span>           },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>,         <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">3</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> before intermediate</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>,    <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">before intermediate</span><span class="Special">&quot;</span> },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">4</span>,  <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  {{{ intermediate chunk</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  </span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">intermediate chunk</span><span class="Special">&quot;</span>  },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>,        <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">5</span>,  <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  before inner</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  </span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">before inner</span><span class="Special">&quot;</span>        },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">6</span>,  <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">   {{{ inner chunk</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">   </span><span class="Special">&quot;</span>,  <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">inner chunk</span><span class="Special">&quot;</span>         },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>,        <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">7</span>,  <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">   inner line</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">   </span><span class="Special">&quot;</span>,  <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">inner line</span><span class="Special">&quot;</span>          },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">8</span>,  <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">   }}} inner chunk</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">   </span><span class="Special">&quot;</span>,  <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">inner chunk</span><span class="Special">&quot;</span>         },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>,        <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">9</span>,  <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  after inner</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  </span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">after inner</span><span class="Special">&quot;</span>         },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">10</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  }}}</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  </span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>                    },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>,        <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">11</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> after intermediate</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>,    <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">after intermediate</span><span class="Special">&quot;</span>  },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">12</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> }}} TOP CHUNK</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>,    <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">TOP CHUNK</span><span class="Special">&quot;</span>           },
    { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>,        <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">13</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">after top</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,     <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">after top</span><span class="Special">&quot;</span>           }
  ]

  <span class="Type">VALID_CHUNKS</span> = [
    { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">top chunk</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">lines</span><span class="Special">&quot;</span> =&gt; [
        <span class="Type">VALID_LINES</span>[<span class="Constant">0</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">nested_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> {{{ top chunk</span><span class="Special">&quot;</span>,
          <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>,     <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">top chunk</span><span class="Special">&quot;</span> },
        <span class="Type">VALID_LINES</span>[<span class="Constant">12</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
      ] },
    { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">top chunk</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span> } ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">intermediate chunk</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">lines</span><span class="Special">&quot;</span> =&gt; [
        <span class="Type">VALID_LINES</span>[<span class="Constant">1</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        <span class="Type">VALID_LINES</span>[<span class="Constant">2</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">nested_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">4</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  {{{ intermediate chunk</span><span class="Special">&quot;</span>,
          <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>,     <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">intermediate chunk</span><span class="Special">&quot;</span> },
        <span class="Type">VALID_LINES</span>[<span class="Constant">10</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        <span class="Type">VALID_LINES</span>[<span class="Constant">11</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
      ] },
    { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">intermediate chunk</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">4</span> } ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">top chunk</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">inner chunk</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">lines</span><span class="Special">&quot;</span> =&gt; [
        <span class="Type">VALID_LINES</span>[<span class="Constant">3</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        <span class="Type">VALID_LINES</span>[<span class="Constant">4</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">nested_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">6</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">   {{{ inner chunk</span><span class="Special">&quot;</span>,
          <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>,     <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">inner chunk</span><span class="Special">&quot;</span> },
        <span class="Type">VALID_LINES</span>[<span class="Constant">8</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        <span class="Type">VALID_LINES</span>[<span class="Constant">9</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
      ] },
    { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">inner chunk</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">6</span> } ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">intermediate chunk</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">lines</span><span class="Special">&quot;</span> =&gt; [
        <span class="Type">VALID_LINES</span>[<span class="Constant">5</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        <span class="Type">VALID_LINES</span>[<span class="Constant">6</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>),
        <span class="Type">VALID_LINES</span>[<span class="Constant">7</span>].merge(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>)
      ] }
  ]

  <span class="PreProc">def</span> <span class="Identifier">test_mismatching_end_chunk_line</span>
    lines = [
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">{{{ top chunk</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,     <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">top chunk</span><span class="Special">&quot;</span>     },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">}}} not top chunk</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,     <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">not top chunk</span><span class="Special">&quot;</span> }
    ]
    <span class="Type">Codnar</span>::<span class="Type">Merger</span>.chunks(<span class="Identifier">@errors</span>, <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, lines)
    <span class="Identifier">@errors</span>.should == [
      <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: End line for chunk: not top chunk mismatches begin line for chunk: top chunk in file: path at line: 2</span><span class="Special">&quot;</span>
    ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_missing_begin_chunk_name</span>
    lines = [
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">{{{</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">}}}</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span> }
    ]
    <span class="Type">Codnar</span>::<span class="Type">Merger</span>.chunks(<span class="Identifier">@errors</span>, <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, lines)
    <span class="Identifier">@errors</span>.should == [ <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Begin line for chunk with no name in file: path at line: 1</span><span class="Special">&quot;</span> ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_missing_end_chunk_line</span>
    lines = [ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">{{{ top chunk</span><span class="Special">&quot;</span>,
                <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,     <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">top chunk</span><span class="Special">&quot;</span> } ]
    <span class="Type">Codnar</span>::<span class="Type">Merger</span>.chunks(<span class="Identifier">@errors</span>, <span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, lines)
    <span class="Identifier">@errors</span>.should == [ <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Missing end line for chunk: top chunk in file: path at line: 1</span><span class="Special">&quot;</span> ]
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-merger-rb">
<span>lib/codnar/merger.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge classified lines into chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Merger</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert classified lines from a disk file into chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">chunks</span>(errors, path, lines)
      <span class="Statement">return</span> <span class="Type">Merger</span>.new(errors, path, lines).chunks
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return merged chunks containing the classified lines. Each chunk lines are
only indented relative to the chunk. This allows nested chunks to be
presented unindented in the final weaved HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">chunks</span>
      <span class="Identifier">@chunks</span> = [ file_chunk ]
      <span class="Identifier">@stack</span> = <span class="Identifier">@chunks</span>.dup
      <span class="Identifier">@errors</span>.in_path(<span class="Identifier">@path</span>) { merge_lines }
      <span class="Identifier">@chunks</span>.each { |<span class="Identifier">chunk</span>| <span class="Type">Merger</span>.unindent_lines(chunk.lines) }
      <span class="Statement">return</span> <span class="Identifier">@chunks</span>
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert classified lines from a disk file into chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(errors, path, lines)
      <span class="Identifier">@errors</span> = errors
      <span class="Identifier">@path</span> = path
      <span class="Identifier">@lines</span> = lines
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
The top-level all-the-disk-file chunk (without any classified lines)
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">file_chunk</span>
      <span class="Statement">return</span> {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Identifier">@path</span>,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Identifier">@path</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">lines</span><span class="Special">&quot;</span> =&gt; []
      }
    <span class="PreProc">end</span>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#merging-nested-chunk-lines'>Merging nested chunk lines</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#unindenting-chunk-lines'>Unindenting chunk lines</a>
</pre>
<pre class='ruby code syntax'>

  end

end
</pre>
</div>
</div>
</p>
<h4>Merging nested chunk lines</h4>
<p>
To merge the nested chunk lines, we maintain a stack of the current chunks.
Each <code>begin_chunk</code> line pushes another chunk on the stack, and each <code>end_chunk</code>
line pops it. If any chunks are not properly terminated, they will remain in
the stack when all the lines are processed.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="merging-nested-chunk-lines">
<span>Merging nested chunk lines</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge all the classified lines into chunks
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">merge_lines</span>
  <span class="Identifier">@lines</span>.each <span class="Statement">do</span> |<span class="Identifier">line</span>|
    <span class="Identifier">@errors</span>.at_line(line.number)
    merge_line(line)
  <span class="Statement">end</span>
  end_unterminated_chunks
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
End all chunks missing a terminating end chunk classified line.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">end_unterminated_chunks</span>
  <span class="Identifier">@stack</span>.shift
  <span class="Identifier">@stack</span>.each <span class="Statement">do</span> |<span class="Identifier">chunk</span>|
    <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">Missing end line for chunk: </span><span class="Special">#{</span>chunk.name<span class="Special">}</span><span class="Special">&quot;</span>
  <span class="Statement">end</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge the next classified line.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">merge_line</span>(line)
  <span class="Statement">case</span> line.kind
  <span class="Statement">when</span> <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span>
    begin_chunk_line(line)
  <span class="Statement">when</span> <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span>
    end_chunk_line(line)
  <span class="Statement">else</span>
    <span class="Identifier">@stack</span>.last.lines &lt;&lt; line
  <span class="Statement">end</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge a classified line that starts a new chunk.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">begin_chunk_line</span>(line)
  chunk = contained_chunk(container = <span class="Identifier">@stack</span>.last, line)
  container.contained &lt;&lt; chunk.name
  container.lines &lt;&lt; line.merge(<span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">nested_chunk</span><span class="Special">&quot;</span>)
  <span class="Identifier">@chunks</span> &lt;&lt; chunk
  <span class="Identifier">@stack</span> &lt;&lt; chunk
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
A chunk contained in another chunk.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">contained_chunk</span>(container, line)
  <span class="Statement">return</span> {
    <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; new_chunk_name(line.payload),
    <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Identifier">@path</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; line.number } ],
    <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ container.name ],
    <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
    <span class="Special">&quot;</span><span class="Constant">lines</span><span class="Special">&quot;</span> =&gt; [ line ]
  }
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return the name of a new chunk.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">new_chunk_name</span>(name)
  <span class="Statement">return</span> name <span class="Statement">unless</span> name.nil? || name == <span class="Special">&quot;&quot;</span>
  <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">Begin line for chunk with no name</span><span class="Special">&quot;</span>
  <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">@path</span><span class="Special">}</span><span class="Constant">/</span><span class="Special">#{</span><span class="Identifier">@chunks</span>.size<span class="Special">}</span><span class="Special">&quot;</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge a classified line that ends an existing chunk.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">end_chunk_line</span>(line)
  <span class="Statement">return</span> missing_begin_chunk_line(line) <span class="Statement">if</span> <span class="Identifier">@stack</span>.size == <span class="Constant">1</span>
  chunk = <span class="Identifier">@stack</span>.last
  <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">End line for chunk: </span><span class="Special">#{</span>line.payload<span class="Special">}</span><span class="Constant"> mismatches begin line for chunk: </span><span class="Special">#{</span>chunk.name<span class="Special">}</span><span class="Special">&quot;</span> \
    <span class="Statement">unless</span> <span class="Type">Merger</span>.matching_end_chunk_line?(chunk, line)
  chunk.lines &lt;&lt; line
  <span class="Identifier">@stack</span>.pop
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Check whether an end chunk classified line matches the begin chunk
classified line.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">matching_end_chunk_line?</span>(chunk, line)
  line_name = line.payload
  <span class="Statement">return</span> line_name.to_s == <span class="Special">&quot;&quot;</span> || line_name.to_id == chunk.name.to_id
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-merger-rb">lib/codnar/merger.rb</a>
</li>
</ul>
</div>
</div>
</p>
<h4>Unindenting merged chunk lines</h4>
<p>
Nested chunks are typically indented relative to their container chunks.
However, in the generated documentation, these chunks are displayed on their
own, and preserving this relative indentation would reduce their readability.
We therefore unindent all chunks as much as possible as the final step.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="unindenting-chunk-lines">
<span>Unindenting chunk lines</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Remove the common indentation from a sequence of classified lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">unindent_lines</span>(lines)
  indentation = <span class="Type">Merger</span>.minimal_indentation(lines)
  lines.each <span class="Statement">do</span> |<span class="Identifier">line</span>|
    line.indentation = line.indentation.andand.unindent(indentation)
  <span class="Statement">end</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Find out the minimal indentation of all the classified lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">minimal_indentation</span>(lines)
  <span class="Statement">return</span> lines.map { |<span class="Identifier">line</span>| line.indentation }.compact.min
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-merger-rb">lib/codnar/merger.rb</a>
</li>
</ul>
</div>
</div>
</p>
<h3>Generating chunk HTML</h3>
<p>
Now that we have each chunk's lines, we need to convert them to HTML.
</p>
<h4>Grouping lines of the same kind</h4>
<p>
Instead of formatting each line on its own, we batch the operations to work on
all lines of the same kind at once. Here is a simple test that demonstrates
using the grouper:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-group-lines-rb">
<span>test/group_lines.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test grouping classified lines by their kind.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestGroupLines</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_group_empty_lines</span>
    <span class="Type">Codnar</span>::<span class="Type">Grouper</span>.lines_to_groups([]).should == []
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_group_one_line</span>
    <span class="Type">Codnar</span>::<span class="Type">Grouper</span>.lines_to_groups([ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span> } ]).should == [ [ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span> } ] ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_group_lines</span>
    <span class="Type">Codnar</span>::<span class="Type">Grouper</span>.lines_to_groups([
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">0</span><span class="Special">&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">1</span><span class="Special">&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">2</span><span class="Special">&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">3</span><span class="Special">&quot;</span> },
    ]).should == [ [
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">0</span><span class="Special">&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">1</span><span class="Special">&quot;</span> },
    ], [
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">2</span><span class="Special">&quot;</span> },
    ], [
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">3</span><span class="Special">&quot;</span> },
    ] ]
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-grouper-rb">
<span>lib/codnar/grouper.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Group classified lines according to kind.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">module</span> <span class="Type">Grouper</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert array of classified lines to array of classified line groups with
the same line kind.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">lines_to_groups</span>(lines)
      groups = lines.reduce([], &amp;method(<span class="Constant">:group_next_line</span>))
      <span class="Statement">return</span> groups
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Add the next classified line to the classified line groups.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">group_next_line</span>(groups, next_line)
      last_group = groups.last
      <span class="Statement">if</span> last_group.andand.last.andand.kind == next_line.kind
        last_group.push(next_line)
      <span class="Statement">else</span>
        groups.push([ next_line ])
      <span class="Statement">end</span>
      <span class="Statement">return</span> groups
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h4>Formatting lines as HTML</h4>
<p>
Formatting is based on a configuration that specifies, for (a group of) lines
of each kind, how to convert it to HTML. Here is a simple test that
demonstrates using the formatter:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-format-lines-rb">
<span>test/format_lines.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test converting classified lines to HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestFormatLines</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>

  alias_method <span class="Constant">:original_setup</span>, <span class="Constant">:setup</span>

  <span class="PreProc">def</span> <span class="Identifier">setup</span>
    original_setup
    <span class="Type">Codnar</span>::<span class="Type">Formatter</span>.send(<span class="Constant">:public</span>, *<span class="Type">Codnar</span>::<span class="Type">Formatter</span>.protected_instance_methods)
    <span class="Identifier">@formatter</span> = <span class="Type">Codnar</span>::<span class="Type">Formatter</span>.new(<span class="Identifier">@errors</span>,
                               <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.lines_to_pre_html(lines)</span><span class="Special">&quot;</span>,
                               <span class="Special">&quot;</span><span class="Constant">fail</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">TestFormatLines.fail</span><span class="Special">&quot;</span>)
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_process_html_lines</span>
    lines_group = <span class="Identifier">@formatter</span>.process_lines_group([
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span>, },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">3</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">baz</span><span class="Special">&quot;</span>, },
    ])
    <span class="Identifier">@errors</span>.should == []
    lines_group.should == [ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Constant">baz</span><span class="Special">&quot;</span> } ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_process_unknown_lines</span>
    lines_group = <span class="Identifier">@formatter</span>.process_lines_group([
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">unknown-kind</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;foo&gt;</span><span class="Special">&quot;</span>, },
    ])
    <span class="Identifier">@errors</span>.should == [ <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: No formatter specified for lines of kind: unknown-kind</span><span class="Special">&quot;</span> ]
    lines_group.should == [ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>,
                              <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;pre class='missing formatter error'&gt;</span><span class="Special">\n</span><span class="Constant">&amp;lt;foo&amp;gt;</span><span class="Special">\n</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span> } ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_process_code_lines</span>
    lines_group = <span class="Identifier">@formatter</span>.process_lines_group([
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;foo&gt;</span><span class="Special">&quot;</span>, },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span>, },
    ])
    <span class="Identifier">@errors</span>.should == []
    lines_group.should == [ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>,
                              <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;pre&gt;</span><span class="Special">\n</span><span class="Constant">&amp;lt;foo&amp;gt;</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span> } ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_failed_formatter</span>
    lines_group = <span class="Identifier">@formatter</span>.process_lines_group([ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">fail</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, } ])
    <span class="Identifier">@errors</span>.size.should == <span class="Constant">1</span>
    <span class="Identifier">@errors</span>.last.should =~ \
      <span class="Special">/</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Formatter: TestFormatLines</span><span class="Special">.</span><span class="Constant">fail for lines of kind: fail failed with exception:</span><span class="Special">.</span><span class="Special">*</span><span class="Constant">in `fail': Reason</span><span class="Special">/</span>
    lines_group.should == [ { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>,
                              <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;pre class='failed formatter error'&gt;</span><span class="Special">\n</span><span class="Constant">foo</span><span class="Special">\n</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span> } ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_lines_to_html</span>
    lines_group = <span class="Identifier">@formatter</span>.lines_to_html([
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;bar&gt;</span><span class="Special">&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">3</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">baz</span><span class="Special">&quot;</span> },
    ])
    <span class="Identifier">@errors</span>.should == []
    lines_group.should == <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">\n</span><span class="Constant">&lt;pre&gt;</span><span class="Special">\n</span><span class="Constant">&amp;lt;bar&amp;gt;</span><span class="Special">\n</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">\n</span><span class="Constant">baz</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">fail</span>
    <span class="Statement">raise</span> <span class="Special">&quot;</span><span class="Constant">Reason</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-formatter-rb">
<span>lib/codnar/formatter.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format chunks into HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Formatter</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Construct a Formatter based on a mapping from a classified line kind, to a
Ruby expression, that converts an array of classified lines of that kind,
into an array of lines of another kind. This expression is simply
<code>eval</code>-ed, and is expected to make use of a variable called
<code>lines</code> that contains an array of classified lines, as produced
by a Scanner. The result of evaluating the expressions is expected to be an
array of any number of classified lines of any kind.
</p>
<p>
Formatting repeatedly applies these formatting expressions, until the
result is an array containing a single classified line, which has the kind
<code>html</code> and whose payload field contains the unified final HTML
presentation of the original classified lines. In each processing round,
all consecutive lines of the same kind are formated together. This allows
for properly formating line kinds that use a multi-line notation such as
Markdown.
</p>
<p>
The default formatting expression for the kind <code>html</code> simply
joins all the payloads of all the classified lines into a single html, and
returns a single “line” containing this joined HTML. All other line
kinds need to have a formatting expression explicitly specified in the
formatters mapping.
</p>
<p>
If no formatting expression is specified for some classified line kind, an
error is reported and the classified lines are wrapped in a pre HTML
element with a <code>missing_formatter</code> CSS class. Similarly, if a
formatting expression fails (raises an exception), an error is reported and
the lines are wrapped in a pre HTML element with a
<code>failed_formatter</code> CSS class.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(errors, formatters)
      <span class="Identifier">@errors</span> = errors
      <span class="Identifier">@formatters</span> = { <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.merge_html_lines(lines)</span><span class="Special">&quot;</span> }.merge(formatters)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Repeatedly process an array of classified lines of arbitrary kinds until we
obtain a single classified “line” containing a unified final HTML
presentation of the original classified lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">lines_to_html</span>(lines)
      <span class="Statement">until</span> <span class="Type">Formatter</span>.single_html_line?(lines)
        lines = <span class="Type">Grouper</span>.lines_to_groups(lines).map { |<span class="Identifier">group</span>| process_lines_group(group) }.flatten
      <span class="Statement">end</span>
      <span class="Statement">return</span> lines.last.andand.payload.to_s
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Check whether we have finally got a single HTML classified “line” for
the whole classified lines sequence.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">single_html_line?</span>(lines)
      <span class="Statement">return</span> lines.size &lt;= <span class="Constant">1</span> &amp;&amp; lines[<span class="Constant">0</span>].andand.kind == <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Perform one pass of processing toward HTML on a group of consecutive
classified lines with the same kind.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">process_lines_group</span>(lines)
      kind = lines.last.kind
      formatter = <span class="Identifier">@formatters</span>[kind] ||= missing_formatter(kind)
      <span class="Statement">begin</span>
        <span class="Statement">return</span> <span class="Statement">eval</span> formatter
      <span class="Statement">rescue</span>
        <span class="Statement">return</span> failed_formatter(lines, formatter, <span class="Identifier">$!</span>)
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return an expression for formatting classified lines of some kind that
doesn’t have such a formatting expression already specified.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">missing_formatter</span>(kind)
      <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">No formatter specified for lines of kind: </span><span class="Special">#{</span>kind<span class="Special">}</span><span class="Special">&quot;</span>
      <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant">Formatter.lines_to_pre_html(lines, :class =&gt; 'missing formatter error')</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format classified lines as HTML if the original specified formatting
expression failed.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">failed_formatter</span>(lines, formatter, exception)
      <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">Formatter: </span><span class="Special">#{</span>formatter<span class="Special">}</span><span class="Constant"> for lines of kind: </span><span class="Special">#{</span>lines.last.kind<span class="Special">}</span><span class="Constant"> failed with exception: </span><span class="Special">#{</span>exception<span class="Special">}</span><span class="Special">&quot;</span>
      <span class="Statement">return</span> <span class="Type">Formatter</span>.lines_to_pre_html(lines, <span class="Constant">:class</span> =&gt; <span class="Special">&quot;</span><span class="Constant">failed formatter error</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#basic-formatters'>Basic formatters</a>
</pre>
<pre class='ruby code syntax'>

  end

end
</pre>
</div>
</div>
</p>
<h4>Basic formatters</h4>
<p>
The implementation contains some basic formatting functions. These are
sufficient for generic source code processing.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="basic-formatters">
<span>Basic formatters</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge a group of consecutive indented lines into a group with a single
classified “line”. The given block is passed the joined content of all
the lines, and may process it to yield the merged “line” content. If an
explicit indentation is given, it overrides each line’s indentation. This
is useful for avoiding the inclusion of the indentation in the payload.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">merge_lines</span>(lines, kind, indentation = <span class="Constant">nil</span>)
  payload = <span class="Statement">yield</span> lines.map { |<span class="Identifier">line</span>| (indentation || line.indentation || <span class="Special">&quot;&quot;</span>) + (line.payload || <span class="Special">&quot;&quot;</span>) }.join(<span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span>)
  merged_line = lines[<span class="Constant">0</span>]
  merged_line.merge!(<span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; kind, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; payload)
  merged_line.delete(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span>) <span class="Statement">if</span> indentation.nil?
  <span class="Statement">return</span> [ merged_line ]
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge a group of consecutive HTML classified lines into a group with a
single HTML classified “line”. This is the default formatting
expression for HTML lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">merge_html_lines</span>(lines)
  <span class="Statement">return</span> <span class="Type">Formatter</span>.merge_lines(lines, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>) { |<span class="Identifier">payload</span>| payload }
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format classified lines into HTML using a pre element with optional
attributes. This is the default formatting expression for classified lines
of unknown kinds.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">lines_to_pre_html</span>(lines, attributes = {})
  <span class="Statement">return</span> <span class="Type">Formatter</span>.merge_lines(lines, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">payload</span>|
    ( <span class="Special">&quot;</span><span class="Constant">&lt;pre</span><span class="Special">&quot;</span> + <span class="Type">Formatter</span>.html_attributes(attributes) + <span class="Special">&quot;</span><span class="Constant">&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
    + <span class="Type">CGI</span>.escapeHTML(payload) + <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
    + <span class="Special">&quot;</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span> )
  <span class="Statement">end</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert an attribute mapping to HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">html_attributes</span>(attributes)
  <span class="Statement">return</span> <span class="Special">&quot;&quot;</span> <span class="Statement">if</span> attributes == {}
  <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span> + attributes.map { |<span class="Identifier">name</span>, <span class="Identifier">value</span>| <span class="Special">&quot;</span><span class="Special">#{</span>name<span class="Special">}</span><span class="Constant">='</span><span class="Special">#{</span><span class="Type">CGI</span>.escapeHTML(value.to_s)<span class="Special">}</span><span class="Constant">'</span><span class="Special">&quot;</span> }.join(<span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>)
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format classified lines that indicate a nested chunk to HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">nested_chunk_lines_to_html</span>(lines)
  <span class="Statement">return</span> lines.each <span class="Statement">do</span> |<span class="Identifier">line</span>|
    line.kind = <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>
    chunk_name = line.payload
    line.payload = <span class="Special">&quot;</span><span class="Constant">&lt;pre class='nested chunk'&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
                 + (line.indentation || <span class="Special">&quot;&quot;</span>) \
                 + <span class="Special">&quot;</span><span class="Constant">&lt;a class='nested chunk' href='#</span><span class="Special">#{</span>chunk_name.to_id<span class="Special">}</span><span class="Constant">'&gt;</span><span class="Special">#{</span><span class="Type">CGI</span>.escapeHTML(chunk_name)<span class="Special">}</span><span class="Constant">&lt;/a&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
                 + <span class="Special">&quot;</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span>
    line.delete(<span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span>)
  <span class="Statement">end</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Indent arbitrary HTML lines to line up with the rest of the lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">unindented_lines_to_html</span>(lines)
  merged_line = lines[<span class="Constant">0</span>]
  html = lines.map { |<span class="Identifier">line</span>| line.payload + <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span> }.join
  merged_line.payload = <span class="Constant">self</span>.indent_html(merged_line.indentation, html)
  merged_line.kind = <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>
  <span class="Statement">return</span> [ merged_line ]
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Indent a chunk of HTML by some spaces. This uses a table, which is arguably
the wrong way to do it.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">indent_html</span>(indentation, html)
  <span class="Statement">return</span> html.chomp <span class="Statement">if</span> indentation.nil?
  <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant">&lt;table class='layout'&gt;</span><span class="Special">\n</span><span class="Constant">&lt;tr&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
       + <span class="Special">&quot;</span><span class="Constant">&lt;td class='indentation'&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
       + <span class="Special">&quot;</span><span class="Constant">&lt;pre&gt;</span><span class="Special">#{</span>indentation<span class="Special">}</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
       + <span class="Special">&quot;</span><span class="Constant">&lt;/td&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
       + <span class="Special">&quot;</span><span class="Constant">&lt;td class='html'&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
       + html \
       + <span class="Special">&quot;</span><span class="Constant">&lt;/td&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
       + <span class="Special">&quot;</span><span class="Constant">&lt;/tr&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/table&gt;</span><span class="Special">&quot;</span>
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Cast a sequence of classified lines into a different kind without any
processing.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">cast_lines</span>(lines, kind)
  lines = lines.dup
  lines.each { |<span class="Identifier">line</span>| line.kind = kind }
  <span class="Statement">return</span> lines
<span class="PreProc">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert a sequence of marked-up classified lines to (unindented) HTML
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">markup_lines_to_html</span>(lines, klass, css_class = <span class="Constant">nil</span>)
  implementation = <span class="Type">String</span> === klass ? <span class="Type">Kernel</span>.const_get(klass) : klass
  css_class ||= implementation.to_s.downcase.gsub(<span class="Special">&quot;</span><span class="Constant">::</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">-</span><span class="Special">&quot;</span>)
  <span class="Statement">return</span> <span class="Type">Formatter</span>.merge_lines(lines, <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span>, <span class="Special">&quot;&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">payload</span>|
    ( <span class="Special">&quot;</span><span class="Constant">&lt;div class='</span><span class="Special">#{</span>css_class<span class="Special">}</span><span class="Constant"> </span><span class="Special">#{</span>lines[<span class="Constant">0</span>].kind<span class="Special">}</span><span class="Constant"> markup'&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> \
    + implementation.to_html(payload) \
    + <span class="Special">&quot;</span><span class="Constant">&lt;/div&gt;</span><span class="Special">&quot;</span> )
  <span class="Statement">end</span>
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-formatter-rb">lib/codnar/formatter.rb</a>
</li>
</ul>
</div>
</div>
</p>
<h4>Markup formats</h4>
<p>
The <code>markup_lines_to_html</code> formatter above relies on the existence of a class
for converting comments from the specific markup format to HTML. Currently, two
such formats are supported:
</p>
<ul>
<li>
<p>
RDoc, the default markup format used in Ruby comments. Here is a simple test
that demonstrates using RDoc:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-expand-rdoc-rb">
<span>test/expand_rdoc.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test expanding RDoc text.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestExpandRDoc</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_emphasis_text</span>
    <span class="Type">Codnar</span>::<span class="Type">RDoc</span>.to_html(<span class="Special">&quot;</span><span class="Constant">_text_</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;em&gt;text&lt;/em&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_strong_text</span>
    <span class="Type">Codnar</span>::<span class="Type">RDoc</span>.to_html(<span class="Special">&quot;</span><span class="Constant">*text*</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;strong&gt;text&lt;/strong&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_indented_pre</span>
    <span class="Type">Codnar</span>::<span class="Type">RDoc</span>.to_html(<span class="Special">&quot;</span><span class="Constant">base</span><span class="Special">\n</span><span class="Constant">  indented</span><span class="Special">\n</span><span class="Constant">    more</span><span class="Special">\n</span><span class="Constant">back</span><span class="Special">\n</span><span class="Special">&quot;</span>).should \
                      == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">base</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;pre&gt;indented</span><span class="Special">\n</span><span class="Constant">  more&lt;/pre&gt;</span><span class="Special">\n</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">back</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-rdoc-rb">
<span>lib/codnar/rdoc.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert RDoc to HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">module</span> <span class="Type">RDoc</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Process a RDoc String and return the resulting HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">to_html</span>(rdoc)
      <span class="Statement">return</span> ::<span class="Type">RDoc</span>::<span class="Type">Markup</span>::<span class="Type">ToHtml</span>.new.convert(rdoc).clean_markup_html
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
</li>
<li>
<p>
Markdown, a generic markup syntax used across many systems and languages.
Here is a simple test that demonstrates using Markdown:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-expand-markdown-rb">
<span>test/expand_markdown.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test expanding Markdown text.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestExpandMarkdown</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_emphasis_text</span>
    <span class="Type">Codnar</span>::<span class="Type">Markdown</span>.to_html(<span class="Special">&quot;</span><span class="Constant">*text*</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;em&gt;text&lt;/em&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_strong_text</span>
    <span class="Type">Codnar</span>::<span class="Type">Markdown</span>.to_html(<span class="Special">&quot;</span><span class="Constant">**text**</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;strong&gt;text&lt;/strong&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_embed_chunk</span>
    <span class="Type">Codnar</span>::<span class="Type">Markdown</span>.to_html(<span class="Special">&quot;</span><span class="Constant">[[Chunk|template]]</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;embed src='chunk' type='x-codnar/template'/&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_embed_anchor</span>
    <span class="Type">Codnar</span>::<span class="Type">Markdown</span>.to_html(<span class="Special">&quot;</span><span class="Constant">[[#Name]]</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;a id='name'/&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_embed_link</span>
    <span class="Type">Codnar</span>::<span class="Type">Markdown</span>.to_html(<span class="Special">&quot;</span><span class="Constant">[Label](#Name)</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;a href=\&quot;#name\&quot;&gt;Label&lt;/a&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-markdown-rb">
<span>lib/codnar/markdown.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert Markdown to HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">module</span> <span class="Type">Markdown</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Process a Markdown String and return the resulting HTML. In addition to the
normal Markdown syntax, processing supports the following Codnar-specific
extensions:
</p>
<ul><li>
<p>
The notation “[[chunk|template]]” is expanded to embedding the
specified chunk (name) using the specified template at Weave time.
</p>
</li><li>
<p>
The notation “[[#name]]” defines an empty anchor. The HTML anchor id is
not the specified name, but rather the identifier generated from it (in the
same way that chunk names are converted to identifiers).
</p>
</li><li>
<p>
The notation “[…](#name)” defines a link to an anchor, which is
either the chunk with the specified name, or an empty anchor defined as
above.
</p>
</li></ul>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">to_html</span>(markdown)
      markdown = embed_chunks(markdown)
      markdown = id_anchors(markdown)
      html = <span class="Type">RDiscount</span>.new(markdown).to_html
      html = id_links(html)
      <span class="Statement">return</span> html.clean_markup_html
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Expand “[[chunk|template]]” to HTML embed tags. Use identifiers instead
of names in the <code>src</code> field for safety, unless the template is a
magical file template, in which case we must preserve the file path.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">embed_chunks</span>(markdown)
      <span class="Statement">return</span> markdown.gsub(<span class="Special">/</span><span class="Special">\[\[</span><span class="Special">(</span><span class="Special">.</span><span class="Special">*?</span><span class="Special">)</span><span class="Special">\|</span><span class="Special">(</span><span class="Special">.</span><span class="Special">*?</span><span class="Special">)</span><span class="Special">\]\]</span><span class="Special">/</span>) <span class="Statement">do</span>
        src = <span class="Identifier">$1</span>
        template = <span class="Identifier">$2</span>
        src = src.to_id <span class="Statement">unless</span> <span class="Type">Codnar</span>::<span class="Type">Weaver</span>::<span class="Type">FILE_TEMPLATE_PROCESSORS</span>.include?(template)
        <span class="Special">&quot;</span><span class="Constant">&lt;embed src='</span><span class="Special">#{</span>src<span class="Special">}</span><span class="Constant">' type='x-codnar/</span><span class="Special">#{</span>template<span class="Special">}</span><span class="Constant">'/&gt;</span><span class="Special">&quot;</span>
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Expand “[[#name]]” anchors to HTML anchor tags with the matching
identifier.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">id_anchors</span>(markdown)
      <span class="Statement">return</span> markdown.gsub(<span class="Special">/</span><span class="Special">\[\[</span><span class="Constant">#</span><span class="Special">(</span><span class="Special">.</span><span class="Special">*?</span><span class="Special">)</span><span class="Special">\]\]</span><span class="Special">/</span>) { <span class="Special">&quot;</span><span class="Constant">&lt;a id='</span><span class="Special">#{</span><span class="Identifier">$1</span>.to_id<span class="Special">}</span><span class="Constant">'/&gt;</span><span class="Special">&quot;</span> }
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Expand “href=‘#name’” links to the matching “href=‘#id’”
links.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">id_links</span>(html)
      <span class="Statement">return</span> html.gsub(<span class="Special">/</span><span class="Constant">href=</span><span class="Special">(</span><span class="Special">[</span><span class="Constant">&quot;'</span><span class="Special">]</span><span class="Special">)</span><span class="Constant">#</span><span class="Special">(</span><span class="Special">.</span><span class="Special">*?</span><span class="Special">)(</span><span class="Special">[</span><span class="Constant">&quot;'</span><span class="Special">]</span><span class="Special">)</span><span class="Special">/</span>) { <span class="Special">&quot;</span><span class="Constant">href=</span><span class="Special">#{</span><span class="Identifier">$1</span><span class="Special">}</span><span class="Constant">#</span><span class="Special">#{</span><span class="Identifier">$2</span>.to_id<span class="Special">}#{</span><span class="Identifier">$3</span><span class="Special">}</span><span class="Special">&quot;</span> }
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
</li>
<li>
<p>
Haddock, a specific markup syntax used in comments to document Haskell code.
Here is a simple test that demonstrates using Haddock:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-expand-haddock-rb">
<span>test/expand_haddock.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test expanding Haddock text.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestExpandHaddock</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_normal_text</span>
    <span class="Type">Codnar</span>::<span class="Type">Haddock</span>.to_html(<span class="Special">&quot;</span><span class="Constant">normal</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;normal</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_identifier_text</span>
    <span class="Type">Codnar</span>::<span class="Type">Haddock</span>.to_html(<span class="Special">&quot;</span><span class="Constant">'Int'</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;&lt;code&gt;Int&lt;/code&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_emphasis_text</span>
    <span class="Type">Codnar</span>::<span class="Type">Haddock</span>.to_html(<span class="Special">&quot;</span><span class="Constant">/emphasis/</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;p&gt;&lt;em&gt;emphasis&lt;/em&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_code_text</span>
    <span class="Type">Codnar</span>::<span class="Type">Haddock</span>.to_html(<span class="Special">&quot;</span><span class="Constant">@code@</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">&lt;pre&gt;code&lt;/pre&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-haddock-rb">
<span>lib/codnar/haddock.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert Haddoc to HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Haddock</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Process a Haddock String and return the resulting HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">to_html</span>(haddock)
      with_temporary_directory <span class="Statement">do</span> |<span class="Identifier">path</span>|
        write_temporary_file(path, haddock)
        run_haddock(path)
        html = read_html_file(path)
        clean_html(html)
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run a block using a temporary directory, that is then removed. TODO: This
should be in some more generic place.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">with_temporary_directory</span>
      path = create_temporary_directory
      result = <span class="Statement">yield</span> path
      <span class="Type">FileUtils</span>.rm_rf(path)
      <span class="Statement">return</span> result
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Create a temporary directory to run Haddock in.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">create_temporary_directory</span>
      file = <span class="Type">Tempfile</span>.open(<span class="Special">&quot;</span><span class="Constant">dir</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">.</span><span class="Special">&quot;</span>)
      path = file.path
      <span class="Type">File</span>.delete(path)
      <span class="Type">Dir</span>.mkdir(path)
      <span class="Statement">return</span> path
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Minimal header to insert before the Haddock String to trick Haddock into
generating HTML from it.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Type">HADDOCK_HEADER</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">      module Wrapper where</span>
<span class="Constant">      -- $doc</span>
<span class="Constant">    </span><span class="Special">EOF</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Write the Haddock String into a wrapper Haskell file so we’ll be able to
run Haddock to generate HTML from it.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">write_temporary_file</span>(path, haddock)
      <span class="Type">File</span>.open(path + <span class="Special">&quot;</span><span class="Constant">/wrapper.hs</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">w</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">file</span>|
        file.write(<span class="Type">HADDOCK_HEADER</span>)
        haddock = <span class="Constant">self</span>.patch_module_comments(haddock)
        file.write(<span class="Special">&quot;</span><span class="Constant">-- </span><span class="Special">&quot;</span> + haddock.gsub(<span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Special">\n</span><span class="Constant">-- </span><span class="Special">&quot;</span>))
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert structured module comments to a definition list. TODO: This is
rather flaky.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">patch_module_comments</span>(haddock)
      haddock.sub!(<span class="Special">/</span><span class="Special">^</span><span class="Special">\s</span><span class="Special">*</span><span class="Constant">Module</span><span class="Special">\s</span><span class="Special">*</span><span class="Constant">:</span><span class="Special">\s</span><span class="Special">*</span><span class="Special">\$</span><span class="Special">\s</span><span class="Special">*</span><span class="Constant">header</span><span class="Special">\s</span><span class="Special">*</span><span class="Special">\$</span><span class="Special">\s</span><span class="Special">*</span><span class="Special">$</span><span class="Special">/i</span>, <span class="Special">&quot;</span><span class="Constant">Module</span><span class="Special">&quot;</span>)
      <span class="Statement">return</span> haddock.gsub(<span class="Special">/</span><span class="Special">^</span><span class="Special">(</span><span class="Special">\s</span><span class="Special">*</span><span class="Special">)(</span><span class="Constant">Module</span><span class="Special">|</span><span class="Constant">Description</span><span class="Special">|</span><span class="Constant">Copyright</span><span class="Special">|</span><span class="Constant">License</span><span class="Special">|</span><span class="Constant">Maintainer</span><span class="Special">|</span><span class="Constant">Stability</span><span class="Special">|</span><span class="Constant">Portability</span><span class="Special">)(</span><span class="Special">\s</span><span class="Special">*</span><span class="Special">)</span><span class="Constant">:</span><span class="Special">/</span>, <span class="Special">&quot;</span><span class="Special">\n\\</span><span class="Constant">1[@</span><span class="Special">\\</span><span class="Constant">2@]</span><span class="Special">\\</span><span class="Constant">3</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run Haddock to convert the wrapper Haskell file into HTML documentation.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">run_haddock</span>(path)
      system(<span class="Special">&quot;</span><span class="Constant">cd </span><span class="Special">#{</span>path<span class="Special">}</span><span class="Constant"> &amp;&amp; haddock --html wrapper.hs &gt; haddock.out 2&gt;&amp;1</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Read the HTML generated by Haddock.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">read_html_file</span>(path)
      <span class="Statement">return</span> <span class="Type">File</span>.read(path + <span class="Special">&quot;</span><span class="Constant">/Wrapper.html</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Extract the clean generated HTML from Haddock’s output.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">clean_html</span>(html)
      html.gsub!(<span class="Special">&quot;</span><span class="Special">\r\n</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span>)
      html.sub!(<span class="Special">/</span><span class="Special">.</span><span class="Special">*</span><span class="Constant">&lt;div class=&quot;doc&quot;&gt;</span><span class="Special">/m</span>, <span class="Special">''</span>)
      html.sub!(<span class="Special">/</span><span class="Constant">&lt;</span><span class="Special">\/</span><span class="Constant">div&gt;&lt;</span><span class="Special">\/</span><span class="Constant">div&gt;&lt;</span><span class="Special">\/</span><span class="Constant">div&gt;&lt;div id=&quot;footer&quot;&gt;</span><span class="Special">.</span><span class="Special">*</span><span class="Special">/m</span>, <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span>)
      <span class="Statement">return</span> html
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
</li>
</ul>
<p>
In all cases, the HTML generated by the markup format conversion is a bit
messy. We therefore clean it up:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="clean-html">
<span>Clean HTML</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Clean HTML generated by markup formatters. Such HTML tends to have extra
empty lines for no apparent reason. Cleaning it up seems to be safe enough,
and eliminates the ugly additional vertical space in the final HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">clean_markup_html</span>
  <span class="Statement">return</span> gsub(<span class="Special">&quot;</span><span class="Special">\r\n</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span>) \
        .gsub(<span class="Special">/</span><span class="Special">\n</span><span class="Special">*</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Special">*</span><span class="Special">/</span>, <span class="Special">&quot;</span><span class="Special">\n</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>) \
        .gsub(<span class="Special">/</span><span class="Special">\n</span><span class="Special">*</span><span class="Constant">&lt;</span><span class="Special">\/</span><span class="Constant">p&gt;</span><span class="Special">\n</span><span class="Special">*</span><span class="Special">/</span>, <span class="Special">&quot;</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>) \
        .gsub(<span class="Special">/</span><span class="Special">\n</span><span class="Special">*</span><span class="Constant">&lt;pre&gt;</span><span class="Special">\n</span><span class="Special">+</span><span class="Special">/</span>, <span class="Special">&quot;</span><span class="Special">\n</span><span class="Constant">&lt;pre&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>) \
        .gsub(<span class="Special">/</span><span class="Special">\n</span><span class="Special">+</span><span class="Constant">&lt;</span><span class="Special">\/</span><span class="Constant">pre&gt;</span><span class="Special">\n</span><span class="Special">*</span><span class="Special">/</span>, <span class="Special">&quot;</span><span class="Special">\n</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>) \
        .sub(<span class="Special">/</span><span class="Special">^</span><span class="Special">\n</span><span class="Special">*</span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>)
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-string-extensions-rb">lib/codnar/string_extensions.rb</a>
</li>
</ul>
</div>
</div>
</p>
<h4>Generating diagrams using GraphViz</h4>
<p>
If you have <code>graphviz</code> installed, it is possible to use it to generate SVG
diagrams that can be embedded directly into the HTML. This is implemented as an
additional formatter; in principle, you this allows embeding the GraphViz
directives directly in the code, but in practice people prefer keeping the
diagrams as separate files.
</p>
<p>
We pre-process the GraphViz directives using the <code>m4</code> macro processor. This
allows dramatically reducing the amount of repeated boilerplate in the diagram
definitions, by defining macros for node and edge styles and, if desired, more
advanced techniques.
</p>
<p>
Here is a simple test that demonstrates generating SVG from a GraphViz diagram:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-graphviz-diagrams-rb">
<span>test/graphviz_diagrams.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test highlighting syntax using GVim.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestGraphVizDiagrams</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="Type">MINIMAL_DIAGRAM_SVG</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( svg</span>
</pre>
<pre class='svg code syntax'>
    <span class="Identifier">&lt;</span><span class="Identifier">svg</span><span class="Identifier"> </span><span class="Type">width</span>=<span class="Constant">&quot;62pt&quot;</span><span class="Identifier"> </span><span class="Type">height</span>=<span class="Constant">&quot;116pt&quot;</span>
<span class="Identifier">     </span><span class="Type">viewBox</span>=<span class="Constant">&quot;0.00 0.00 62.00 116.00&quot;</span><span class="Identifier"> </span><span class="Type">xmlns</span>=<span class="Constant">&quot;<a href="http://www.w3.org/2000/svg">http://www.w3.org/2000/svg</a>&quot;</span><span class="Identifier"> </span><span class="Type">xmlns</span><span class="Comment">:</span><span class="Type">xlink</span>=<span class="Constant">&quot;<a href="http://www.w3.org/1999/xlink">http://www.w3.org/1999/xlink</a>&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">g</span><span class="Identifier"> </span><span class="Type">id</span>=<span class="Constant">&quot;graph1&quot;</span><span class="Identifier"> </span><span class="Type">class</span>=<span class="Constant">&quot;graph&quot;</span><span class="Identifier"> </span><span class="Type">transform</span>=<span class="Constant">&quot;scale(1 1) rotate(0) translate(4 112)&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">title</span><span class="Identifier">&gt;</span>_anonymous_0<span class="Identifier">&lt;/title&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">polygon</span><span class="Identifier"> </span><span class="Type">fill</span>=<span class="Constant">&quot;white&quot;</span><span class="Identifier"> </span><span class="Type">stroke</span>=<span class="Constant">&quot;white&quot;</span><span class="Identifier"> </span><span class="Type">points</span>=<span class="Constant">&quot;-4,5 -4,-112 59,-112 59,5 -4,5&quot;</span><span class="Identifier">/&gt;</span>
    <span class="Comment">&lt;!</span><span class="Comment">-- A --</span><span class="Comment">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">g</span><span class="Identifier"> </span><span class="Type">id</span>=<span class="Constant">&quot;node1&quot;</span><span class="Identifier"> </span><span class="Type">class</span>=<span class="Constant">&quot;node&quot;</span><span class="Identifier">&gt;&lt;</span><span class="Identifier">title</span><span class="Identifier">&gt;</span>A<span class="Identifier">&lt;/title&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">ellipse</span><span class="Identifier"> </span><span class="Type">fill</span>=<span class="Constant">&quot;none&quot;</span><span class="Identifier"> </span><span class="Type">stroke</span>=<span class="Constant">&quot;black&quot;</span><span class="Identifier"> </span><span class="Type">cx</span>=<span class="Constant">&quot;27&quot;</span><span class="Identifier"> </span><span class="Type">cy</span>=<span class="Constant">&quot;-90&quot;</span><span class="Identifier"> </span><span class="Type">rx</span>=<span class="Constant">&quot;27&quot;</span><span class="Identifier"> </span><span class="Type">ry</span>=<span class="Constant">&quot;18&quot;</span><span class="Identifier">/&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">text</span><span class="Identifier"> </span><span class="Type">text-anchor</span>=<span class="Constant">&quot;middle&quot;</span><span class="Identifier"> </span><span class="Type">x</span>=<span class="Constant">&quot;27&quot;</span><span class="Identifier"> </span><span class="Type">y</span>=<span class="Constant">&quot;-85.4&quot;</span><span class="Identifier"> </span><span class="Type">font-family</span>=<span class="Constant">&quot;Times New Roman,serif&quot;</span><span class="Identifier"> </span><span class="Type">font-size</span>=<span class="Constant">&quot;14.00&quot;</span><span class="Identifier">&gt;</span>A<span class="Identifier">&lt;/text&gt;</span>
    <span class="Identifier">&lt;/g&gt;</span>
    <span class="Comment">&lt;!</span><span class="Comment">-- B --</span><span class="Comment">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">g</span><span class="Identifier"> </span><span class="Type">id</span>=<span class="Constant">&quot;node3&quot;</span><span class="Identifier"> </span><span class="Type">class</span>=<span class="Constant">&quot;node&quot;</span><span class="Identifier">&gt;&lt;</span><span class="Identifier">title</span><span class="Identifier">&gt;</span>B<span class="Identifier">&lt;/title&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">ellipse</span><span class="Identifier"> </span><span class="Type">fill</span>=<span class="Constant">&quot;none&quot;</span><span class="Identifier"> </span><span class="Type">stroke</span>=<span class="Constant">&quot;black&quot;</span><span class="Identifier"> </span><span class="Type">cx</span>=<span class="Constant">&quot;27&quot;</span><span class="Identifier"> </span><span class="Type">cy</span>=<span class="Constant">&quot;-18&quot;</span><span class="Identifier"> </span><span class="Type">rx</span>=<span class="Constant">&quot;27&quot;</span><span class="Identifier"> </span><span class="Type">ry</span>=<span class="Constant">&quot;18&quot;</span><span class="Identifier">/&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">text</span><span class="Identifier"> </span><span class="Type">text-anchor</span>=<span class="Constant">&quot;middle&quot;</span><span class="Identifier"> </span><span class="Type">x</span>=<span class="Constant">&quot;27&quot;</span><span class="Identifier"> </span><span class="Type">y</span>=<span class="Constant">&quot;-13.4&quot;</span><span class="Identifier"> </span><span class="Type">font-family</span>=<span class="Constant">&quot;Times New Roman,serif&quot;</span><span class="Identifier"> </span><span class="Type">font-size</span>=<span class="Constant">&quot;14.00&quot;</span><span class="Identifier">&gt;</span>B<span class="Identifier">&lt;/text&gt;</span>
    <span class="Identifier">&lt;/g&gt;</span>
    <span class="Comment">&lt;!</span><span class="Comment">-- A&amp;#45;&amp;gt;B --</span><span class="Comment">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">g</span><span class="Identifier"> </span><span class="Type">id</span>=<span class="Constant">&quot;edge2&quot;</span><span class="Identifier"> </span><span class="Type">class</span>=<span class="Constant">&quot;edge&quot;</span><span class="Identifier">&gt;&lt;</span><span class="Identifier">title</span><span class="Identifier">&gt;</span>A<span class="Type">&amp;</span><span class="Statement">#45</span><span class="Type">;&amp;</span><span class="Statement">gt</span><span class="Type">;</span>B<span class="Identifier">&lt;/title&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">path</span><span class="Identifier"> </span><span class="Type">fill</span>=<span class="Constant">&quot;none&quot;</span><span class="Identifier"> </span><span class="Type">stroke</span>=<span class="Constant">&quot;black&quot;</span><span class="Identifier"> </span><span class="Type">d</span>=<span class="Constant">&quot;M27,-71.8314C27,-64.131 27,-54.9743 27,-46.4166&quot;</span><span class="Identifier">/&gt;</span>
    <span class="Identifier">&lt;</span><span class="Identifier">polygon</span><span class="Identifier"> </span><span class="Type">fill</span>=<span class="Constant">&quot;black&quot;</span><span class="Identifier"> </span><span class="Type">stroke</span>=<span class="Constant">&quot;black&quot;</span><span class="Identifier"> </span><span class="Type">points</span>=<span class="Constant">&quot;30.5001,-46.4132 27,-36.4133 23.5001,-46.4133 30.5001,-46.4132&quot;</span><span class="Identifier">/&gt;</span>
    <span class="Identifier">&lt;/g&gt;</span>
    <span class="Identifier">&lt;/g&gt;</span>
    <span class="Identifier">&lt;/svg&gt;</span>
  EOF
</pre>
<pre class='ruby code syntax'>
  <span class="Comment">#! ))) svg</span>

  <span class="PreProc">def</span> <span class="Identifier">test_valid_diagram</span>
    diagram = &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( dot</span>
</pre>
<pre class='dot code syntax'>
      <span class="Identifier">define</span><span class="Statement">(</span>`<span class="Identifier">X</span>', `<span class="Identifier">A</span>'<span class="Statement">)</span>
      <span class="Statement">digraph</span> <span class="Statement">{</span>
        <span class="Identifier">X</span> <span class="Statement">-&gt;</span> <span class="Identifier">B</span><span class="Statement">;</span>
      <span class="Statement">}</span>
    <span class="Identifier">EOF</span>
</pre>
<pre class='ruby code syntax'>
    <span class="Comment">#! ))) dot</span>
    <span class="Type">Codnar</span>::<span class="Type">GraphViz</span>.to_html(diagram).should == <span class="Type">MINIMAL_DIAGRAM_SVG</span>
  end

  <span class="PreProc">def</span> <span class="Identifier">test_invalid_diagram</span>
    diagram = &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( dot</span>
</pre>
<pre class='dot code syntax'>
      <span class="Statement">digraph</span> <span class="Statement">{</span>
        <span class="Identifier">A</span> <span class="Statement">-&gt;</span>
    <span class="Identifier">EOF</span>
</pre>
<pre class='ruby code syntax'>
    <span class="Comment">#! ))) dot</span>
    <span class="Statement">lambda</span> { <span class="Type">Codnar</span>::<span class="Type">GraphViz</span>.to_html(diagram) }.should.raise
  end

end
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-graphviz-rb">
<span>lib/codnar/graphviz.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Generate diagrams using GraphViz.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">GraphViz</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert a string containing a GraphViz diagram into SVG suitable for
embedding into the HTML documentation. We pre-process the diagram using M4
to allow cutting down on the boilerplate (repeating the same styles in many
nodes etc.). This should not be harmful for diagrams that do not use M4
commands.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">to_html</span>(diagram)
      stdin, stdout, stderr = <span class="Type">Open3</span>.popen3(<span class="Special">&quot;</span><span class="Constant">m4 | dot -Tsvg</span><span class="Special">&quot;</span>)
      write_diagram(stdin, diagram)
      check_for_errors(stderr)
      <span class="Statement">return</span> clean_output(stdout)
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Send the diagram to the commands pipe.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">write_diagram</span>(stdin, diagram)
      stdin.write(diagram)
      stdin.close
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Ensure we got no processing errors from either m4 or dot. If we did, raise
them, and they will be handled by the formatter wrapping code.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">check_for_errors</span>(stderr)
      errors = stderr.read
      <span class="Statement">raise</span> errors.sub(<span class="Special">/</span><span class="Constant">Error: &lt;stdin&gt;:</span><span class="Special">\d</span><span class="Special">+</span><span class="Constant">: </span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>) <span class="Statement">if</span> errors != <span class="Special">&quot;&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Clean the SVG we got to make it suitable for embedding in HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">clean_output</span>(stdout)
      <span class="Statement">return</span> stdout.read.sub(<span class="Special">/</span><span class="Special">.</span><span class="Special">*</span><span class="Constant">&lt;svg</span><span class="Special">/m</span>, <span class="Special">&quot;</span><span class="Constant">&lt;svg</span><span class="Special">&quot;</span>).gsub(<span class="Special">/</span><span class="Special">\r</span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>)
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h4>Syntax highlighting using GVIM</h4>
<p>
If you have GVim istalled, it is possible to use it to generate syntax
highlighting. This is a <em>slow</em> operation, as GVim was never meant to be used as
a command-line tool. However, what it lacks in speed it compensates for in
scope; almost any language you can think of has a GVim syntax highlighting
definition. Here is a simple test that demonstrates using GVim for syntax
highlighting:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-gvim-highlight-syntax-rb">
<span>test/gvim_highlight_syntax.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test highlighting syntax using GVim.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestGVimHighlightSyntax</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">setup</span>
    <span class="Type">Codnar</span>::<span class="Type">GVim</span>.force_recompute = <span class="Constant">true</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">teardown</span>
    <span class="Type">Codnar</span>::<span class="Type">GVim</span>.force_recompute = <span class="Constant">false</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_ruby_no_css</span>
    ruby = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">      def foo</span>
<span class="Constant">        return bar = baz</span>
<span class="Constant">      end</span>
<span class="Constant">    </span><span class="Special">EOF</span>
    <span class="Type">Codnar</span>::<span class="Type">GVim</span>.cached_syntax_to_html(ruby, <span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>).should == &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
      <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'ruby code syntax'</span><span class="Identifier"> </span><span class="Type">bgcolor</span><span class="Identifier">=</span><span class="Constant">&quot;#ffffff&quot;</span><span class="Identifier"> </span><span class="Type">text</span><span class="Identifier">=</span><span class="Constant">&quot;#000000&quot;</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">font</span><span class="Identifier"> </span><span class="Type">face</span><span class="Identifier">=</span><span class="Constant">&quot;monospace&quot;</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">font</span><span class="Identifier"> </span><span class="Type">color</span><span class="Identifier">=</span><span class="Constant">&quot;#ff40ff&quot;</span><span class="Identifier">&gt;</span>def<span class="Identifier">&lt;/</span><span class="Statement">font</span><span class="Identifier">&gt;</span><span class="Special">&amp;nbsp;</span><span class="Identifier">&lt;</span><span class="Statement">font</span><span class="Identifier"> </span><span class="Type">color</span><span class="Identifier">=</span><span class="Constant">&quot;#00ffff&quot;</span><span class="Identifier">&gt;</span>foo<span class="Identifier">&lt;/</span><span class="Statement">font</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">br</span><span class="Identifier"> /&gt;</span>
      <span class="Special">&amp;nbsp;&amp;nbsp;</span><span class="Identifier">&lt;</span><span class="Statement">font</span><span class="Identifier"> </span><span class="Type">color</span><span class="Identifier">=</span><span class="Constant">&quot;#ffff00&quot;</span><span class="Identifier">&gt;</span>return<span class="Identifier">&lt;/</span><span class="Statement">font</span><span class="Identifier">&gt;</span><span class="Special">&amp;nbsp;</span>bar = baz<span class="Identifier">&lt;</span><span class="Statement">br</span><span class="Identifier"> /&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">font</span><span class="Identifier"> </span><span class="Type">color</span><span class="Identifier">=</span><span class="Constant">&quot;#ff40ff&quot;</span><span class="Identifier">&gt;</span>end<span class="Identifier">&lt;/</span><span class="Statement">font</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">br</span><span class="Identifier"> /&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">font</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    EOF
</pre>
<pre class='ruby code syntax'>
    <span class="Comment">#! ))) html</span>
  end

  <span class="PreProc">def</span> <span class="Identifier">test_ruby_css</span>
    ruby = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">      def foo</span>
<span class="Constant">        return bar = baz</span>
<span class="Constant">      end</span>
<span class="Constant">    </span><span class="Special">EOF</span>
    <span class="Type">Codnar</span>::<span class="Type">GVim</span>.cached_syntax_to_html(ruby, <span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>, [ <span class="Special">&quot;</span><span class="Constant">+:let html_use_css=1</span><span class="Special">&quot;</span> ]).should == &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
      <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'ruby code syntax'</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;PreProc&quot;</span><span class="Identifier">&gt;</span>def<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span> <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span>foo<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Statement&quot;</span><span class="Identifier">&gt;</span>return<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span> bar = baz
      <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;PreProc&quot;</span><span class="Identifier">&gt;</span>end<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    EOF
</pre>
<pre class='ruby code syntax'>
    <span class="Comment">#! ))) html</span>
  end

end
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-gvim-rb">
<span>lib/codnar/gvim.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Syntax highlight using GVim.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">GVim</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert a sequence of classified code lines to HTML using GVim syntax
highlighting. The commands array allows configuring the way that GVim will
format the output (see the <code>cached_syntax_to_html</code> method for
details).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">lines_to_html</span>(lines, syntax, commands = [])
      <span class="Statement">return</span> <span class="Type">Formatter</span>.merge_lines(lines, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">payload</span>|
        <span class="Type">GVim</span>.cached_syntax_to_html(payload + <span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span>, syntax, commands).chomp
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
The cache used for speeding up recomputing the same syntax highlighting
HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Identifier">@cache</span> = <span class="Type">Cache</span>.new(<span class="Special">&quot;</span><span class="Constant">.gvim-cache</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">data</span>|
      <span class="Type">GVim</span>.uncached_syntax_to_html(data.text, data.syntax, data.commands)
    <span class="Statement">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Force recomputation of the syntax highlighting HTML, even if a cached
version exists.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">force_recompute=</span>(force_recompute)
      <span class="Identifier">@cache</span>.force_recompute = force_recompute
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Highlight syntax of text using GVim. This uses the GVim standard CSS
classes to mark keywords, identifiers, and so on. See the GVim
documentation for details. The commands array allows configuring the way
that GVim will format the output. For example:
</p>
<ul><li>
<p>
The command <code>&quot;+:colorscheme &lt;name&gt;&quot;</code> will
override the default color scheme used.
</p>
</li><li>
<p>
The command <code>&quot;+:let html_use_css=1&quot;</code> will just
annotate each HTML tag with a CSS class, instead of embedding some specific
style directly into the tag. In this case the colorscheme and background
are ignored; you will need to provide your own CSS stylesheet as part of
the final woven document to style the marked-up words.
</p>
</li></ul>
<p>
Additional commands may be useful; GVim provides a full scripting
environment so there is no theoretical limit to what can be done here.
</p>
<p>
Since GVim is as slow as molasses to start up, we cache the results of
highlighting the syntax of each code fragment in a directory called
<code>.gvim-cache</code>, which can appear at the current working directory
or in any of its parents.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">cached_syntax_to_html</span>(text, syntax, commands = [])
      data = { <span class="Special">&quot;</span><span class="Constant">text</span><span class="Special">&quot;</span> =&gt; text, <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; syntax, <span class="Special">&quot;</span><span class="Constant">commands</span><span class="Special">&quot;</span> =&gt; commands }
      <span class="Statement">return</span> <span class="Identifier">@cache</span>[data]
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Highlight syntax of text using GVim, without caching. This is
<strong>slow</strong> (measured in seconds), due to GVim’s start-up tim.
See the <code>cached_syntax_to_html</code> method for a faster variant and
functionality details.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">uncached_syntax_to_html</span>(text, syntax, commands = [])
      file = write_temporary_file(text)
      run_gvim(file, syntax, commands)
      html = read_html_file(file)
      delete_temporary_files(file)
      <span class="Statement">return</span> clean_html(html, syntax)
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Write the text to highlight the syntax of into a temporary file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">write_temporary_file</span>(text)
      file = <span class="Type">Tempfile</span>.open(<span class="Special">&quot;</span><span class="Constant">codnar-</span><span class="Special">&quot;</span>)
      file.write(text)
      file.close(<span class="Constant">false</span>)
      <span class="Statement">return</span> file
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run GVim to highlight the syntax of a temporary file. This uses the
little-known ability of GVim to emit the syntax highlighting as HTML using
only command-line arguments.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">run_gvim</span>(file, syntax, commands)
      path = file.path
      <span class="Identifier">ENV</span>[<span class="Special">&quot;</span><span class="Constant">DISPLAY</span><span class="Special">&quot;</span>] = <span class="Special">&quot;</span><span class="Constant">none</span><span class="Special">&quot;</span> <span class="Comment"># Otherwise the X11 server *does* affect the result.</span>
      command = [
        <span class="Special">&quot;</span><span class="Constant">gvim</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">-f</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">-X</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">-u</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">none</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">-U</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">none</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">+:let html_ignore_folding=1</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">+:let use_xhtml=1</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">+:let html_use_css=0</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">+:syn on</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">+:set syntax=</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Special">&quot;</span>,
        commands,
        <span class="Special">&quot;</span><span class="Constant">+run! syntax/2html.vim</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">+:f </span><span class="Special">#{</span>path<span class="Special">}</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">+:wq</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">+:q</span><span class="Special">&quot;</span>,
        path
      ]
      system(<span class="Special">&quot;</span><span class="Constant">echo '</span><span class="Special">\n</span><span class="Constant">' | '</span><span class="Special">#{</span>command.flatten.join(<span class="Special">&quot;</span><span class="Constant">' '</span><span class="Special">&quot;</span>)<span class="Special">}</span><span class="Constant">' &gt; /dev/null 2&gt;&amp;1</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Read the HTML with the syntax highlighting written out by GVim.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">read_html_file</span>(file)
      <span class="Statement">return</span> <span class="Type">File</span>.read(html_file_path(file))
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Delete both the text and HTML temporary files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">delete_temporary_files</span>(file)
      <span class="Type">File</span>.delete(html_file_path(file))
      file.delete
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Find the path of the generate HTML file. You’d think it would be
predictable, but it ends up either “.html” or “.xhtml” depending on
the system.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">html_file_path</span>(file)
      <span class="Statement">return</span> <span class="Type">Dir</span>.glob(file.path + <span class="Special">&quot;</span><span class="Constant">.*html</span><span class="Special">&quot;</span>)[<span class="Constant">0</span>]
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Extract the clean highlighted syntax HTML from GVim’s HTML output.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">clean_html</span>(html, syntax)
      <span class="Statement">if</span> html =~ <span class="Special">/</span><span class="Constant">&lt;pre&gt;</span><span class="Special">/</span>
        html.sub!(<span class="Special">/</span><span class="Special">.</span><span class="Special">*?</span><span class="Constant">&lt;pre&gt;</span><span class="Special">/m</span>, <span class="Special">&quot;</span><span class="Constant">&lt;pre class='</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant"> code syntax'&gt;</span><span class="Special">&quot;</span>)
        html.sub!(<span class="Special">&quot;</span><span class="Constant">&lt;/body&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/html&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>, <span class="Special">&quot;&quot;</span>)
      <span class="Statement">else</span>
        html.sub!(<span class="Special">/</span><span class="Special">.</span><span class="Special">*?</span><span class="Constant">&lt;body</span><span class="Special">/m</span>, <span class="Special">&quot;</span><span class="Constant">&lt;div class='</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant"> code syntax'</span><span class="Special">&quot;</span>)
        html.sub!(<span class="Special">&quot;</span><span class="Constant">&lt;/body&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/html&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">&lt;/div&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>)
      <span class="Statement">end</span>
      <span class="Statement">return</span> html
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<p>
Since GVim is so slow, we are using caching to minimize the time it takes to
recompute the same code's highlighted HTML. This is pretty useful in practice -
making changes in one chunk in a file will not require recomputing the
highlighting for any of the unchanged chunks in the same file. Here is a simple
test of using the caching functionality:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-cache-computations-rb">
<span>test/cache_computations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test caching long computations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestCacheComputations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="PreProc">def</span> <span class="Identifier">test_cached_computation</span>
    cache = make_addition_cache(directory = create_tempdir(<span class="Special">&quot;</span><span class="Constant">..</span><span class="Special">&quot;</span>))
    cache[<span class="Constant">1</span>].should == <span class="Constant">2</span>
    <span class="Type">File</span>.open(<span class="Type">Dir</span>.glob(directory + <span class="Special">&quot;</span><span class="Constant">/*</span><span class="Special">&quot;</span>)[<span class="Constant">0</span>], <span class="Special">&quot;</span><span class="Constant">w</span><span class="Special">&quot;</span>) { |<span class="Identifier">file</span>| file.puts(<span class="Special">&quot;</span><span class="Constant">3</span><span class="Special">&quot;</span>) }
    cache[<span class="Constant">1</span>].should == <span class="Constant">3</span>
    cache.force_recompute = <span class="Constant">true</span>
    cache[<span class="Constant">1</span>].should == <span class="Constant">2</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_uncached_computation</span>
    stderr = capture_stderr { make_addition_cache(<span class="Special">&quot;</span><span class="Constant">no-such-directory</span><span class="Special">&quot;</span>)[<span class="Constant">1</span>].should == <span class="Constant">2</span> }
    stderr.should.include?(<span class="Special">&quot;</span><span class="Constant">no-such-directory</span><span class="Special">&quot;</span>)
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run a block and capture its standard error (without using FakeFS).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">def</span> <span class="Identifier">capture_stderr</span>
    stderr_path = write_tempfile(<span class="Special">&quot;</span><span class="Constant">stderr</span><span class="Special">&quot;</span>, <span class="Special">&quot;&quot;</span>)
    <span class="Type">Olag</span>::<span class="Type">Globals</span>.without_changes <span class="Statement">do</span>
      <span class="Identifier">$stderr</span> = <span class="Type">File</span>.open(stderr_path, <span class="Special">&quot;</span><span class="Constant">w</span><span class="Special">&quot;</span>)
      <span class="Statement">yield</span>
    <span class="Statement">end</span>
    <span class="Statement">return</span> <span class="Type">File</span>.read(stderr_path)
  <span class="PreProc">end</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Create a cache for the “+ 1” operation.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">def</span> <span class="Identifier">make_addition_cache</span>(directory)
    <span class="Statement">return</span> <span class="Type">Codnar</span>::<span class="Type">Cache</span>.new(directory) { |<span class="Identifier">value</span>| value + <span class="Constant">1</span> }
  <span class="PreProc">end</span>

end
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-cache-rb">
<span>lib/codnar/cache.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Cache long computations in disk files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Cache</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Whether to recompute values even if they are cached.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Statement">attr_accessor</span> <span class="Constant">:force_recompute</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Connect to an existing disk cache. The cache is expected to be stored in a
directory of the specified name, which is either in the current working
directory or in one of its parent directories.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(directory, &amp;block)
      <span class="Identifier">@force_recompute</span> = <span class="Constant">false</span>
      <span class="Identifier">@computation</span> = block
      <span class="Identifier">@directory</span> = find_directory(<span class="Type">Dir</span>.pwd, directory)
      <span class="Statement">if</span> <span class="Identifier">@directory</span>
        <span class="PreProc">class</span> &lt;&lt;<span class="Constant">self</span>; <span class="PreProc">alias</span> <span class="Identifier">[]</span> <span class="Constant">:cached_computation</span>; <span class="PreProc">end</span>
      <span class="Statement">else</span>
        <span class="PreProc">class</span> &lt;&lt;<span class="Constant">self</span>; <span class="PreProc">alias</span> <span class="Identifier">[]</span> <span class="Constant">:uncached_computation</span>; <span class="PreProc">end</span>
        <span class="Identifier">$stderr</span>.puts(<span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Could not find cache directory: </span><span class="Special">#{</span>directory<span class="Special">}</span><span class="Constant">.</span><span class="Special">&quot;</span>)
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Access the results of the computation for the specified input. Fetch the
result from the cache if it is there, otherwise invoke the computation and
store the result in the cache for the next time.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">cached_computation</span>(input)
      file = cache_file(input)
      <span class="Statement">return</span> <span class="Type">YAML</span>.load_file(file) <span class="Statement">if</span> <span class="Type">File</span>.exists?(file) <span class="Statement">and</span> <span class="Statement">not</span> <span class="Identifier">@force_recompute</span>
      result = <span class="Identifier">@computation</span>.call(input)
      <span class="Type">File</span>.open(file, <span class="Special">&quot;</span><span class="Constant">w</span><span class="Special">&quot;</span>) { |<span class="Identifier">file</span>| file.write(result.to_yaml) }
      <span class="Statement">return</span> result
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return the file expected to cache the computed results for a given input,
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">cache_file</span>(input)
      key = <span class="Type">Digest</span>.hexencode(<span class="Type">Digest</span>::<span class="Type">SHA2</span>.digest(input.to_yaml))
      <span class="Statement">return</span> <span class="Identifier">@directory</span> + <span class="Special">&quot;</span><span class="Constant">/</span><span class="Special">&quot;</span> + key + <span class="Special">&quot;</span><span class="Constant">.yaml</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Access the results of a computation for the specified input, in case we do
not have a cache directory to look for and store the results in.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">uncached_computation</span>(input)
      <span class="Statement">return</span> <span class="Identifier">@computation</span>.call(input)
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Find the path of the cache directory, search from the given working
directory upward until finding a match.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">find_directory</span>(working_directory, cache_directory)
      directory = working_directory + <span class="Special">&quot;</span><span class="Constant">/</span><span class="Special">&quot;</span> + cache_directory
      <span class="Statement">return</span> directory <span class="Statement">if</span> <span class="Type">File</span>.exists?(directory)
      parent_directory = <span class="Type">File</span>.dirname(working_directory)
      <span class="Statement">return</span> <span class="Constant">nil</span> <span class="Statement">if</span> parent_directory == working_directory
      <span class="Statement">return</span> find_directory(parent_directory, cache_directory)
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h4>Syntax highlighting using CodeRay</h4>
<p>
<a href="http://coderay.rubychan.de/">CodeRay</a> is a Ruby gem that knows how to
highlight the syntax of many popular languages. It is much faster than using
GVim`but doesn't offer the huge range of programming languages offered by GVim
(for example, it does not currently offer shell script highlighting). If your
languages are covered by it, it may serve as a convenient replacement to the
slow GVim approach.
</p>
<p>
Here is a simple test that demonstrates using CodeRay for syntax highlighting:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-coderay-highlight-syntax-rb">
<span>test/coderay_highlight_syntax.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test highlighting syntax using CodeRay.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestCodeRayHighlightSyntax</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_coderay_lines</span>
    <span class="Type">Codnar</span>::<span class="Type">CodeRay</span>.lines_to_html([
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">ruby_code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">def foo</span><span class="Special">&quot;</span>  },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">ruby_code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  </span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">return 1</span><span class="Special">&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">ruby_code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">3</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end</span><span class="Special">&quot;</span>      },
    ], <span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>).should == [
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>,
        <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">          &lt;div class=&quot;CodeRay&quot;&gt;</span>
<span class="Constant">            &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color:#06B;font-weight:bold&quot;&gt;foo&lt;/span&gt;</span>
<span class="Constant">            &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;</span>
<span class="Constant">          &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</span>
<span class="Constant">          &lt;/div&gt;</span>
<span class="Constant">        </span><span class="Special">EOF</span>
      },
    ]
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-coderay-rb">
<span>lib/codnar/coderay.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Extend the CodeRay module.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">module</span> <span class="Type">CodeRay</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert a sequence of classified code lines to HTML using CodeRay syntax
highlighting. The options control the way CodeRay behaves (e.g.,
&lt;tt&gt;:css
</p>
<h1 id="label-%3E+%3Aclass%3C%2Ftt%3E%29.">&gt; :class&lt;/tt&gt;).</h1>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">lines_to_html</span>(lines, syntax, options = {})
      <span class="Statement">return</span> <span class="Type">Formatter</span>.merge_lines(lines, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">payload</span>|
        ::<span class="Type">CodeRay</span>.scan(payload, syntax).div(options).chomp
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h4>Syntax highlighting using Sunlight</h4>
<p>
<a href="http://sunlightjs.com/">Sunlight</a> offers a different approach for syntax
highlighting. Instead of pre-processing the code to generate highlighted HTML
while splitting, it provides Javascript files that examine the textual code in
the DOM and convert it to highlighted HTML in the browser. This takes virtually
no time when splitting the code, but requires recomputing highlighting for all
the code chunks every time the HTML file is loaded. This can be pretty slow,
especially if using a browser with a slow Javascript engine, like IE. However,
this may be a reasonable trade-off, at least for small projects. Since Sunlight
is a new project, it supports a limited range of programming languages.
</p>
<p>
Here is a simple test that demonstrates using Sunlight for syntax highlighting:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-sunlight-highlight-syntax-rb">
<span>test/sunlight_highlight_syntax.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test highlighting syntax using Sunlight.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSunlightHighlightSyntax</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_sunlight_lines</span>
    <span class="Type">Codnar</span>::<span class="Type">Sunlight</span>.lines_to_html([
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">ruby_code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">def foo</span><span class="Special">&quot;</span>  },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">ruby_code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">  </span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">return 1</span><span class="Special">&quot;</span> },
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">ruby_code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">3</span>, <span class="Special">&quot;</span><span class="Constant">indentation</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;&quot;</span>,   <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end</span><span class="Special">&quot;</span>      },
    ], <span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>).should == [
      { <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">number</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>,
        <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">          &lt;pre class='sunlight-highlight-ruby'&gt;</span>
<span class="Constant">          def foo</span>
<span class="Constant">            return 1</span>
<span class="Constant">          end</span>
<span class="Constant">          &lt;/pre&gt;</span>
<span class="Constant">        </span><span class="Special">EOF</span>
      },
    ]
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-sunlight-rb">
<span>lib/codnar/sunlight.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Syntax highlight using Sunlight.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Sunlight</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert a sequence of classified code lines to HTML using Sunlight syntax
highlighting. All we need to do is wrap the lines in an HTML
<code>pre</code> element with the correct class
(<code>sunlight-highlight-<em>syntax</em></code>). The actual highlighting
is done in the HTML DOM using Javascript. Embedding this Javascript into
the final HTML should be done separately.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">lines_to_html</span>(lines, syntax)
      <span class="Statement">return</span> <span class="Type">Formatter</span>.lines_to_pre_html(lines, <span class="Constant">:class</span> =&gt; <span class="Special">&quot;</span><span class="Constant">sunlight-highlight-</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h3>Putting it all together</h3>
<p>
Now that we have all the separate pieces of functionality for splitting source
files into HTML chunks, we need to combine them to a single convenient service.
</p>
<h4>Splitting code files</h4>
<p>
Here is a simple test that demonstrates using the splitter for source code
files:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-code-rb">
<span>test/split_code.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test splitting code files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitCode</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_ruby</span>
    splitter = <span class="Type">Codnar</span>::<span class="Type">Splitter</span>.new(<span class="Identifier">@errors</span>, <span class="Type">RUBY_CONFIGURATION</span>)
    path = write_tempfile(<span class="Special">&quot;</span><span class="Constant">ruby.rb</span><span class="Special">&quot;</span>, <span class="Type">RUBY_FILE</span>)
    chunks = splitter.chunks(path)
    <span class="Identifier">@errors</span>.should == []
    chunks.should == ruby_chunks(path)
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

  <span class="PreProc">def</span> <span class="Identifier">ruby_chunks</span>(path)
    <span class="Type">RUBY_CHUNKS</span>[<span class="Constant">0</span>].name = path
    <span class="Type">RUBY_CHUNKS</span>[<span class="Constant">1</span>].containers[<span class="Constant">0</span>] = path
    <span class="Type">RUBY_CHUNKS</span>.each { |<span class="Identifier">chunk</span>| chunk.locations[<span class="Constant">0</span>].file = path }
    <span class="Statement">return</span> <span class="Type">RUBY_CHUNKS</span>
  <span class="PreProc">end</span>

  <span class="Type">RUBY_FILE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.gsub(<span class="Special">&quot;</span><span class="Constant">#!</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">#</span><span class="Special">&quot;</span>)
<span class="Constant">    #! This is *rdoc*.</span>
<span class="Constant">      #! {{{ assignment</span>
<span class="Constant">      local = $global</span>
<span class="Constant">        indented</span>
<span class="Constant">      #! }}}</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="Type">RUBY_CONFIGURATION</span> = {
    <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.cast_lines(lines, 'ruby')</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.cast_lines(lines, 'rdoc')</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">GVim.lines_to_html(lines, 'ruby')</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">rdoc</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Codnar::RDoc, 'rdoc')</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">[]</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">[]</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">nested_chunk</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.nested_chunk_lines_to_html(lines)</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.unindented_lines_to_html(lines)</span><span class="Special">&quot;</span>,
    },
    <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">start_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)#</span><span class="Special">\\</span><span class="Constant">s*(.*)$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)(.*)$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">\\</span><span class="Constant">W*</span><span class="Special">\\</span><span class="Constant">{</span><span class="Special">\\</span><span class="Constant">{</span><span class="Special">\\</span><span class="Constant">{</span><span class="Special">\\</span><span class="Constant">s*(.*?)</span><span class="Special">\\</span><span class="Constant">s*$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">\\</span><span class="Constant">W*</span><span class="Special">\\</span><span class="Constant">}</span><span class="Special">\\</span><span class="Constant">}</span><span class="Special">\\</span><span class="Constant">}</span><span class="Special">\\</span><span class="Constant">s*(.*?)</span><span class="Special">\\</span><span class="Constant">s*$</span><span class="Special">&quot;</span> },
      },
      <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span> },
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span> },
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> },
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">code</span><span class="Special">&quot;</span> },
          ],
        },
      },
    },
  }

  <span class="Type">RUBY_CHUNKS</span> = [ {
    <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">PATH</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">PATH</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> ],
    <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
    <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">assignment</span><span class="Special">&quot;</span> ],
    <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp, <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
      <span class="Identifier">&lt;</span><span class="Statement">table</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'layout'</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">tr</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">td</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'indentation'</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">td</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">td</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'html'</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'rdoc rdoc markup'</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
      This is <span class="Identifier">&lt;</span><span class="Statement">strong</span><span class="Identifier">&gt;</span><span class="htmlBold">rdoc</span><span class="Identifier">&lt;/</span><span class="Statement">strong</span><span class="Identifier">&gt;</span>.
      <span class="Identifier">&lt;/</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">td</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">tr</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">table</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'nested chunk'</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'nested chunk'</span><span class="Identifier"> </span><span class="Type">href</span><span class="Identifier">=</span><span class="Constant">'#assignment'</span><span class="Identifier">&gt;</span><span class="Underlined">assignment</span><span class="Identifier">&lt;/</span><span class="Statement">a</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    EOF
</pre>
<pre class='ruby code syntax'>
    <span class="Comment">#! ))) html</span>
  }, {
    <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">assignment</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">PATH</span><span class="Special">&quot;</span> ],
    <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
    <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">PATH</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span> ],
    <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp, <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
      <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'ruby code syntax'</span><span class="Identifier"> </span><span class="Type">bgcolor</span><span class="Identifier">=</span><span class="Constant">&quot;#ffffff&quot;</span><span class="Identifier"> </span><span class="Type">text</span><span class="Identifier">=</span><span class="Constant">&quot;#000000&quot;</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">font</span><span class="Identifier"> </span><span class="Type">face</span><span class="Identifier">=</span><span class="Constant">&quot;monospace&quot;</span><span class="Identifier">&gt;</span>
      local =<span class="Special">&amp;nbsp;</span><span class="Identifier">&lt;</span><span class="Statement">font</span><span class="Identifier"> </span><span class="Type">color</span><span class="Identifier">=</span><span class="Constant">&quot;#00ffff&quot;</span><span class="Identifier">&gt;</span>$global<span class="Identifier">&lt;/</span><span class="Statement">font</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">br</span><span class="Identifier"> /&gt;</span>
      <span class="Special">&amp;nbsp;&amp;nbsp;</span>indented<span class="Identifier">&lt;</span><span class="Statement">br</span><span class="Identifier"> /&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">font</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    EOF
</pre>
<pre class='ruby code syntax'>
    <span class="Comment">#! ))) html</span>
  } ]

end
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-splitter-rb">
<span>lib/codnar/splitter.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Split disk files into chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Splitter</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Construct a splitter based on a configuration in the following structure:
</p>
<pre>syntax: &lt;syntax&gt;
formatters:
  &lt;kind&gt;: &lt;expression&gt;</pre>
<p>
Where the syntax is passed as-is to (and expanded in-place by) a Scanner,
and the formatters are passed as-is to a Formatter to convert the chunk’s
classified lines into HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(errors, configuration)
      <span class="Identifier">@errors</span> = errors
      <span class="Identifier">@configuration</span> = configuration
      <span class="Identifier">@scanner</span> = <span class="Type">Scanner</span>.new(errors, configuration.syntax)
      <span class="Identifier">@formatter</span> = <span class="Type">Formatter</span>.new(errors, configuration.formatters)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Split a disk file into HTML chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">chunks</span>(path)
      lines = <span class="Identifier">@scanner</span>.lines(path)
      chunks = <span class="Type">Merger</span>.chunks(<span class="Identifier">@errors</span>, path, lines)
      chunks.each { |<span class="Identifier">chunk</span>| chunk.html = <span class="Identifier">@formatter</span>.lines_to_html(chunk.delete(<span class="Special">&quot;</span><span class="Constant">lines</span><span class="Special">&quot;</span>)) }
      <span class="Statement">return</span> chunks
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h4>Splitting documentation files</h4>
<p>
The narrative documentation is expected to reside in one or more files, which
are also "split" to a single chunk each. Having both documentation and code
exist as chunks allows for uniform treatment of both when weaving, as well as
allowing for pre-processing the documentation files, if necessary. For example,
Codnar currently supports for documentation the same two markup formats that
are also supported for code comments. Here is a simple test that demonstrates
"splitting" documentation (using the same implementation as above):
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-documentation-rb">
<span>test/split_documentation.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test “splitting” documentation files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitDocumentation</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_raw</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">raw.html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">&lt;foo&gt;</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Constant">&lt;/foo&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>)
    splitter = <span class="Type">Codnar</span>::<span class="Type">Splitter</span>.new(<span class="Identifier">@errors</span>, configuration(<span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>))
    chunks = splitter.chunks(<span class="Special">&quot;</span><span class="Constant">raw.html</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == []
    chunks.should == [ {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">raw.html</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">raw.html</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;foo&gt;</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Constant">&lt;/foo&gt;</span><span class="Special">&quot;</span>
    } ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_markdown</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">markdown.md</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">*foo*</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Special">&quot;</span>)
    splitter = <span class="Type">Codnar</span>::<span class="Type">Splitter</span>.new(<span class="Identifier">@errors</span>, configuration(<span class="Special">&quot;</span><span class="Constant">markdown</span><span class="Special">&quot;</span>))
    chunks = splitter.chunks(<span class="Special">&quot;</span><span class="Constant">markdown.md</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == []
    chunks.should == [ {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">markdown.md</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">markdown.md</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;div class='markdown markdown markup'&gt;</span><span class="Special">\n</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;em&gt;foo&lt;/em&gt;</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/div&gt;</span><span class="Special">&quot;</span>
    } ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_rdoc</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">rdoc.rdoc</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">*foo*</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Special">&quot;</span>)
    splitter = <span class="Type">Codnar</span>::<span class="Type">Splitter</span>.new(<span class="Identifier">@errors</span>, configuration(<span class="Special">&quot;</span><span class="Constant">rdoc</span><span class="Special">&quot;</span>))
    chunks = splitter.chunks(<span class="Special">&quot;</span><span class="Constant">rdoc.rdoc</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == []
    chunks.should == [ {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">rdoc.rdoc</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">rdoc.rdoc</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;div class='rdoc rdoc markup'&gt;</span><span class="Special">\n</span><span class="Constant">&lt;p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;strong&gt;foo&lt;/strong&gt; bar</span><span class="Special">\n</span><span class="Constant">&lt;/p&gt;</span><span class="Special">\n</span><span class="Constant">&lt;/div&gt;</span><span class="Special">&quot;</span>
    } ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_unknown_kind</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">unknown.kind</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Special">&quot;</span>)
    splitter = <span class="Type">Codnar</span>::<span class="Type">Splitter</span>.new(<span class="Identifier">@errors</span>, configuration(<span class="Special">&quot;</span><span class="Constant">unknown-kind</span><span class="Special">&quot;</span>))
    chunks = splitter.chunks(<span class="Special">&quot;</span><span class="Constant">unknown.kind</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == [ <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: No formatter specified for lines of kind: unknown-kind</span><span class="Special">&quot;</span> ]
    chunks.should == [ {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">unknown.kind</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">unknown.kind</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;pre class='missing formatter error'&gt;</span><span class="Special">\n</span><span class="Constant">foo</span><span class="Special">\n</span><span class="Constant">bar</span><span class="Special">\n</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span>
    } ]
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

  <span class="PreProc">def</span> <span class="Identifier">configuration</span>(kind)
    <span class="Statement">return</span> {
      <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">markdown</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Markdown, 'markdown')</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.unindented_lines_to_html(lines)</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">rdoc</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Codnar::RDoc, 'rdoc')</span><span class="Special">&quot;</span>,
      },
      <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">start_state</span><span class="Special">&quot;</span> =&gt; kind,
        <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
          kind =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(.*)$</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">groups</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> ] },
        },
        <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
          kind =&gt; {
            <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
              { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; kind }
            ]
          }
        }
      }
    }
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<h3>Built-in configurations</h3>
<p>
The splitting mechanism defined above is pretty generic. To apply it to a
specific system requires providing the appropriate configuration. The system
provides a few specific built-in configurations which may be useful "out of the
box".
</p>
<p>
If one is willing to give up altogether on syntax highlighting and comment
formatting, the system would be applicable as-is to any programming language.
Properly highlighting almost any known programming language syntax would be a
simple matter of passing the correct syntax parameter to GVim.
</p>
<p>
Properly formatting comments in additional mark-up formats would be trickier.
First, a proper pattern needs to be established for extracting the comments
(<code>/*</code>, <code>//</code>, <code>--</code>, etc.). Them, the results need to be converted to HTML. One
way would be to pass them through GVim syntax highlighting with an appropriate
format (e.g, <code>syntax=doxygen</code>). Another would be to invoke some Ruby library;
finally, one could invoke some external tool to do the job. The latter two
options would require providing additional glue Ruby code, similar to the GVim
class above.
</p>
<p>
At any rate, here are the built-in configurations:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-split-configurations-rb">
<span>lib/codnar/split_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
A module for all the “built-in” configurations. The names of these
configurations can be passed to the –require option of any Codnar
Application.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">module</span> <span class="Type">Configuration</span>

    <span class="PreProc">include</span> <span class="Type">Documentation</span>
    <span class="PreProc">include</span> <span class="Type">Code</span>
    <span class="PreProc">include</span> <span class="Type">Comments</span>
    <span class="PreProc">include</span> <span class="Type">Highlighting</span>

  <span class="PreProc">end</span>

end
</pre>
</div>
</div>
</p>
<h4>Combining configurations</h4>
<p>
Different source files require different overall configurations but reuse
common building blocks. To support it, we allow comfigurations to be combined
using a "deep merge". This allows complex nested structures to be merged. There
is even a way for arrays to append elements before/after the array they are
merged with. Here is a simple test that demonstrates deep-merging complex
structures:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-deep-merge-rb">
<span>test/deep_merge.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test deep-merging complex structures.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestDeepMerge</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_deep_merge</span>
    default = {
      <span class="Special">&quot;</span><span class="Constant">only_default</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">default_value</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">overriden</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">default_value</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">overriden_array</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">default_value</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">merged_array</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">default_value</span><span class="Special">&quot;</span> ],
    }
    override = {
      <span class="Special">&quot;</span><span class="Constant">only_override</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">overriden_value</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">overriden</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">overriden_value</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">overriden_array</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">overriden_value</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">merged_array</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">overriden_value</span><span class="Special">&quot;</span>, [] ],
    }
    default.deep_merge(override).should == {
      <span class="Special">&quot;</span><span class="Constant">only_default</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">default_value</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">only_override</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">overriden_value</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">overriden</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">overriden_value</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">overriden_array</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">overriden_value</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">merged_array</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">overriden_value</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">default_value</span><span class="Special">&quot;</span> ],
    }
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
Here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="deep-merge">
<span>Deep merge</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Perform a deep merge with another hash.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">def</span> <span class="Identifier">deep_merge</span>(hash)
    <span class="Statement">return</span> merge(hash, &amp;<span class="Type">Hash</span>::method(<span class="Special">&quot;</span><span class="Constant">deep_merger</span><span class="Special">&quot;</span>))
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return a Hash merger that recursively merges nested hashes.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">deep_merger</span>(key, default, override)
    <span class="Statement">if</span> <span class="Type">Hash</span> === default &amp;&amp; <span class="Type">Hash</span> === override
      default.deep_merge(override)
    <span class="Statement">elsif</span> <span class="Type">Array</span> === default &amp;&amp; <span class="Type">Array</span> === override
      <span class="Type">Hash</span>.deep_merge_arrays(default, override)
    <span class="Statement">else</span>
      override
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
If the overriding data array contains an empty array element (“[]”), it
is replaced by the default data array being overriden.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">deep_merge_arrays</span>(default, override)
    embed_index = override.find_index([])
    <span class="Statement">return</span> override <span class="Statement">unless</span> embed_index
    override = override.dup
    override[embed_index..embed_index] = default
    <span class="Statement">return</span> override
  <span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-hash-extensions-rb">lib/codnar/hash_extensions.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
And here is a test module that automates the process of merging configurations
and invoking the Splitter:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-lib-test-with-configurations-rb">
<span>test/lib/test_with_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Tests with Codnar split configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test running the Splitter with merged configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">def</span> <span class="Identifier">check_split_file</span>(file_text, *configurations, &amp;block)
    configuration = configurations.inject({}) <span class="Statement">do</span> |<span class="Identifier">merged_configuration</span>, <span class="Identifier">next_configuration</span>|
      merged_configuration.deep_merge(next_configuration)
    <span class="Statement">end</span>
    splitter = <span class="Type">Codnar</span>::<span class="Type">Splitter</span>.new(<span class="Identifier">@errors</span>, configuration)
    chunks = splitter.chunks(path = write_tempfile(<span class="Special">&quot;</span><span class="Constant">splitted</span><span class="Special">&quot;</span>, file_text))
    <span class="Identifier">@errors</span>.should == []
    chunks.should == <span class="Statement">yield</span>(path)
  <span class="PreProc">end</span>

end
</pre>
</div>
</div>
</p>
<h4>Documentation "splitting"</h4>
<p>
These are pretty simple configurations, applicable to files containing a piece
of the narrative in some supported format. These configurations typically do
not require to be combined with other configurations. Here is a simple test
that demonstrates "splitting" documentation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-documentation-configurations-rb">
<span>test/split_documentation_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test the built-in split documentation configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitDocumentationConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="Comment">#!include Test::WithFakeFS - until FakeFS fixes the tempfile issue.</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="Type">HTML_FILE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;</span><span class="Statement">p</span><span class="Identifier">&gt;</span>This is an
    HTML file.<span class="Identifier">&lt;/</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
  EOF
</pre>
<pre class='ruby code syntax'>
  <span class="Comment"># ))) html</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_html_documentation</span>
    check_split_file(<span class="Type">HTML_FILE</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">SPLIT_HTML_DOCUMENTATION</span>) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Type">HTML_FILE</span>.chomp
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

  <span class="Type">PRE_FILE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">    This is a preformatted</span>
<span class="Constant">    raw text file.</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_pre_documentation</span>
    check_split_file(<span class="Type">PRE_FILE</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">SPLIT_PRE_DOCUMENTATION</span>) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;pre class='doc'&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> + <span class="Type">PRE_FILE</span> + <span class="Special">&quot;</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span>
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

  <span class="Type">MARKUP_FILE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">    This is a</span>
<span class="Constant">    *marked-up* file.</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="Type">RDOC_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'rdoc doc markup'</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
    This is a <span class="Identifier">&lt;</span><span class="Statement">strong</span><span class="Identifier">&gt;</span><span class="htmlBold">marked-up</span><span class="Identifier">&lt;/</span><span class="Statement">strong</span><span class="Identifier">&gt;</span> file.
    <span class="Identifier">&lt;/</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
  EOF
</pre>
<pre class='ruby code syntax'>
  <span class="Comment"># ))) html</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_rdoc_documentation</span>
    check_split_file(<span class="Type">MARKUP_FILE</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">SPLIT_RDOC_DOCUMENTATION</span>) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Type">RDOC_HTML</span>,
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

  <span class="Type">MARKDOWN_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'markdown doc markup'</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
    This is a
    <span class="Identifier">&lt;</span><span class="Statement">em</span><span class="Identifier">&gt;</span><span class="htmlItalic">marked-up</span><span class="Identifier">&lt;/</span><span class="Statement">em</span><span class="Identifier">&gt;</span> file.
    <span class="Identifier">&lt;/</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
  EOF
</pre>
<pre class='ruby code syntax'>
  <span class="Comment">#! ))) html</span>

  <span class="PreProc">def</span> <span class="Identifier">test_split_markdown_documentation</span>
    check_split_file(<span class="Type">MARKUP_FILE</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">SPLIT_MARKDOWN_DOCUMENTATION</span>) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Type">MARKDOWN_HTML</span>,
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

end
</pre>
</div>
</div>
</p>
<p>
And here are the actual configurations:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-configuration-documentation-rb">
<span>lib/codnar/configuration/documentation.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

  <span class="PreProc">module</span> <span class="Type">Configuration</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Configurations for “splitting” documentation files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">module</span> <span class="Type">Documentation</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
“Split” a documentation file. All lines are assumed to have the same
kind <code>doc</code> and no indentation is collected. Unless overriden by
additional configuration(s), the lines are assumed to contain formatted
HTML, and are passed as-is to the output.
</p>
<p>
This is the default configuration as it performs the minimal amount of
processing on the input. It isn’t the most useful configuration.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="Type">SPLIT_HTML_DOCUMENTATION</span> = {
        <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">doc</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.cast_lines(lines, 'html')</span><span class="Special">&quot;</span>,
        },
        <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
            <span class="Special">&quot;</span><span class="Constant">doc</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(.*)$</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">groups</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">payload</span><span class="Special">&quot;</span> ] },
          },
          <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
            <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">doc</span><span class="Special">&quot;</span> } ] },
          },
        },
      }

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
“Split” a documentation file containing arbitrary text, which is
preserved by escaping it and wrapping it in an HTML pre element.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="Type">SPLIT_PRE_DOCUMENTATION</span> = <span class="Type">SPLIT_HTML_DOCUMENTATION</span>.deep_merge(
        <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">doc</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.lines_to_pre_html(lines, :class =&gt; :doc)</span><span class="Special">&quot;</span>,
        }
      )

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
“Split” a documentation file containing pure RDoc documentation.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="Type">SPLIT_RDOC_DOCUMENTATION</span> = <span class="Type">SPLIT_HTML_DOCUMENTATION</span>.deep_merge(
        <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">doc</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Codnar::RDoc, 'rdoc')</span><span class="Special">&quot;</span>,
          <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.unindented_lines_to_html(lines)</span><span class="Special">&quot;</span>,
        }
      )

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
“Split” a documentation file containing pure Markdown documentation.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="Type">SPLIT_MARKDOWN_DOCUMENTATION</span> = <span class="Type">SPLIT_HTML_DOCUMENTATION</span>.deep_merge(
        <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">doc</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Codnar::Markdown, 'markdown')</span><span class="Special">&quot;</span>,
          <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.unindented_lines_to_html(lines)</span><span class="Special">&quot;</span>,
        }
      )

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
“Split” a documentation file containing a GraphViz diagram.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="Type">SPLIT_GRAPHVIZ_DOCUMENTATION</span> = <span class="Type">SPLIT_HTML_DOCUMENTATION</span>.deep_merge(
        <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">doc</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Codnar::GraphViz, 'graphviz')</span><span class="Special">&quot;</span>,
          <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.unindented_lines_to_html(lines)</span><span class="Special">&quot;</span>,
        }
      )

    end

  end

end
</pre>
</div>
</div>
</p>
<h4>Source code lines classification</h4>
<p>
Splitting source code files is a more complex affair, which does typically
require combining several configurations.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-configuration-code-rb">
<span>lib/codnar/configuration/code.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

  <span class="PreProc">module</span> <span class="Type">Configuration</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Configurations for splitting source code.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">module</span> <span class="Type">Code</span>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#source-code-lines-classification-configurations'>Source code lines classification configurations</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#nested-foreign-syntax-code-islands-configurations'>Nested foreign syntax code islands configurations</a>
</pre>
<pre class='ruby code syntax'>

    end

  end

end
</pre>
</div>
</div>
</p>
<p>
The basic configuration marks all lines as belonging to some code syntax, as a
single chunk:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="source-code-lines-classification-configurations">
<span>Source code lines classification configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify all lines as source code of some syntax (kind). This doesn’t
distinguish between comment and code lines; to do that, you need to combine
this with comment classification configuration(s). Also, it just formats
the lines in an HTML <code>pre</code> element, without any syntax
highlighting; to do that, you need to combine this with syntax highlighting
formatting configuration(s).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_SOURCE_CODE</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">syntax</span>|
  <span class="Statement">return</span> {
    <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant">_code</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.lines_to_pre_html(lines, :class =&gt; :code)</span><span class="Special">&quot;</span>,
    },
    <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant">_code</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)(.*)$</span><span class="Special">&quot;</span> },
      },
      <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant">_code</span><span class="Special">&quot;</span> },
          ],
        },
      },
    },
  }
<span class="Statement">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-code-rb">lib/codnar/configuration/code.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
Sometimes, a code in one syntax contains nested "islands" of code in another
syntax. Here is a simple configuration to support that, which can be combined
with the above basic configuration:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="nested-foreign-syntax-code-islands-configurations">
<span>Nested foreign syntax code islands configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Allow for comments containing “((( &lt;syntax&gt;” and “)))
&lt;syntax&gt;” to designate nested islands of foreign syntax inside the
normal code. The designator comment lines are always treated as part of the
surrounding code, not as part of the nested foreign syntax code. There is
no further classification of the nested foreign syntax code. Therefore, the
nested code is not examined for begin/end chunk markers. Likewise, the
nested code may not contain deeper nested code using a third syntax.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_NESTED_CODE</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">outer_syntax</span>, <span class="Identifier">inner_syntax</span>|
  {
    <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">start_</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_in_</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Special">&quot;</span> =&gt;
          { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)(.*</span><span class="Special">\\</span><span class="Constant">(</span><span class="Special">\\</span><span class="Constant">(</span><span class="Special">\\</span><span class="Constant">(</span><span class="Special">\\</span><span class="Constant">s*</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">.*)$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Constant">end_</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_in_</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Special">&quot;</span> =&gt;
          { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)(.*</span><span class="Special">\\</span><span class="Constant">)</span><span class="Special">\\</span><span class="Constant">)</span><span class="Special">\\</span><span class="Constant">)</span><span class="Special">\\</span><span class="Constant">s*</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">.*)$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_in_</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Special">&quot;</span> =&gt;
          { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)(.*)$</span><span class="Special">&quot;</span> },
      },
      <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">start_</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_in_</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Constant">_code</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">next_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_in_</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Special">&quot;</span> },
            [],
          ],
        },
        <span class="Special">&quot;</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_in_</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end_</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_in_</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Constant">_code</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">next_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> },
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_in_</span><span class="Special">#{</span>outer_syntax<span class="Special">}</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Special">#{</span>inner_syntax<span class="Special">}</span><span class="Constant">_code</span><span class="Special">&quot;</span> },
          ],
        },
      },
    },
  }
<span class="Statement">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-code-rb">lib/codnar/configuration/code.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
Here is a simple test demonstrating using source code lines classifications:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-code-configurations-rb">
<span>test/split_code_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test combinations of the built-in split code configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitCodeConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="Type">SOURCE_CODE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">    a = b</span>
<span class="Constant">    b = 1</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">test_source_code</span>
    check_split_file(<span class="Type">SOURCE_CODE</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SOURCE_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>)) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;pre class='code'&gt;</span><span class="Special">\n</span><span class="Special">#{</span><span class="Type">SOURCE_CODE</span><span class="Special">}</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span>
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

  <span class="Type">ISLAND_CODE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">    a = b</span>
<span class="Constant">    b = 1</span>
<span class="Constant">    HTML = &lt;&lt;-</span><span class="Special">EOH</span>.unindent <span class="Comment"># ((( html</span>
</pre>
<pre class='html code syntax'>
      <span class="Identifier">&lt;</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
      HTML
      <span class="Identifier">&lt;/</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
    EOH
</pre>
<pre class='ruby code syntax'>
    <span class="Comment"># ))) html</span>
  <span class="Type">EOF</span>

  <span class="Type">ISLAND_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;pre class='ruby code syntax'&gt;</span>
<span class="Constant">    a = b</span>
<span class="Constant">    b = &lt;span class=&quot;Constant&quot;&gt;1&lt;/span&gt;</span>
<span class="Constant">    &lt;span class=&quot;Type&quot;&gt;HTML&lt;/span&gt; = &amp;lt;&amp;lt;-&lt;span class=&quot;Special&quot;&gt;EOH&lt;/span&gt;.unindent &lt;span class=&quot;Comment&quot;&gt;# ((( html&lt;/span&gt;</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'html code syntax'</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span><span class="Special">&amp;lt;</span><span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Statement&quot;</span><span class="Identifier">&gt;</span>p<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span><span class="Special">&amp;gt;</span><span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
      HTML
      <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span><span class="Special">&amp;lt;</span>/<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Statement&quot;</span><span class="Identifier">&gt;</span>p<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span><span class="Special">&amp;gt;</span><span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
    EOH
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'ruby code syntax'</span><span class="Identifier">&gt;</span>
</pre>
<pre class='ruby code syntax'>
    &lt;span <span class="PreProc">class</span>=&quot;<span class="Type">Comment</span>&quot;&gt;<span class="Comment"># ))) html&lt;/span&gt;</span>
    &lt;/pre&gt;
  <span class="Type">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">test_island_code</span>
    check_split_file(<span class="Type">ISLAND_CODE</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SOURCE_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>),
                                  <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_GVIM_CSS</span>.call(<span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>),
                                  <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_NESTED_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>),
                                  <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_GVIM_CSS</span>.call(<span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>)) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Type">ISLAND_HTML</span>
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<h4>Classifying comment lines</h4>
<p>
Classifying comment lines is the most complex part of splitting source code
files, requiring the use of one or more configurations specific to the language
used.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-configuration-comments-rb">
<span>lib/codnar/configuration/comments.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

  <span class="PreProc">module</span> <span class="Type">Configuration</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Configurations for splitting source code with comments.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">module</span> <span class="Type">Comments</span>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#simple-comment-classification-configurations'>Simple comment classification configurations</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#denoted-comment-classification-configurations'>Denoted comment classification configurations</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#delimited-comment-classification-configurations'>Delimited comment classification configurations</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#comment-formatting-configurations'>Comment formatting configurations</a>
</pre>
<pre class='ruby code syntax'>

    end

  end

end
</pre>
</div>
</div>
</p>
<h5>Simple comment classification</h5>
<p>
Many languages use a simple comment syntax, where some prefix indicates a
comment that spans until the end of the line (e.g., shell <code>#</code> comments or C++
<code>//</code> comments).
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="simple-comment-classification-configurations">
<span>Simple comment classification configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify simple comment lines. It accepts a restricted format: each comment
is expected to start with some exact prefix (e.g. “#” for shell style
comments or “//” for C++ style comments). The following space, if any,
is stripped from the payload. As a convenience, comment that starts with
“!” is not taken to start a comment. This both protects the 1st line of
shell scripts (“#!”), and also any other line you wish to avoid being
treated as a comment.
</p>
<p>
This configuration is typically complemented by an additional one
specifying how to format the (stripped!) comments; by default they are just
displayed as-is using an HTML <code>pre</code> element, which isn’t very
useful.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_SIMPLE_COMMENTS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">prefix</span>|
  <span class="Statement">return</span> <span class="Type">Comments</span>.simple_comments(prefix)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify simple shell (“#”) comment lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_SHELL_COMMENTS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span>
  <span class="Statement">return</span> <span class="Type">Comments</span>.simple_comments(<span class="Special">&quot;</span><span class="Constant">#</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify simple C++ (“//”) comment lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_CPP_COMMENTS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span>
  <span class="Statement">return</span> <span class="Type">Comments</span>.simple_comments(<span class="Special">&quot;</span><span class="Constant">//</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Configuration for classifying lines to comments and code based on a simple
prefix (e.g. “#” for shell style comments or “//” for C++ style
comments).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">simple_comments</span>(prefix)
  <span class="Statement">return</span> {
    <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">comment_</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Constant">(?!!)</span><span class="Special">\\</span><span class="Constant">s?(.*)$</span><span class="Special">&quot;</span> },
      },
      <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> },
            []
          ],
        },
      },
    },
  }
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-comments-rb">lib/codnar/configuration/comments.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
Here is a simple test demonstrating using simple comment classifications:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-simple-comment-configurations-rb">
<span>test/split_simple_comment_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test built-in split simple comment configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitSimpleCommentsConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="PreProc">def</span> <span class="Identifier">test_custom_comments</span>
    check_any_comment(<span class="Special">&quot;</span><span class="Constant">!</span><span class="Special">&quot;</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SIMPLE_COMMENTS</span>.call(<span class="Special">&quot;</span><span class="Constant">!</span><span class="Special">&quot;</span>))
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_shell_comments</span>
    check_any_comment(<span class="Special">&quot;</span><span class="Constant">#</span><span class="Special">&quot;</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SHELL_COMMENTS</span>.call)
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_cpp_comments</span>
    check_any_comment(<span class="Special">&quot;</span><span class="Constant">//</span><span class="Special">&quot;</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_CPP_COMMENTS</span>.call)
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
The “?” will be replaced by the simple comment prefix.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Type">ANY_COMMENT_CODE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">    ?</span>
<span class="Constant">    ? Comment</span>
<span class="Constant">    Code</span>
<span class="Constant">    ?! Not comment</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">check_any_comment</span>(prefix, configuration)
    check_split_file(<span class="Type">ANY_COMMENT_CODE</span>.gsub(<span class="Special">&quot;</span><span class="Constant">?</span><span class="Special">&quot;</span>, prefix),
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SOURCE_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">any</span><span class="Special">&quot;</span>),
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_PRE_COMMENTS</span>,
                     configuration) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;pre class='comment'&gt;</span><span class="Special">\n\n</span><span class="Constant">Comment</span><span class="Special">\n</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">\n</span><span class="Constant">&lt;pre class='code'&gt;</span><span class="Special">\n</span><span class="Constant">Code</span><span class="Special">\n</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Constant">! Not comment</span><span class="Special">\n</span><span class="Constant">&lt;/pre&gt;</span><span class="Special">&quot;</span>
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

end
</pre>
</div>
</div>
</p>
<h5>Denoted comment classification</h5>
<p>
Sometimes some simple comments require special treatment if they are denoted by
some leading prefix. For example, Haskell simple comments start with <code>--</code> but
Haddock (documentation) comments start with <code>-- |</code>, <code>-- ^</code> etc.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="denoted-comment-classification-configurations">
<span>Denoted comment classification configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify denoted comment lines. Denoted comments are similar to simple
comments, except that the 1st simple comment line must start with a
specific prefix (e.g., in haddock, comment lines start with ‘–’ but
haddoc comments start with ‘– |’, ‘– ^’, etc.). The comment
continues in additional simple comment lines.
</p>
<p>
This configuration is typically complemented by an additional one
specifying how to format the (stripped!) comments; by default they are just
displayed as-is using an HTML <code>pre</code> element, which isn’t very
useful.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_DENOTED_COMMENTS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">start_prefix</span>, <span class="Identifier">continue_prefix</span>|
  <span class="Statement">return</span> <span class="Type">Comments</span>.denoted_comments(start_prefix, continue_prefix)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify denoted haddock (“–”) comment lines. Note that non-haddock
comment lines are not captured; they would treated as code and handled by
syntax highlighting, if any.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_HADDOCK_COMMENTS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span>
  <span class="Statement">return</span> <span class="Type">Comments</span>.denoted_comments(<span class="Special">&quot;</span><span class="Constant">-- [|^$]</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">--</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Configuration for classifying lines to comments and code based on a start
comment prefix and continuation comment prefix (e.g., “– |” and
“–” for haddock).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">denoted_comments</span>(start_prefix, continue_prefix)
</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Ruby coverage somehow barfs if we inline this. Go figure.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  start_transition = {
    <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_start_</span><span class="Special">#{</span>start_prefix<span class="Special">}</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">next_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_continue_</span><span class="Special">#{</span>continue_prefix<span class="Special">}</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>
  }
  <span class="Statement">return</span> {
    <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">comment_start_</span><span class="Special">#{</span>start_prefix<span class="Special">}</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">#{</span>start_prefix<span class="Special">}</span><span class="Special">\\</span><span class="Constant">s?(.*)$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Constant">comment_continue_</span><span class="Special">#{</span>continue_prefix<span class="Special">}</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">#{</span>continue_prefix<span class="Special">}</span><span class="Special">\\</span><span class="Constant">s?(.*)$</span><span class="Special">&quot;</span> },
      },
      <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [ start_transition, [] ],
        },
        <span class="Special">&quot;</span><span class="Constant">comment_continue_</span><span class="Special">#{</span>continue_prefix<span class="Special">}</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [ {
              <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_continue_</span><span class="Special">#{</span>continue_prefix<span class="Special">}</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> },
            { <span class="Special">&quot;</span><span class="Constant">next_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> }
          ],
        },
      },
    },
  }
end

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-comments-rb">lib/codnar/configuration/comments.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
Here is a simple test demonstrating using denoted comment classifications:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-denoted-comment-configurations-rb">
<span>test/split_denoted_comment_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test built-in split denoted comment configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitDenotedCommentsConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="PreProc">def</span> <span class="Identifier">test_custom_comments</span>
    check_any_comment(<span class="Special">&quot;</span><span class="Constant">// @</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">//</span><span class="Special">&quot;</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_DENOTED_COMMENTS</span>.call(<span class="Special">&quot;</span><span class="Constant">// @</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">//</span><span class="Special">&quot;</span>))
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_haddoc_comments</span>
    check_any_comment(<span class="Special">&quot;</span><span class="Constant">-- |</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">--</span><span class="Special">&quot;</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_HADDOCK_COMMENTS</span>.call)
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
The “&lt;&lt;&lt;” will be replaced by the start comment prefix, and
the “&gt;&gt;&gt;” will be replaced by the continue comment prefix.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Type">ANY_COMMENT_CODE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">    &gt;&gt;&gt; Not start comment</span>
<span class="Constant">    &lt;&lt;&lt; Start comment</span>
<span class="Constant">    &gt;&gt;&gt; Continue comment</span>
<span class="Constant">    Not a comment</span>
<span class="Constant">  </span><span class="Special">EOF</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
The “&gt;&gt;&gt;” will be replaced by the continue comment prefix.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Type">ANY_COMMENT_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp <span class="Comment"># ((( html</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'code'</span><span class="Identifier">&gt;</span>
    <span class="Error">&gt;&gt;&gt;</span> Not start comment
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'comment'</span><span class="Identifier">&gt;</span>
    Start comment
    Continue comment
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'code'</span><span class="Identifier">&gt;</span>
    Not a comment
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
  EOF
  # )))

  def check_any_comment(start_prefix, continue_prefix, configuration)
    check_split_file(ANY_COMMENT_CODE.gsub(&quot;<span class="Identifier">&lt;</span><span class="Error">&lt;</span><span class="Identifier">&lt;</span><span class="Constant">&quot;, start_prefix).gsub(&quot;</span><span class="Identifier">&gt;</span><span class="Error">&gt;&gt;</span>&quot;, continue_prefix),
                     Codnar::Configuration::CLASSIFY_SOURCE_CODE.call(&quot;any&quot;),
                     Codnar::Configuration::FORMAT_PRE_COMMENTS,
                     configuration) do |path|
      [ {
        &quot;name&quot; =<span class="Error">&gt;</span> path,
        &quot;locations&quot; =<span class="Error">&gt;</span> [ { &quot;file&quot; =<span class="Error">&gt;</span> path, &quot;line&quot; =<span class="Error">&gt;</span> 1 } ],
        &quot;containers&quot; =<span class="Error">&gt;</span> [],
        &quot;contained&quot; =<span class="Error">&gt;</span> [],
        &quot;html&quot; =<span class="Error">&gt;</span> ANY_COMMENT_HTML.gsub(&quot;<span class="Error">&gt;&gt;&gt;</span>&quot;, continue_prefix),
      } ]
    end
  end

end
</pre>
</div>
</div>
</p>
<h5>Delimited comment classification</h5>
<p>
Other languages use a delimited multi-line comment syntax, where some prefix
indicates the beginning of the comment, some suffix indicates the end, and by
convention some prefix is expected for the inner comment lines (e.g., C's
"<code>/*</code>", "<code>*</code>", "<code>*/</code>" comments or HTML's "<code>&lt;!--</code>", "<code>-</code>", "<code>--&gt;</code>" comments).
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="delimited-comment-classification-configurations">
<span>Delimited comment classification configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify delimited comment lines. It accepts a restricted format: each
comment is expected to start with some exact prefix (e.g. “/*” for C
style comments or “&lt;!–” for HTML style comments). The following
space, if any, is stripped from the payload. Following lines are also
considered comments; a leading inner line prefix (e.g., “ *” for C
style comments or “ -” for HTML style comments) with an optional
following space are stripped from the payload. Finally, a line containing
some exact suffix (e.g. “*/” for C style comments, or “–&gt;” for
HTML style comments) ends the comment. A one line comment format is also
supported containing the prefix, the payload, and the suffix. As a
convenience, comment that starts with “!” is not taken to start a
comment. This allows protecting comment block you wish to avoid being
classified as a comment.
</p>
<p>
This configuration is typically complemented by an additional one
specifying how to format the (stripped!) comments; by default they are just
displayed as-is using an HTML <code>pre</code> element, which isn’t very
useful.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_DELIMITED_COMMENTS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">prefix</span>, <span class="Identifier">inner</span>, <span class="Identifier">suffix</span>|
  <span class="Statement">return</span> <span class="Type">Comments</span>.delimited_comments(prefix, inner, suffix)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify delimited C (“/*”, “ *”, “ */”) style comments.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_C_COMMENTS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span>
</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Since the prefix/inner/suffix passed to the configuration are regexps, we
need to escape special characters such as “*”.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Statement">return</span> <span class="Type">Comments</span>.delimited_comments(<span class="Special">&quot;</span><span class="Constant">/</span><span class="Special">\\</span><span class="Constant">*</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">\\</span><span class="Constant">*</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">\\</span><span class="Constant">*/</span><span class="Special">&quot;</span>)
end

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Classify delimited HTML (“&lt;!–”, “ -”, “–&gt;”) style
comments.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CLASSIFY_HTML_COMMENTS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span>
  <span class="Statement">return</span> <span class="Type">Comments</span>.delimited_comments(<span class="Special">&quot;</span><span class="Constant">&lt;!--</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> -</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">--&gt;</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Configuration for classifying lines to comments and code based on a
delimited start prefix, inner line prefix and final suffix (e.g., “/*”,
“ *”, “ */” for C-style comments or “&lt;!–”, “ -”,
“–&gt;” for HTML style comments).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">delimited_comments</span>(prefix, inner, suffix)
  <span class="Statement">return</span> {
    <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">comment_prefix_</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Constant">(?!!)</span><span class="Special">\\</span><span class="Constant">s?(.*)$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Constant">comment_inner_</span><span class="Special">#{</span>inner<span class="Special">}</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">#{</span>inner<span class="Special">}</span><span class="Special">\\</span><span class="Constant">s?(.*)$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Constant">comment_suffix_</span><span class="Special">#{</span>suffix<span class="Special">}</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">#{</span>suffix<span class="Special">}</span><span class="Special">\\</span><span class="Constant">s*$</span><span class="Special">&quot;</span> },
        <span class="Special">&quot;</span><span class="Constant">comment_line_</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Constant">_</span><span class="Special">#{</span>suffix<span class="Special">}</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Constant">(?!!)</span><span class="Special">\s</span><span class="Constant">?(.*?)</span><span class="Special">\s</span><span class="Constant">*</span><span class="Special">#{</span>suffix<span class="Special">}</span><span class="Special">\\</span><span class="Constant">s*$</span><span class="Special">&quot;</span> },
      },
      <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_line_</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Constant">_</span><span class="Special">#{</span>suffix<span class="Special">}</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> },
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_prefix_</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">next_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Special">&quot;</span> },
            [],
          ],
        },
        <span class="Special">&quot;</span><span class="Constant">comment_</span><span class="Special">#{</span>prefix<span class="Special">}</span><span class="Special">&quot;</span> =&gt; {
          <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_suffix_</span><span class="Special">#{</span>suffix<span class="Special">}</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">next_state</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> },
            { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment_inner_</span><span class="Special">#{</span>inner<span class="Special">}</span><span class="Special">&quot;</span>,
              <span class="Special">&quot;</span><span class="Constant">kind</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> },
          ],
        },
      },
    },
  }
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-comments-rb">lib/codnar/configuration/comments.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
Here is a simple test demonstrating using delimited comment classifications:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-delimited-comment-configurations-rb">
<span>test/split_delimited_comment_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test built-in split delimited comment configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitDelimitedCommentsConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="PreProc">def</span> <span class="Identifier">test_custom_comments</span>
</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Since the prefix/inner/suffix passed to the configuration are regexps, we
need to escape special characters such as “{” and “|”.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    check_any_comment([ <span class="Special">&quot;</span><span class="Constant">@{</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> |</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> }@</span><span class="Special">&quot;</span> ], <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_DELIMITED_COMMENTS</span>.call(<span class="Special">&quot;</span><span class="Constant">@</span><span class="Special">\\</span><span class="Constant">{</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">\\</span><span class="Constant">|</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">\\</span><span class="Constant">}@</span><span class="Special">&quot;</span>))
  end

  <span class="PreProc">def</span> <span class="Identifier">test_c_comments</span>
    check_any_comment([ <span class="Special">&quot;</span><span class="Constant">/*</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> *</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> */</span><span class="Special">&quot;</span> ], <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_C_COMMENTS</span>.call)
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_html_comments</span>
    check_any_comment([ <span class="Special">&quot;</span><span class="Constant">&lt;!--</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> -</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">--&gt;</span><span class="Special">&quot;</span> ], <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_HTML_COMMENTS</span>.call)
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
The “&lt;&lt;&lt;” will be replaced by the start comment prefix, the
“&lt;&gt;” will be replaced by the inner line comment prefix, and the
“&gt;&gt;&gt;” will be replaced by the end comment suffix.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Type">ANY_COMMENT_CODE</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">    &lt;&lt;&lt; One-line comment &gt;&gt;&gt;</span>
<span class="Constant">    Code</span>
<span class="Constant">    &lt;&lt;&lt;</span>
<span class="Constant">    &lt;&gt; Multi-line</span>
<span class="Constant">    &lt;&gt; comment.</span>
<span class="Constant">    &gt;&gt;&gt;</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="Type">ANY_COMMENT_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp <span class="Comment"># ((( html</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'comment'</span><span class="Identifier">&gt;</span>
    One-line comment
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'code'</span><span class="Identifier">&gt;</span>
    Code
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'comment'</span><span class="Identifier">&gt;</span>

    Multi-line
    comment.

    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
  EOF
  # )))

  def check_any_comment(patterns, configuration)
    prefix, inner, suffix = patterns
    check_split_file(ANY_COMMENT_CODE.gsub(&quot;<span class="Identifier">&lt;</span><span class="Error">&lt;</span><span class="Identifier">&lt;</span><span class="Constant">&quot;, prefix).gsub(&quot;</span><span class="Identifier">&gt;</span><span class="Error">&gt;&gt;</span>&quot;, suffix).gsub(&quot;<span class="Identifier">&lt;&gt;</span><span class="Constant">&quot;, inner),</span>
<span class="Constant">                     Codnar::Configuration::CLASSIFY_SOURCE_CODE.call(&quot;</span><span class="Identifier">any</span><span class="Constant">&quot;),</span>
<span class="Constant">                     Codnar::Configuration::FORMAT_PRE_COMMENTS,</span>
<span class="Constant">                     configuration) do |path|</span>
<span class="Constant">      [ {</span>
<span class="Constant">        &quot;</span><span class="Type">name</span><span class="Constant">&quot; =&gt; path,</span>
<span class="Constant">        &quot;</span><span class="Identifier">locations</span><span class="Constant">&quot; =&gt; [ { &quot;</span><span class="Identifier">file</span><span class="Constant">&quot; =&gt; path, &quot;</span><span class="Identifier">line</span><span class="Constant">&quot; =&gt; 1 } ],</span>
<span class="Constant">        &quot;</span><span class="Identifier">containers</span><span class="Constant">&quot; =&gt; [],</span>
<span class="Constant">        &quot;</span><span class="Identifier">contained</span><span class="Constant">&quot; =&gt; [],</span>
<span class="Constant">        &quot;</span><span class="Identifier">html</span><span class="Constant">&quot; =&gt; ANY_COMMENT_HTML.gsub(&quot;</span><span class="Identifier">/--</span><span class="Constant">&quot;, prefix).gsub(&quot;</span><span class="Identifier">--/</span><span class="Constant">&quot;, suffix).gsub(&quot;</span><span class="Identifier"> -</span><span class="Constant">&quot;, inner),</span>
<span class="Constant">      } ]</span>
<span class="Constant">    end</span>
<span class="Constant">  end</span>

<span class="Constant">end</span>
</pre>
</div>
</div>
</p>
<h4>Comment formatting</h4>
<p>
In many cases, the text inside comments is written using some markup format
(e.g., RDoc for Ruby or JavaDoc for Java). Currently, two such formats are
supported, as well as simply wrapping the comment in an HTML pre element:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="comment-formatting-configurations">
<span>Comment formatting configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format comments as HTML pre elements. Is used to complement a configuration
that classifies some lines as <code>comment</code>.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_PRE_COMMENTS</span> = {
  <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
    <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.lines_to_pre_html(lines, :class =&gt; :comment)</span><span class="Special">&quot;</span>,
  },
}

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format comments that use the RDoc notation. Is used to complement a
configuration that classifies some lines as <code>comment</code>.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_RDOC_COMMENTS</span> = {
  <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
    <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Codnar::RDoc, 'rdoc')</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.unindented_lines_to_html(lines)</span><span class="Special">&quot;</span>,
  },
}

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format comments that use the Markdown notation. Is used to complement a
configuration that classifies some lines as <code>comment</code>.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_MARKDOWN_COMMENTS</span> = {
  <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
    <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Markdown, 'markdown')</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.unindented_lines_to_html(lines)</span><span class="Special">&quot;</span>,
  },
}

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format comments that use the Haddock notation. Is used to complement a
configuration that classifies some lines as <code>comment</code>.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_HADDOCK_COMMENTS</span> = {
  <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
    <span class="Special">&quot;</span><span class="Constant">comment</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.markup_lines_to_html(lines, Haddock, 'haddock')</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">unindented_html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.unindented_lines_to_html(lines)</span><span class="Special">&quot;</span>,
  },
}

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-comments-rb">lib/codnar/configuration/comments.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
Here is a simple test demonstrating formatting comment contents:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-format-comment-configurations-rb">
<span>test/format_comment_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test built-in split comment formatting configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestFormatCommentsConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="Type">COMMENT_TEXT</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.gsub(<span class="Special">&quot;</span><span class="Constant">#!</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">#</span><span class="Special">&quot;</span>)
<span class="Constant">    #! Comment *text*.</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="Type">PRE_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;pre class='comment'&gt;</span>
<span class="Constant">    Comment *text*.</span>
<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">test_pre_comments</span>
    check_any_format(<span class="Type">PRE_HTML</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_PRE_COMMENTS</span>)
  <span class="PreProc">end</span>

  <span class="Type">RDOC_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;table class='layout'&gt;</span>
<span class="Constant">    &lt;tr&gt;</span>
<span class="Constant">    &lt;td class='indentation'&gt;</span>
<span class="Constant">    &lt;pre&gt;&lt;/pre&gt;</span>
<span class="Constant">    &lt;/td&gt;</span>
<span class="Constant">    &lt;td class='html'&gt;</span>
<span class="Constant">    &lt;div class='rdoc comment markup'&gt;</span>
<span class="Constant">    &lt;p&gt;</span>
<span class="Constant">    Comment &lt;strong&gt;text&lt;/strong&gt;.</span>
<span class="Constant">    &lt;/p&gt;</span>
<span class="Constant">    &lt;/div&gt;</span>
<span class="Constant">    &lt;/td&gt;</span>
<span class="Constant">    &lt;/tr&gt;</span>
<span class="Constant">    &lt;/table&gt;</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">test_rdoc_comments</span>
    check_any_format(<span class="Type">RDOC_HTML</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_RDOC_COMMENTS</span>)
  <span class="PreProc">end</span>

  <span class="Type">MARKDOWN_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;table class='layout'&gt;</span>
<span class="Constant">    &lt;tr&gt;</span>
<span class="Constant">    &lt;td class='indentation'&gt;</span>
<span class="Constant">    &lt;pre&gt;&lt;/pre&gt;</span>
<span class="Constant">    &lt;/td&gt;</span>
<span class="Constant">    &lt;td class='html'&gt;</span>
<span class="Constant">    &lt;div class='markdown comment markup'&gt;</span>
<span class="Constant">    &lt;p&gt;</span>
<span class="Constant">    Comment &lt;em&gt;text&lt;/em&gt;.</span>
<span class="Constant">    &lt;/p&gt;</span>
<span class="Constant">    &lt;/div&gt;</span>
<span class="Constant">    &lt;/td&gt;</span>
<span class="Constant">    &lt;/tr&gt;</span>
<span class="Constant">    &lt;/table&gt;</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">test_markdown_comments</span>
    check_any_format(<span class="Type">MARKDOWN_HTML</span>, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_MARKDOWN_COMMENTS</span>)
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

  <span class="PreProc">def</span> <span class="Identifier">check_any_format</span>(html, configuration)
    check_split_file(<span class="Type">COMMENT_TEXT</span>,
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SOURCE_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">any</span><span class="Special">&quot;</span>),
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SHELL_COMMENTS</span>.call,
                     configuration) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; html,
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<h4>Syntax highlighting</h4>
<p>
Highlighting the syntax of the source code embedded in the documentation
improved readability. Codnar provides several ways to achieve this.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-configuration-highlighting-rb">
<span>lib/codnar/configuration/highlighting.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

  <span class="PreProc">module</span> <span class="Type">Configuration</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Configurations for highlighting source code lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">module</span> <span class="Type">Highlighting</span>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#gvim-syntax-highlighting-formatting-configurations'>GVim syntax highlighting formatting configurations</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#coderay-syntax-highlighting-formatting-configurations'>CodeRay syntax highlighting formatting configurations</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#sunlight-syntax-highlighting-formatting-configurations'>Sunlight syntax highlighting formatting configurations</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
      <a class='nested chunk' href='#chunk-splitting-configurations'>Chunk splitting configurations</a>
</pre>
<pre class='ruby code syntax'>

    end

  end

end
</pre>
</div>
</div>
</p>
<h5>Syntax highlighting using GVim</h5>
<p>
Supporting almost any known programming language (other than dealing with
comments) is very easy using GVim for syntax highlighting, as demonstrated
here:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="gvim-syntax-highlighting-formatting-configurations">
<span>GVim syntax highlighting formatting configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format code using GVim’s syntax highlighting, using explicit HTML
constructs. Assumes some previous configuration already classified the code
lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_CODE_GVIM_HTML</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">syntax</span>|
  <span class="Statement">return</span> <span class="Type">Highlighting</span>.klass_code_format(<span class="Special">'</span><span class="Constant">GVim</span><span class="Special">'</span>, syntax, <span class="Special">&quot;</span><span class="Constant">[]</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format code using GVim’s syntax highlighting, using CSS classes instead
of explicit font and color styles. Assumes some previous configuration
already classified the code lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_CODE_GVIM_CSS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">syntax</span>|
  <span class="Statement">return</span> <span class="Type">Highlighting</span>.klass_code_format(<span class="Special">'</span><span class="Constant">GVim</span><span class="Special">'</span>, syntax, <span class="Special">&quot;</span><span class="Constant">[ '+:let html_use_css=1' ]</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return a configuration for highlighting a specific syntax using GVim.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">klass_code_format</span>(klass, syntax, options)
  <span class="Statement">return</span> {
    <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant">_code</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Special">#{</span>klass<span class="Special">}</span><span class="Constant">.lines_to_html(lines, '</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant">', </span><span class="Special">#{</span>options<span class="Special">}</span><span class="Constant">)</span><span class="Special">&quot;</span>,
    },
  }
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-highlighting-rb">lib/codnar/configuration/highlighting.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
If you choose to use CSS classes instead of directly embedding fonts and colors
into the generated HTML, you will need a CSS stylesheet with the relevant
classes. Here is the default CSS stylesheet used by GVim:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-data-gvim-css">
<span>lib/codnar/data/gvim.css</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Colors for GVim classes
</p>
</div>
</td>
</tr>
</table>
<pre class='css code syntax'>
<span class="Statement">span</span><span class="Identifier">.Constant</span>   <span class="Identifier">{</span> <span class="Type">color</span>: Crimson; <span class="Identifier">}</span>
<span class="Statement">span</span><span class="Identifier">.Identifier</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">Teal</span>; <span class="Identifier">}</span>
<span class="Statement">span</span><span class="Identifier">.PreProc</span>    <span class="Identifier">{</span> <span class="Type">color</span>: Indigo; <span class="Identifier">}</span>
<span class="Statement">span</span><span class="Identifier">.Special</span>    <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">Navy</span>; <span class="Identifier">}</span>
<span class="Statement">span</span><span class="Identifier">.Statement</span>  <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">Maroon</span>; <span class="Identifier">}</span>
<span class="Statement">span</span><span class="Identifier">.Type</span>       <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">Green</span>; <span class="Identifier">}</span>
<span class="Statement">span</span><span class="Identifier">.Comment</span>    <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">Purple</span>; <span class="Identifier">}</span>
</pre>
</div>
</div>
</p>
<h5>Syntax highlighting using CodeRay</h5>
<p>
For supported programming languages, you may choose to use CodeRay instead of GVim.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="coderay-syntax-highlighting-formatting-configurations">
<span>CodeRay syntax highlighting formatting configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format code using CodeRay’s syntax highlighting, using explicit HTML
constructs. Assumes some previous configuration already classified the code
lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_CODE_CODERAY_HTML</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">syntax</span>|
  <span class="Statement">return</span> <span class="Type">Highlighting</span>.klass_code_format(<span class="Special">'</span><span class="Constant">CodeRay</span><span class="Special">'</span>, syntax, <span class="Special">&quot;</span><span class="Constant">{}</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format code using CodeRay’s syntax highlighting, using CSS classes
instead of explicit font and color styles. Assumes some previous
configuration already classified the code lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_CODE_CODERAY_CSS</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">syntax</span>|
  <span class="Statement">return</span> <span class="Type">Highlighting</span>.klass_code_format(<span class="Special">'</span><span class="Constant">CodeRay</span><span class="Special">'</span>, syntax, <span class="Special">&quot;</span><span class="Constant">{ :css =&gt; :class }</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-highlighting-rb">lib/codnar/configuration/highlighting.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
If you choose to use CSS classes instead of directly embedding fonts and colors
into the generated HTML, you will need a CSS stylesheet with the relevant
classes. Here is the default CSS stylesheet used by CodeRay:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-data-coderay-css">
<span>lib/codnar/data/coderay.css</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Extracted from CodeRay output
</p>
</div>
</td>
</tr>
</table>
<pre class='css code syntax'>

<span class="Identifier">.CodeRay</span> <span class="Identifier">.line-numbers</span> <span class="Statement">a</span> <span class="Identifier">{</span>
  <span class="Type">text-decoration</span>: <span class="Type">inherit</span>;
  <span class="Type">color</span>: <span class="Type">inherit</span>;
<span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">{</span>
  <span class="Type">background-color</span>: hsl(<span class="Constant">0</span>,<span class="Constant">0%</span>,<span class="Constant">95%</span>);
  <span class="Type">border</span>: <span class="Constant">1px</span> <span class="Type">solid</span> <span class="Constant">silver</span>;
  <span class="Type">color</span>: <span class="Constant">black</span>;
<span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Statement">pre</span> <span class="Identifier">{</span>
  <span class="Type">margin</span>: <span class="Constant">0px</span>;
<span class="Identifier">}</span>

<span class="Statement">span</span><span class="Identifier">.CodeRay</span> <span class="Identifier">{</span> <span class="Type">white-space</span>: <span class="Type">pre</span>; <span class="Type">border</span>: <span class="Constant">0px</span>; <span class="Type">padding</span>: <span class="Constant">2px</span>; <span class="Identifier">}</span>

<span class="Statement">table</span><span class="Identifier">.CodeRay</span> <span class="Identifier">{</span> <span class="Type">border-collapse</span>: <span class="Type">collapse</span>; <span class="Type">width</span>: <span class="Constant">100%</span>; <span class="Type">padding</span>: <span class="Constant">2px</span>; <span class="Identifier">}</span>
<span class="Statement">table</span><span class="Identifier">.CodeRay</span> <span class="Statement">td</span> <span class="Identifier">{</span> <span class="Type">padding</span>: <span class="Constant">2px</span> <span class="Constant">4px</span>; <span class="Type">vertical-align</span>: <span class="Type">top</span>; <span class="Identifier">}</span>

<span class="Identifier">.CodeRay</span> <span class="Identifier">.line-numbers</span> <span class="Identifier">{</span>
  <span class="Type">background-color</span>: hsl(<span class="Constant">180</span>,<span class="Constant">65%</span>,<span class="Constant">90%</span>);
  <span class="Type">color</span>: <span class="Constant">gray</span>;
  <span class="Type">text-align</span>: <span class="Type">right</span>;
  -webkit-user-select: <span class="Type">none</span>;
  -moz-user-select: <span class="Type">none</span>;
  user-select: <span class="Type">none</span>;
<span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.line-numbers</span> <span class="Statement">a</span> <span class="Identifier">{</span>
  <span class="Type">background-color</span>: hsl(<span class="Constant">180</span>,<span class="Constant">65%</span>,<span class="Constant">90%</span>) <span class="Special">!important</span>;
  <span class="Type">color</span>: <span class="Constant">gray</span> <span class="Special">!important</span>;
  <span class="Type">text-decoration</span>: <span class="Type">none</span> <span class="Special">!important</span>;
<span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.line-numbers</span> <span class="Statement">a</span>:target <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">blue</span> <span class="Special">!important</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.line-numbers</span> <span class="Identifier">.highlighted</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">red</span> <span class="Special">!important</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.line-numbers</span> <span class="Identifier">.highlighted</span> <span class="Statement">a</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">red</span> <span class="Special">!important</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Statement">span</span><span class="Identifier">.line-numbers</span> <span class="Identifier">{</span> <span class="Type">padding</span>: <span class="Constant">0px</span> <span class="Constant">4px</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.line</span> <span class="Identifier">{</span> <span class="Type">display</span>: <span class="Type">block</span>; <span class="Type">float</span>: <span class="Type">left</span>; <span class="Type">width</span>: <span class="Constant">100%</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.code</span> <span class="Identifier">{</span> <span class="Type">width</span>: <span class="Constant">100%</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.code</span> <span class="Statement">pre</span> <span class="Identifier">{</span> <span class="Type">overflow</span>: <span class="Type">auto</span>; <span class="Identifier">}</span>

<span class="Identifier">.CodeRay</span> <span class="Identifier">.debug</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">white</span> <span class="Special">!important</span>; <span class="Type">background</span>: <span class="Constant">blue</span> <span class="Special">!important</span>; <span class="Identifier">}</span>

<span class="Identifier">.CodeRay</span> <span class="Identifier">.annotation</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#007</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.attribute-name</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#b48</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.attribute-value</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#700</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.binary</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#509</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.char</span> <span class="Identifier">.content</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#D20</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.char</span> <span class="Identifier">.delimiter</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#710</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.char</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#D20</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.class</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#B06</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.class-variable</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#369</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.color</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#0A0</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.comment</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#777</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.comment</span> <span class="Identifier">.char</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#444</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.comment</span> <span class="Identifier">.delimiter</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#444</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.complex</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#A08</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.constant</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#036</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.decorator</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#B0B</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.definition</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#099</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.delimiter</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">black</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.directive</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#088</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.doc</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#970</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.doc-string</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#D42</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.doctype</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#34b</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.entity</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#800</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.error</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#F00</span>; <span class="Type">background-color</span>:<span class="Constant">#FAA</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.escape</span>  <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#666</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.exception</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#C00</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.float</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#60E</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.function</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#06B</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.global-variable</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#d70</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.hex</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#02b</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.imaginary</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#f00</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.include</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#B44</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.inline</span> <span class="Identifier">{</span> <span class="Type">background-color</span>: hsla(<span class="Constant">0</span>,<span class="Constant">0%</span>,<span class="Constant">0%</span>,<span class="Constant">0.07</span>); <span class="Type">color</span>: <span class="Constant">black</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.inline-delimiter</span> <span class="Identifier">{</span> <span class="Type">font-weight</span>: <span class="Type">bold</span>; <span class="Type">color</span>: <span class="Constant">#666</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.instance-variable</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#33B</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.integer</span>  <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#00D</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.key</span> <span class="Identifier">.char</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#60f</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.key</span> <span class="Identifier">.delimiter</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#404</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.key</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#606</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.keyword</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#080</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.label</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#970</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.local-variable</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#963</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.namespace</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#707</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.octal</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#40E</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.operator</span> <span class="Identifier">{</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.predefined</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#369</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.predefined-constant</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#069</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.predefined-type</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#0a5</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.preprocessor</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#579</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.pseudo-class</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#00C</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.regexp</span> <span class="Identifier">.content</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#808</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.regexp</span> <span class="Identifier">.delimiter</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#404</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.regexp</span> <span class="Identifier">.modifier</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#C2C</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.regexp</span> <span class="Identifier">{</span> <span class="Type">background-color</span>:hsla(<span class="Constant">300</span>,<span class="Constant">100%</span>,<span class="Constant">50%</span>,<span class="Constant">0.06</span>); <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.reserved</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#080</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.shell</span> <span class="Identifier">.content</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#2B2</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.shell</span> <span class="Identifier">.delimiter</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#161</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.shell</span> <span class="Identifier">{</span> <span class="Type">background-color</span>:hsla(<span class="Constant">120</span>,<span class="Constant">100%</span>,<span class="Constant">50%</span>,<span class="Constant">0.06</span>); <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.string</span> <span class="Identifier">.char</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#b0b</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.string</span> <span class="Identifier">.content</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#D20</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.string</span> <span class="Identifier">.delimiter</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#710</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.string</span> <span class="Identifier">.modifier</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#E40</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.string</span> <span class="Identifier">{</span> <span class="Type">background-color</span>:hsla(<span class="Constant">0</span>,<span class="Constant">100%</span>,<span class="Constant">50%</span>,<span class="Constant">0.05</span>); <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.symbol</span> <span class="Identifier">.content</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#A60</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.symbol</span> <span class="Identifier">.delimiter</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#630</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.symbol</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#A60</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.tag</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#070</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.type</span> <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#339</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.value</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#088</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.variable</span>  <span class="Identifier">{</span> <span class="Type">color</span>:<span class="Constant">#037</span> <span class="Identifier">}</span>

<span class="Identifier">.CodeRay</span> <span class="Identifier">.insert</span> <span class="Identifier">{</span> <span class="Type">background</span>: hsla(<span class="Constant">120</span>,<span class="Constant">100%</span>,<span class="Constant">50%</span>,<span class="Constant">0.12</span>) <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.delete</span> <span class="Identifier">{</span> <span class="Type">background</span>: hsla(<span class="Constant">0</span>,<span class="Constant">100%</span>,<span class="Constant">50%</span>,<span class="Constant">0.12</span>) <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.change</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#bbf</span>; <span class="Type">background</span>: <span class="Constant">#007</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.head</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#f8f</span>; <span class="Type">background</span>: <span class="Constant">#505</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.head</span> <span class="Identifier">.filename</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">white</span>; <span class="Identifier">}</span>

<span class="Identifier">.CodeRay</span> <span class="Identifier">.delete</span> <span class="Identifier">.eyecatcher</span> <span class="Identifier">{</span> <span class="Type">background-color</span>: hsla(<span class="Constant">0</span>,<span class="Constant">100%</span>,<span class="Constant">50%</span>,<span class="Constant">0.2</span>); <span class="Type">border</span>: <span class="Constant">1px</span> <span class="Type">solid</span> hsla(<span class="Constant">0</span>,<span class="Constant">100%</span>,<span class="Constant">45%</span>,<span class="Constant">0.5</span>); <span class="Type">margin</span>: <span class="Constant">-1px</span>; <span class="Type">border-bottom</span>: <span class="Type">none</span>; <span class="Type">border-top</span>-<span class="Type">left</span>-radius: <span class="Constant">5px</span>; <span class="Type">border-top</span>-<span class="Type">right</span>-radius: <span class="Constant">5px</span>; <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.insert</span> <span class="Identifier">.eyecatcher</span> <span class="Identifier">{</span> <span class="Type">background-color</span>: hsla(<span class="Constant">120</span>,<span class="Constant">100%</span>,<span class="Constant">50%</span>,<span class="Constant">0.2</span>); <span class="Type">border</span>: <span class="Constant">1px</span> <span class="Type">solid</span> hsla(<span class="Constant">120</span>,<span class="Constant">100%</span>,<span class="Constant">25%</span>,<span class="Constant">0.5</span>); <span class="Type">margin</span>: <span class="Constant">-1px</span>; <span class="Type">border-top</span>: <span class="Type">none</span>; <span class="Type">border-bottom</span>-<span class="Type">left</span>-radius: <span class="Constant">5px</span>; <span class="Type">border-bottom</span>-<span class="Type">right</span>-radius: <span class="Constant">5px</span>; <span class="Identifier">}</span>

<span class="Identifier">.CodeRay</span> <span class="Identifier">.insert</span> <span class="Identifier">.insert</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#0c0</span>; <span class="Type">background</span>:<span class="Constant">transparent</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.delete</span> <span class="Identifier">.delete</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#c00</span>; <span class="Type">background</span>:<span class="Constant">transparent</span>; <span class="Type">font-weight</span>:<span class="Type">bold</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.change</span> <span class="Identifier">.change</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#88f</span> <span class="Identifier">}</span>
<span class="Identifier">.CodeRay</span> <span class="Identifier">.head</span> <span class="Identifier">.head</span> <span class="Identifier">{</span> <span class="Type">color</span>: <span class="Constant">#f4f</span> <span class="Identifier">}</span>
</pre>
</div>
</div>
</p>
<h5>Syntax highlighting using Sunlight</h5>
<p>
For small projects in supported languages, you may choose to use Sunlight
instead of GVim.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="sunlight-syntax-highlighting-formatting-configurations">
<span>Sunlight syntax highlighting formatting configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format code using Sunlight’s syntax highlighting. This assumes the HTML
will include and invoke Sunlight’s Javascript file which does the
highlighting on the fly inside the DOM, instead of pre-computing it when
splitting the file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">FORMAT_CODE_SUNLIGHT</span> = <span class="Statement">lambda</span> <span class="Statement">do</span> |<span class="Identifier">syntax</span>|
  <span class="Statement">return</span> <span class="Type">Highlighting</span>.sunlight_code_format(syntax)
<span class="Statement">end</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return a configuration for highlighting a specific syntax using Sunlight.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">sunlight_code_format</span>(syntax)
  <span class="Statement">return</span> {
    <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant">_code</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Sunlight.lines_to_html(lines, '</span><span class="Special">#{</span>syntax<span class="Special">}</span><span class="Constant">')</span><span class="Special">&quot;</span>,
    },
  }
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-highlighting-rb">lib/codnar/configuration/highlighting.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
Here is a simple test demonstrating highlighting code syntax using the
different configurations (GVim, CodeRay, or Sunlight):
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-format-code-configurations-rb">
<span>test/format_code_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test built-in split code formatting configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestFormatCodeConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="PreProc">def</span> <span class="Identifier">test_gvim_html_code</span>
    check_any_code(&lt;&lt;-<span class="Special">EOF</span>.unindent.chomp, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_GVIM_HTML</span>.call(<span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span>))
<span class="Constant">      &lt;div class='c code syntax' bgcolor=\&quot;#ffffff\&quot; text=\&quot;#000000\&quot;&gt;</span>
<span class="Constant">      &lt;font face=\&quot;monospace\&quot;&gt;</span>
<span class="Constant">      &lt;font color=\&quot;#00ff00\&quot;&gt;int&lt;/font&gt;&amp;nbsp;x;&lt;br /&gt;</span>
<span class="Constant">      &lt;/font&gt;</span>
<span class="Constant">      &lt;/div&gt;</span>
<span class="Constant">    </span><span class="Special">EOF</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_gvim_css_code</span>
    check_any_code(&lt;&lt;-<span class="Special">EOF</span>.unindent.chomp, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_GVIM_CSS</span>.call(<span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span>))
<span class="Constant">      &lt;pre class='c code syntax'&gt;</span>
<span class="Constant">      &lt;span class=\&quot;Type\&quot;&gt;int&lt;/span&gt; x;</span>
<span class="Constant">      &lt;/pre&gt;</span>
<span class="Constant">    </span><span class="Special">EOF</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_coderay_html_code</span>
    check_any_code(&lt;&lt;-<span class="Special">EOF</span>.unindent.chomp, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_CODERAY_HTML</span>.call(<span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span>))
<span class="Constant">      &lt;div class=&quot;CodeRay&quot;&gt;</span>
<span class="Constant">        &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span style=&quot;color:#0a5;font-weight:bold&quot;&gt;int&lt;/span&gt; x;&lt;/pre&gt;&lt;/div&gt;</span>
<span class="Constant">      &lt;/div&gt;</span>
<span class="Constant">    </span><span class="Special">EOF</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_coderay_css_code</span>
    check_any_code(&lt;&lt;-<span class="Special">EOF</span>.unindent.chomp, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_CODERAY_CSS</span>.call(<span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span>))
<span class="Constant">      &lt;div class=&quot;CodeRay&quot;&gt;</span>
<span class="Constant">        &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;predefined-type&quot;&gt;int&lt;/span&gt; x;&lt;/pre&gt;&lt;/div&gt;</span>
<span class="Constant">      &lt;/div&gt;</span>
<span class="Constant">    </span><span class="Special">EOF</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_sunlight_code</span>
    check_any_code(&lt;&lt;-<span class="Special">EOF</span>.unindent.chomp, <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_SUNLIGHT</span>.call(<span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span>))
<span class="Constant">      &lt;pre class='sunlight-highlight-c'&gt;</span>
<span class="Constant">      int x;</span>
<span class="Constant">      &lt;/pre&gt;</span>
<span class="Constant">    </span><span class="Special">EOF</span>
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

  <span class="PreProc">def</span> <span class="Identifier">check_any_code</span>(html, configuration)
    check_split_file(<span class="Special">&quot;</span><span class="Constant">int x;</span><span class="Special">\n</span><span class="Special">&quot;</span>,
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SOURCE_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span>),
                     configuration) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; html,
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<h4>Chunk splitting</h4>
<p>
There are many ways to denote code "regions" (which become Codnar chunks). The
following covers GVim's default scheme; others are easily added. It is safest
to merge this configuration as the last of all the combined configurations, to
ensure its patterns end up before any others.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="chunk-splitting-configurations">
<span>Chunk splitting configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Group lines into chunks using VIM-style “{{{”/“}}}” region
designations. Assumes other configurations handle the actual content lines.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">CHUNK_BY_VIM_REGIONS</span> = {
  <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
    <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">[]</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">[]</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">nested_chunk</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.nested_chunk_lines_to_html(lines)</span><span class="Special">&quot;</span>,
  },
  <span class="Special">&quot;</span><span class="Constant">syntax</span><span class="Special">&quot;</span> =&gt; {
    <span class="Special">&quot;</span><span class="Constant">patterns</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">\\</span><span class="Constant">W*</span><span class="Special">\\</span><span class="Constant">{</span><span class="Special">\\</span><span class="Constant">{</span><span class="Special">\\</span><span class="Constant">{</span><span class="Special">\\</span><span class="Constant">s*(.*?)</span><span class="Special">\\</span><span class="Constant">s*$</span><span class="Special">&quot;</span> },
      <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">regexp</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">^(</span><span class="Special">\\</span><span class="Constant">s*)</span><span class="Special">\\</span><span class="Constant">W*</span><span class="Special">\\</span><span class="Constant">}</span><span class="Special">\\</span><span class="Constant">}</span><span class="Special">\\</span><span class="Constant">}</span><span class="Special">\\</span><span class="Constant">s*(.*?)</span><span class="Special">\\</span><span class="Constant">s*$</span><span class="Special">&quot;</span> },
    },
    <span class="Special">&quot;</span><span class="Constant">states</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">start</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">transitions</span><span class="Special">&quot;</span> =&gt; [
          { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">begin_chunk</span><span class="Special">&quot;</span> },
          { <span class="Special">&quot;</span><span class="Constant">pattern</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">end_chunk</span><span class="Special">&quot;</span> },
          [],
        ],
      },
    },
  },
}

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-configuration-highlighting-rb">lib/codnar/configuration/highlighting.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
Here is a simple test demonstrating splitting code chunks:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-chunk-configurations-rb">
<span>test/split_chunk_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test built-in split code formatting configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitChunkConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="Type">CODE_TEXT</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.gsub(<span class="Special">&quot;</span><span class="Constant">#!</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">#</span><span class="Special">&quot;</span>)
<span class="Constant">    int x;</span>
<span class="Constant">    #! {{{ chunk</span>
<span class="Constant">    int y;</span>
<span class="Constant">    #! }}}</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="Type">CODE_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;pre class='code'&gt;</span>
<span class="Constant">    int x;</span>
<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">    &lt;pre class='nested chunk'&gt;</span>
<span class="Constant">    &lt;a class='nested chunk' href='#chunk'&gt;chunk&lt;/a&gt;</span>
<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="Type">CHUNK_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;pre class='code'&gt;</span>
<span class="Constant">    int y;</span>
<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">test_gvim_chunks</span>
    check_split_file(<span class="Type">CODE_TEXT</span>,
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SOURCE_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span>),
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CHUNK_BY_VIM_REGIONS</span>) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span>=&gt; path,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">chunk</span><span class="Special">&quot;</span> ],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>=&gt; <span class="Type">CODE_HTML</span>,
      }, {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">chunk</span><span class="Special">&quot;</span>,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ path ],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Type">CHUNK_HTML</span>,
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<h3>Putting it all together</h3>
<p>
Here is a test demonstrating putting several of the above configurations
together in a meaningful way:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-split-combined-configurations-rb">
<span>test/split_combined_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test_with_configurations</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test combination of many built-in configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestSplitCombinedConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithConfigurations</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

  <span class="Type">CODE_TEXT</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.gsub(<span class="Special">&quot;</span><span class="Constant">#!</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">#</span><span class="Special">&quot;</span>)
<span class="Constant">    #!!/usr/bin/ruby -w</span>

<span class="Constant">    #! {{{ HTML snippet</span>

<span class="Constant">    HELLO_WORLD_IN_HTML = &lt;&lt;-</span><span class="Special">EOH</span>.unindent.chomp <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
      <span class="Identifier">&lt;</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
      Hello, world!
      <span class="Identifier">&lt;/</span><span class="Statement">p</span><span class="Identifier">&gt;</span>
    EOH
</pre>
<pre class='ruby code syntax'>
    <span class="Comment">#! ))) html</span>

    <span class="Comment">#! }}}</span>

    <span class="Comment">#! {{{ Ruby code</span>

    <span class="Comment">#! Hello, *world*!</span>
    puts <span class="Type">HELLO_WORLD_IN_HTML</span>

    <span class="Comment">#! }}}</span>
  <span class="Type">EOF</span>

  <span class="Type">FILE_HTML</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;pre class='ruby code syntax'&gt;</span>
<span class="Constant">    &lt;span class=&quot;PreProc&quot;&gt;#!/usr/bin/ruby -w&lt;/span&gt;</span>

<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">    &lt;pre class='nested chunk'&gt;</span>
<span class="Constant">    &lt;a class='nested chunk' href='#html-snippet'&gt;HTML snippet&lt;/a&gt;</span>
<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">    &lt;pre class='ruby code syntax'&gt;</span>

<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">    &lt;pre class='nested chunk'&gt;</span>
<span class="Constant">    &lt;a class='nested chunk' href='#ruby-code'&gt;Ruby code&lt;/a&gt;</span>
<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="Type">HTML_CHUNK</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;pre class='ruby code syntax'&gt;</span>

<span class="Constant">    &lt;span class=&quot;Type&quot;&gt;HELLO_WORLD_IN_HTML&lt;/span&gt; = &amp;lt;&amp;lt;-&lt;span class=&quot;Special&quot;&gt;EOH&lt;/span&gt;.unindent.chomp &lt;span class=&quot;Comment&quot;&gt;# ((( html&lt;/span&gt;</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'html code syntax'</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span><span class="Special">&amp;lt;</span><span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Statement&quot;</span><span class="Identifier">&gt;</span>p<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span><span class="Special">&amp;gt;</span><span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
      Hello, world!
      <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span><span class="Special">&amp;lt;</span>/<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Statement&quot;</span><span class="Identifier">&gt;</span>p<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span><span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;Identifier&quot;</span><span class="Identifier">&gt;</span><span class="Special">&amp;gt;</span><span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
    EOH
    <span class="Identifier">&lt;/</span><span class="Statement">pre</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">pre</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">'ruby code syntax'</span><span class="Identifier">&gt;</span>
</pre>
<pre class='ruby code syntax'>
    &lt;span <span class="PreProc">class</span>=&quot;<span class="Type">Comment</span>&quot;&gt;<span class="Comment"># ))) html&lt;/span&gt;</span>

    &lt;/pre&gt;
  <span class="Type">EOF</span>

  <span class="Type">RUBY_CHUNK</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent.chomp
<span class="Constant">    &lt;pre class='ruby code syntax'&gt;</span>

<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">    &lt;table class='layout'&gt;</span>
<span class="Constant">    &lt;tr&gt;</span>
<span class="Constant">    &lt;td class='indentation'&gt;</span>
<span class="Constant">    &lt;pre&gt;&lt;/pre&gt;</span>
<span class="Constant">    &lt;/td&gt;</span>
<span class="Constant">    &lt;td class='html'&gt;</span>
<span class="Constant">    &lt;div class='rdoc comment markup'&gt;</span>
<span class="Constant">    &lt;p&gt;</span>
<span class="Constant">    Hello, &lt;strong&gt;world&lt;/strong&gt;!</span>
<span class="Constant">    &lt;/p&gt;</span>
<span class="Constant">    &lt;/div&gt;</span>
<span class="Constant">    &lt;/td&gt;</span>
<span class="Constant">    &lt;/tr&gt;</span>
<span class="Constant">    &lt;/table&gt;</span>
<span class="Constant">    &lt;pre class='ruby code syntax'&gt;</span>
<span class="Constant">    puts &lt;span class=&quot;Type&quot;&gt;HELLO_WORLD_IN_HTML&lt;/span&gt;</span>

<span class="Constant">    &lt;/pre&gt;</span>
<span class="Constant">  </span><span class="Special">EOF</span>

  <span class="PreProc">def</span> <span class="Identifier">test_gvim_chunks</span>
    check_split_file(<span class="Type">CODE_TEXT</span>,
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SOURCE_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>),
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_GVIM_CSS</span>.call(<span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>),
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_NESTED_CODE</span>.call(<span class="Special">&quot;</span><span class="Constant">ruby</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>),
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_CODE_GVIM_CSS</span>.call(<span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span>),
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CLASSIFY_SHELL_COMMENTS</span>.call,
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">FORMAT_RDOC_COMMENTS</span>,
                     <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">CHUNK_BY_VIM_REGIONS</span>) <span class="Statement">do</span> |<span class="Identifier">path</span>|
      [ {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; path, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Type">FILE_HTML</span>,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path } ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">HTML snippet</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">Ruby code</span><span class="Special">&quot;</span> ],
      }, {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">HTML snippet</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Type">HTML_CHUNK</span>,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">3</span>, <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path } ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ path ], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      }, {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Ruby code</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Type">RUBY_CHUNK</span>,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">14</span>, <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; path } ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ path ], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      } ]
    <span class="Statement">end</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<h2>Storing chunks on the disk</h2>

<h3>Writing chunks to disk</h3>
<p>
In any realistic system, the number of source files and chunks will be such
that it makes sense to store the chunks on the disk for further processing.
This allows incorporating the split operation as part of a build tool chain,
and only re-splitting modified files. Here is a simple test demonstrating
writing chunks to the disk:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-write-chunks-rb">
<span>test/write_chunks.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test writing chunks to files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestWriteChunks</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>

  <span class="PreProc">def</span> <span class="Identifier">test_write_chunks</span>
    check_writing_data([])
    check_writing_data(<span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>)
    check_writing_data([ { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> }, { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span> } ])
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_write_invalid_data</span>
    <span class="Statement">lambda</span> { check_writing_data(<span class="Special">&quot;</span><span class="Constant">not a chunk</span><span class="Special">&quot;</span>) }.should.raise
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

  <span class="PreProc">def</span> <span class="Identifier">check_writing_data</span>(data)
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, data)
    data = [ data ] <span class="Statement">unless</span> <span class="Type">Array</span> === data
    <span class="Type">YAML</span>.load_file(<span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>).should == data
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-writer-rb">
<span>lib/codnar/writer.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Write chunks into a disk file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Writer</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Write one chunk or an array of chunks to a disk file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">write</span>(path, data)
      <span class="Constant">self</span>.new(path) <span class="Statement">do</span> |<span class="Identifier">writer</span>|
        writer &lt;&lt; data
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Add one chunk or an array of chunks to the disk file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">&lt;&lt;</span>(data)
      <span class="Statement">case</span> data
      <span class="Statement">when</span> <span class="Type">Array</span>
        <span class="Identifier">@chunks</span> += data
      <span class="Statement">when</span> <span class="Type">Hash</span>
        <span class="Identifier">@chunks</span> &lt;&lt; data
      <span class="Statement">else</span>
        <span class="Statement">raise</span> <span class="Special">&quot;</span><span class="Constant">Invalid data class: </span><span class="Special">#{</span>data.class<span class="Special">}</span><span class="Special">&quot;</span>
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Write chunks into the specified disk file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(path, &amp;block)
      <span class="Identifier">@chunks</span> = []
      <span class="Type">File</span>.open(path, <span class="Special">&quot;</span><span class="Constant">w</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">file</span>|
        block.call(<span class="Constant">self</span>)
        file.print(<span class="Identifier">@chunks</span>.to_yaml)
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h3>Reading chunks to memory</h3>
<p>
Having written the chunks to the disk requires us, at some following point in
time, to read them back into memort. This is the first time we will have a view
of the whole documented system, which allows us to detect several classes of
consistency errors: Some chunks may be left out of the final narrative
(consider this the equivalent of tests code coverage); we may be referring to
missing (or misspelled) chunk names; and, finally, we need to deal with
duplicate chunks.
</p>
<p>
In literate programming, it is trivial to write a chunk once and use it in
several places in the compiled source code. The classical example is C/C++
function signatures that need to appear in both the <code>.h</code> and <code>.c</code>/<code>.cpp</code> files.
However, in some cases this practice makes sense for other pieces of code, and
since the ultimate source code contains only one copy of the chunk, this does
not suffer from the typical copy-and-paste issues.
</p>
<p>
In inverse literate programming, if the same code appears twice (as a result of
copy-and-paste), then it does suffer from the typical copy-and-paste issues.
The most serious of these is, of course, that when only one copy is changed.
The way that Codnar helps alleviate this problem is that if the same chunk
appears more than once in the source code, its content is expected to be
exactly the same in both cases (up to indentation). This should not be viewed
as endorsement of copy-and-paste programming; Using duplicate chunks should be
a last resort measure to combat restrictions in the programming language and
compilation tool chain.
</p>
<h4>Chunk identifiers</h4>
<p>
The above definition raises the obvious question: what does "the same chunk"
mean? As far as Codnar is concerned, a chunk is uniquely identified by its
name, which is specified on the <code>begin_chunk</code> line. The unique identifier is
not the literal name but a transformation of it. This allows us to ignore
capitalization, white space, and any punctuation that may appear in the name.
It also allows us to use the resulting ID as an HTML anchor name, without
worrying about HTML's restictions on such names.
</p>
<p>
Here is a simple test demonstrating converting names to identifiers:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-identify-chunks-rb">
<span>test/identify_chunks.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test converting chunk names to identifiers.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestIdentifyChunks</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_lower_case_to_id</span>
    <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span>.to_id.should == <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_upper_case_to_id</span>
    <span class="Special">&quot;</span><span class="Constant">A</span><span class="Special">&quot;</span>.to_id.should == <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_digits_to_id</span>
    <span class="Special">&quot;</span><span class="Constant">1</span><span class="Special">&quot;</span>.to_id.should == <span class="Special">&quot;</span><span class="Constant">1</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_non_alnum_to_id</span>
    <span class="Special">&quot;</span><span class="Constant">!@-$#</span><span class="Special">&quot;</span>.to_id.should == <span class="Special">&quot;</span><span class="Constant">-</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_complex_to_id</span>
    <span class="Special">&quot;</span><span class="Constant">C# for .NET!</span><span class="Special">&quot;</span>.to_id.should == <span class="Special">&quot;</span><span class="Constant">c-for-net-</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_strip_to_id</span>
    <span class="Special">&quot;</span><span class="Constant"> a </span><span class="Special">&quot;</span>.to_id.should == <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>


<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-string-extensions-rb">
<span>lib/codnar/string_extensions.rb</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Extend the core String class.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">String</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Convert this String to an identifier. This is a stable operation, so
anything that accept a name will also accept an identifier as well.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">def</span> <span class="Identifier">to_id</span>
    <span class="Statement">return</span> <span class="Constant">self</span>.strip.gsub(<span class="Special">/</span><span class="Special">[^</span><span class="Constant">a-zA-Z0-9</span><span class="Special">]</span><span class="Special">+</span><span class="Special">/</span>, <span class="Special">&quot;</span><span class="Constant">-</span><span class="Special">&quot;</span>).downcase
  <span class="PreProc">end</span>

</pre>
<pre class='nested chunk'>
  <a class='nested chunk' href='#clean-html'>Clean HTML</a>
</pre>
<pre class='ruby code syntax'>

end
</pre>
</div>
</div>
</p>
<h4>In-memory chunks storage</h4>
<p>
Detecting unused and/or duplicate chunks requires us to have in-memory chunk
storage that tracks all chunks access. Here is a simple test demonstrating
reading chunks into the storage and handling the various error conditions
listed above:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-read-chunks-rb">
<span>test/read_chunks.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test reading chunks from files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestReadChunks</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>

  <span class="PreProc">def</span> <span class="Identifier">test_read_chunks</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> })
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">bar.chunks</span><span class="Special">&quot;</span>, [ { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span> }, { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">baz</span><span class="Special">&quot;</span> } ])
    reader = <span class="Type">Codnar</span>::<span class="Type">Reader</span>.new(<span class="Identifier">@errors</span>, <span class="Type">Dir</span>.glob(<span class="Special">&quot;</span><span class="Constant">./**/*.chunks</span><span class="Special">&quot;</span>))
    check_read_data(reader, <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> },
                            <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span> },
                            <span class="Special">&quot;</span><span class="Constant">baz</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">baz</span><span class="Special">&quot;</span> })
    <span class="Identifier">@errors</span>.should == []
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_read_invalid_chunks</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>)
    reader = <span class="Type">Codnar</span>::<span class="Type">Reader</span>.new(<span class="Identifier">@errors</span>, <span class="Type">Dir</span>.glob(<span class="Special">&quot;</span><span class="Constant">./**/*.chunks</span><span class="Special">&quot;</span>))
    <span class="Identifier">@errors</span>.should == [ <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Invalid chunks data in file: </span><span class="Special">#{</span><span class="Type">File</span>.expand_path(<span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>)<span class="Special">}</span><span class="Special">&quot;</span> ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_read_unused_chunks</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>,
                                         <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ] })
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">bar.chunks</span><span class="Special">&quot;</span>, { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span>,
                                         <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">b</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span> } ] })
    reader = <span class="Type">Codnar</span>::<span class="Type">Reader</span>.new(<span class="Identifier">@errors</span>, <span class="Type">Dir</span>.glob(<span class="Special">&quot;</span><span class="Constant">./**/*.chunks</span><span class="Special">&quot;</span>))
    check_read_data(reader, <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> =&gt; { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>,
                                       <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ] })
    <span class="Identifier">@errors</span>.should == [ <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Unused chunk: bar in file: b at line: 2</span><span class="Special">&quot;</span> ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_read_duplicate_chunks</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span> } ],
                                         <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">A</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span> ] })
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">bar.chunks</span><span class="Special">&quot;</span>, [
      { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">b</span><span class="Special">&quot;</span> } ],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">d</span><span class="Special">&quot;</span> ] },
      { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span> } ],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [] }
    ])
    reader = <span class="Type">Codnar</span>::<span class="Type">Reader</span>.new(<span class="Identifier">@errors</span>, <span class="Type">Dir</span>.glob(<span class="Special">&quot;</span><span class="Constant">./**/*.chunks</span><span class="Special">&quot;</span>))
    check_read_data(reader, <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span> }, { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">b</span><span class="Special">&quot;</span> }, { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span> } ],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">d</span><span class="Special">&quot;</span> ],
    })
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_read_different_chunks</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, [
      { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [] },
      { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">baz</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span> } ],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">A</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [] }
    ])
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">bar.chunks</span><span class="Special">&quot;</span>, [ { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span>,
                                           <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
                                           <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [] } ])
    reader = <span class="Type">Codnar</span>::<span class="Type">Reader</span>.new(<span class="Identifier">@errors</span>, <span class="Type">Dir</span>.glob(<span class="Special">&quot;</span><span class="Constant">./**/*.chunks</span><span class="Special">&quot;</span>).sort)
    <span class="Identifier">@errors</span>.should == [ <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Chunk: foo is different in file: foo.chunks at line: 2, </span><span class="Special">&quot;</span> \
                      + <span class="Special">&quot;</span><span class="Constant">and in file: bar.chunks at line: 1 or in file: foo.chunks at line: 1</span><span class="Special">&quot;</span> ]
    check_read_data(reader, <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">bar.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> }, { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">a</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
    })
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_read_fake_chunk</span>
    reader = <span class="Type">Codnar</span>::<span class="Type">Reader</span>.new(<span class="Identifier">@errors</span>, [])
    reader[<span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>].should == <span class="Type">Codnar</span>::<span class="Type">Reader</span>.fake_chunk(<span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == [ <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Missing chunk: foo</span><span class="Special">&quot;</span> ]
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_read_equivalent_name_chunks</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, [
      { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Foo?</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">1</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span> ] },
      { <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">FOO!!</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span> } ],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">2</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">C</span><span class="Special">&quot;</span> ] }
    ])
    reader = <span class="Type">Codnar</span>::<span class="Type">Reader</span>.new(<span class="Identifier">@errors</span>, <span class="Type">Dir</span>.glob(<span class="Special">&quot;</span><span class="Constant">./**/*.chunks</span><span class="Special">&quot;</span>))
    check_read_data(reader, <span class="Special">&quot;</span><span class="Constant">foo-</span><span class="Special">&quot;</span> =&gt; {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Foo?</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> }, { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo.chunks</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">2</span> } ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">1</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">2</span><span class="Special">&quot;</span> ],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">c</span><span class="Special">&quot;</span> ],
    })
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

  <span class="PreProc">def</span> <span class="Identifier">check_read_data</span>(reader, chunks)
    chunks.each <span class="Statement">do</span> |<span class="Identifier">name</span>, <span class="Identifier">chunk</span>|
      reader[name].should == chunk
    <span class="Statement">end</span>
    reader.collect_unused_chunk_errors
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-reader-rb">
<span>lib/codnar/reader.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Read chunks from disk files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Reader</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Load all chunks from the specified disk files to memory for later access by
name.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(errors, paths)
      <span class="Identifier">@errors</span> = errors
      <span class="Identifier">@chunks</span> = {}
      <span class="Identifier">@used</span> = {}
      paths.each <span class="Statement">do</span> |<span class="Identifier">path</span>|
        read_path_chunks(path)
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Fetch a chunk by its name.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">[]</span>(name)
      id = name.to_id
      <span class="Identifier">@used</span>[id] = <span class="Constant">true</span>
      <span class="Statement">return</span> <span class="Identifier">@chunks</span>[id] ||= (
        <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">Missing chunk: </span><span class="Special">#{</span>name<span class="Special">}</span><span class="Special">&quot;</span>
        <span class="Type">Reader</span>.fake_chunk(name)
      )
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Collect errors for unused chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">collect_unused_chunk_errors</span>
      <span class="Identifier">@chunks</span>.each <span class="Statement">do</span> |<span class="Identifier">id</span>, <span class="Identifier">chunk</span>|
        <span class="Identifier">@errors</span>.push(<span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Unused chunk: </span><span class="Special">#{</span>chunk.name<span class="Special">}</span><span class="Constant"> </span><span class="Special">#{</span><span class="Type">Reader</span>.locations_message(chunk)<span class="Special">}</span><span class="Special">&quot;</span>) <span class="Statement">unless</span> <span class="Identifier">@used</span>[id]
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Load and merge all chunks from a disk file into memory.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">read_path_chunks</span>(path)
      <span class="Identifier">@errors</span>.in_path(path) <span class="Statement">do</span>
        chunks = load_path_chunks(path)
        <span class="Statement">next</span> <span class="Statement">unless</span> chunks
        merge_loaded_chunks(chunks)
        <span class="Identifier">@root_chunk</span> ||= chunks[<span class="Constant">0</span>].name
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Load all chunks from a disk file into memory.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">load_path_chunks</span>(path)
      chunks = <span class="Type">YAML</span>.load_file(path)
      <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">Invalid chunks data</span><span class="Special">&quot;</span> <span class="Statement">unless</span> chunks
</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
TODO: A bit more validation would be nice.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="Statement">return</span> chunks
    end

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge an array of chunks into memory.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">merge_loaded_chunks</span>(chunks)
      chunks.each <span class="Statement">do</span> |<span class="Identifier">new_chunk</span>|
        old_chunk = <span class="Identifier">@chunks</span>[id = new_chunk.name.to_id]
        <span class="Statement">if</span> old_chunk.nil?
          <span class="Identifier">@chunks</span>[id] = new_chunk
        <span class="Statement">elsif</span> <span class="Type">Reader</span>.same_chunk?(old_chunk, new_chunk)
          <span class="Type">Reader</span>.merge_same_chunks(old_chunk, new_chunk)
        <span class="Statement">else</span>
          <span class="Identifier">@errors</span>.push(<span class="Type">Reader</span>.different_chunks_error(old_chunk, new_chunk))
        <span class="Statement">end</span>
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Merge a new “same” chunk into an old one.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">merge_same_chunks</span>(old_chunk, new_chunk)
      old_chunk.locations = \
        (old_chunk.locations + new_chunk.locations).uniq.sort \
          <span class="Statement">do</span> |<span class="Identifier">first_location</span>, <span class="Identifier">second_location</span>|
            [ first_location.file.to_id, first_location.line ] \
            &lt;=&gt; [ second_location.file.to_id, second_location.line ]
          <span class="Statement">end</span>
      old_chunk.containers = \
        (old_chunk.containers + new_chunk.containers).uniq.sort \
          <span class="Statement">do</span> |<span class="Identifier">first_name</span>, <span class="Identifier">second_name</span>|
            first_name.to_id &lt;=&gt; second_name.to_id
          <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Check whether two chunks contain the same “stuff”.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">same_chunk?</span>(old_chunk, new_chunk)
      <span class="Statement">return</span> <span class="Type">Reader</span>.chunk_payload(old_chunk) == <span class="Type">Reader</span>.chunk_payload(new_chunk)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return just the actual payload of a chunk for equality comparison.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">chunk_payload</span>(chunk)
      chunk = chunk.reject { |<span class="Identifier">key</span>, <span class="Identifier">value</span>| [ <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> ].include?(key) }
      chunk.contained.map! { |<span class="Identifier">name</span>| name.to_id }
      <span class="Statement">return</span> chunk
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Error message when two different chunks have the same name.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">different_chunks_error</span>(old_chunk, new_chunk)
      old_location = <span class="Type">Reader</span>.locations_message(old_chunk)
      new_location = <span class="Type">Reader</span>.locations_message(new_chunk)
      <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Chunk: </span><span class="Special">#{</span>old_chunk.name<span class="Special">}</span><span class="Constant"> is different </span><span class="Special">#{</span>new_location<span class="Special">}</span><span class="Constant">, and </span><span class="Special">#{</span>old_location<span class="Special">}</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Format a chunk’s location for an error message.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">locations_message</span>(chunk)
      locations = chunk.locations.map { |<span class="Identifier">location</span>| <span class="Special">&quot;</span><span class="Constant">in file: </span><span class="Special">#{</span>location.file<span class="Special">}</span><span class="Constant"> at line: </span><span class="Special">#{</span>location.line<span class="Special">}</span><span class="Special">&quot;</span> }
      <span class="Statement">return</span> locations.join(<span class="Special">&quot;</span><span class="Constant"> or </span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return a fake chunk for the specified name.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">fake_chunk</span>(name)
      <span class="Statement">return</span> {
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; name,
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">MISSING</span><span class="Special">&quot;</span> } ],
        <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;div class='missing chunk error'&gt;</span><span class="Special">\n</span><span class="Constant">MISSING</span><span class="Special">\n</span><span class="Constant">&lt;/div&gt;</span><span class="Special">&quot;</span>
      }
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h2>Weaving chunks into HTML</h2>
<p>
Assembling the final HTML requires combining both the narrative documentation
and source code chunks. This is done top-down starting at a "root"
documentation chunk and recursively embedding nested documentation and code
chunks into it.
</p>
<h3>Weaving chunks together</h3>
<p>
When embedding a documentation chunk inside another documentation chunk, things
are pretty easy - we just need to insert the embedded chunk HTML into the
containing chunk. When embedding a source code chunk into the documentation,
however, we may want to wrap it in some boilerplate HTML, providing a header,
footer, borders, links, etc. Therefore, the HTML syntax we use to embed a chunk
into the documentation is <code>&lt;embed src="..." type="x-codnar/template-name"/&gt;</code>.
The templates are normal ERB templates, except for the magical <code>file</code> and
<code>image</code> templates, described below.
</p>
<p>
At any rate, here is a simple test demonstrating applying different templates
to the embedded code chunks:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-weave-configurations-rb">
<span>test/weave_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test the built-in weave configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestWeaveConfigurations</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithErrors</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>

  <span class="PreProc">def</span> <span class="Identifier">test_weave_file</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span>, {
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">chunk</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Top</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent,
<span class="Constant">        &lt;h1&gt;Top&lt;/h1&gt;</span>
<span class="Constant">        &lt;embed src=&quot;path&quot; type=&quot;x-codnar/file&quot;/&gt;</span>
<span class="Constant">      </span><span class="Special">EOF</span>
    })
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">path</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">&lt;h2&gt;File&lt;/h2&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>)
    html = <span class="Type">Codnar</span>::<span class="Type">Weaver</span>.new(<span class="Identifier">@errors</span>, [ <span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span> ], <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">WEAVE_INCLUDE</span>).weave(<span class="Special">&quot;</span><span class="Constant">include</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">top</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == []
    html.should == &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">      &lt;h1&gt;Top&lt;/h1&gt;</span>
<span class="Constant">      &lt;h2&gt;File&lt;/h2&gt;</span>
<span class="Constant">    </span><span class="Special">EOF</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_weave_include</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span>, chunks(<span class="Special">&quot;</span><span class="Constant">include</span><span class="Special">&quot;</span>))
    html = <span class="Type">Codnar</span>::<span class="Type">Weaver</span>.new(<span class="Identifier">@errors</span>, [ <span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span> ], <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">WEAVE_INCLUDE</span>).weave(<span class="Special">&quot;</span><span class="Constant">include</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">top</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == []
    html.should == &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
      <span class="Identifier">&lt;</span><span class="Statement">h1</span><span class="Identifier">&gt;</span><span class="Title">Top</span><span class="Identifier">&lt;/</span><span class="Statement">h1</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">h2</span><span class="Identifier">&gt;</span><span class="Title">Intermediate</span><span class="Identifier">&lt;/</span><span class="Statement">h2</span><span class="Identifier">&gt;</span>
      <span class="Identifier">&lt;</span><span class="Statement">h3</span><span class="Identifier">&gt;</span><span class="Title">Bottom</span><span class="Identifier">&lt;/</span><span class="Statement">h3</span><span class="Identifier">&gt;</span>
    EOF
</pre>
<pre class='ruby code syntax'>
    <span class="Comment">#! ))) html</span>
  end

  <span class="Type">WOVEN_PLAIN_CHUNK</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;plain chunk&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">name</span><span class="Identifier">=</span><span class="Constant">&quot;top&quot;</span><span class="Identifier">/&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">h1</span><span class="Identifier">&gt;</span><span class="Title">Top</span><span class="Identifier">&lt;/</span><span class="Statement">h1</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;plain chunk&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">name</span><span class="Identifier">=</span><span class="Constant">&quot;intermediate&quot;</span><span class="Identifier">/&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">h2</span><span class="Identifier">&gt;</span><span class="Title">Intermediate</span><span class="Identifier">&lt;/</span><span class="Statement">h2</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;plain chunk&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">name</span><span class="Identifier">=</span><span class="Constant">&quot;bottom&quot;</span><span class="Identifier">/&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">h3</span><span class="Identifier">&gt;</span><span class="Title">Bottom</span><span class="Identifier">&lt;/</span><span class="Statement">h3</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
  EOF
</pre>
<pre class='ruby code syntax'>
  <span class="Comment">#! ))) html</span>

  <span class="PreProc">def</span> <span class="Identifier">test_weave_plain_chunk</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span>, chunks(<span class="Special">&quot;</span><span class="Constant">plain_chunk</span><span class="Special">&quot;</span>))
    html = <span class="Type">Codnar</span>::<span class="Type">Weaver</span>.new(<span class="Identifier">@errors</span>, [ <span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span> ], <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">WEAVE_PLAIN_CHUNK</span>).weave(<span class="Special">&quot;</span><span class="Constant">plain_chunk</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">top</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == []
    html.should == <span class="Type">WOVEN_PLAIN_CHUNK</span>
  <span class="PreProc">end</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Normally, one does not nest named_chunk_with_containers chunks this way,
but it serves as a test.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Type">WOVEN_NAMED_CHUNK</span> = &lt;&lt;-<span class="Special">EOF</span>.unindent <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;named_with_containers chunk&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk name&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">name</span><span class="Identifier">=</span><span class="Constant">&quot;top&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier">&gt;</span>Top<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">a</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk html&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">h1</span><span class="Identifier">&gt;</span><span class="Title">Top</span><span class="Identifier">&lt;/</span><span class="Statement">h1</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;named_with_containers chunk&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk name&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">name</span><span class="Identifier">=</span><span class="Constant">&quot;intermediate&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier">&gt;</span>Intermediate<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">a</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk html&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">h2</span><span class="Identifier">&gt;</span><span class="Title">Intermediate</span><span class="Identifier">&lt;/</span><span class="Statement">h2</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;named_with_containers chunk&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk name&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">name</span><span class="Identifier">=</span><span class="Constant">&quot;bottom&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier">&gt;</span>BOTTOM<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">a</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk html&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">h3</span><span class="Identifier">&gt;</span><span class="Title">Bottom</span><span class="Identifier">&lt;/</span><span class="Statement">h3</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers header&quot;</span><span class="Identifier">&gt;</span>Contained in:<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">ul</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">li</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk container&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk container&quot;</span><span class="Identifier"> </span><span class="Type">href</span><span class="Identifier">=</span><span class="Constant">&quot;#intermediate&quot;</span><span class="Identifier">&gt;</span><span class="Underlined">Intermediate</span><span class="Identifier">&lt;/</span><span class="Statement">a</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">li</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">ul</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers header&quot;</span><span class="Identifier">&gt;</span>Contained in:<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">ul</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">li</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk container&quot;</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk container&quot;</span><span class="Identifier"> </span><span class="Type">href</span><span class="Identifier">=</span><span class="Constant">&quot;#top&quot;</span><span class="Identifier">&gt;</span><span class="Underlined">Top</span><span class="Identifier">&lt;/</span><span class="Statement">a</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">li</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">ul</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
    <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
  EOF
</pre>
<pre class='ruby code syntax'>
  <span class="Comment">#! ))) html</span>

  <span class="PreProc">def</span> <span class="Identifier">test_weave_named_chunk_with_containers</span>
    <span class="Type">Codnar</span>::<span class="Type">Writer</span>.write(<span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span>, chunks(<span class="Special">&quot;</span><span class="Constant">named_chunk_with_containers</span><span class="Special">&quot;</span>))
    weaver = <span class="Type">Codnar</span>::<span class="Type">Weaver</span>.new(<span class="Identifier">@errors</span>, [ <span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span> ], <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">WEAVE_NAMED_CHUNK_WITH_CONTAINERS</span>)
    html = weaver.weave(<span class="Special">&quot;</span><span class="Constant">named_chunk_with_containers</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">top</span><span class="Special">&quot;</span>)
    <span class="Identifier">@errors</span>.should == []
    html.should == <span class="Type">WOVEN_NAMED_CHUNK</span>
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

  <span class="PreProc">def</span> <span class="Identifier">chunks</span>(template)
    <span class="Statement">return</span> [
      { <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">chunk</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">Intermediate</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">BOTTOM</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;h3&gt;Bottom&lt;/h3&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>, },
      { <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">chunk</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">Top</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">BOTTOM</span><span class="Special">&quot;</span> ],
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Intermediate</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent, <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
          <span class="Identifier">&lt;</span><span class="Statement">h2</span><span class="Identifier">&gt;</span><span class="Title">Intermediate</span><span class="Identifier">&lt;/</span><span class="Statement">h2</span><span class="Identifier">&gt;</span>
          <span class="Identifier">&lt;</span>embed<span class="Identifier"> </span><span class="Type">type</span><span class="Identifier">=</span><span class="Constant">'x-codnar/#{template}'</span><span class="Identifier"> </span><span class="Type">src</span><span class="Identifier">=</span><span class="Constant">'bottom'</span><span class="Identifier">&gt;</span>
          <span class="Identifier">&lt;/</span>embed<span class="Identifier">&gt;</span>
        EOF
</pre>
<pre class='ruby code syntax'>
      }, { <span class="Comment">#! ))) html</span>
        <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">chunk</span><span class="Special">&quot;</span> ], <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [], <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [ <span class="Special">&quot;</span><span class="Constant">Intermediate</span><span class="Special">&quot;</span> ],
        <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Top</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent, <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
          <span class="Identifier">&lt;</span><span class="Statement">h1</span><span class="Identifier">&gt;</span><span class="Title">Top</span><span class="Identifier">&lt;/</span><span class="Statement">h1</span><span class="Identifier">&gt;</span>
          <span class="Identifier">&lt;</span>embed<span class="Identifier"> </span><span class="Type">src</span><span class="Identifier">=</span><span class="Constant">&quot;##INTERMEDIATE&quot;</span><span class="Identifier"> </span><span class="Type">type</span><span class="Identifier">=</span><span class="Constant">&quot;x-codnar/#{template}&quot;</span><span class="Identifier">/&gt;</span>
        EOF
</pre>
<pre class='ruby code syntax'>
    } ] <span class="Comment">#! ))) html</span>
  end

end
</pre>
</div>
</div>
</p>
<p>
Here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-weaver-rb">
<span>lib/codnar/weaver.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Weave all chunks to a unified HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Weaver</span> &lt; <span class="Type">Reader</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Load all chunks from the specified disk files to memory for weaving using
the specified templates.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(errors, paths, templates)
      <span class="Statement">super</span>(errors, paths)
      <span class="Identifier">@templates</span> = templates
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
How to process each magical file template.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Type">FILE_TEMPLATE_PROCESSORS</span> = {
      <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Statement">lambda</span> { |<span class="Identifier">name</span>, <span class="Identifier">data</span>| data },
      <span class="Special">&quot;</span><span class="Constant">image</span><span class="Special">&quot;</span> =&gt; <span class="Statement">lambda</span> { |<span class="Identifier">name</span>, <span class="Identifier">data</span>| <span class="Type">Weaver</span>.embedded_base64_img_tag(name, data) },
    }

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Weave the HTML for a named chunk.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">weave</span>(template, chunk_name = <span class="Identifier">@root_chunk</span>)
      <span class="Statement">return</span> process_file_template(template, chunk_name) <span class="Statement">if</span> <span class="Type">FILE_TEMPLATE_PROCESSORS</span>.include?(template)
      <span class="Identifier">@last_chunk</span> = chunk = <span class="Constant">self</span>[chunk_name.to_id]
      expand_chunk_html(chunk)
      <span class="Statement">return</span> process_template(chunk, template)
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Due to <a
href="http://github.com/relevance/rcov/issues/#issue/43">github.com/relevance/rcov/issues/#issue/43</a>
the following regular expressions must be on a single line.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Detect embedded chunks (<code>type</code> before <code>src</code>).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Type">TYPE_SRC_CHUNK</span> = <span class="Special">/</span><span class="Constant"> </span><span class="Special">[</span><span class="Constant"> </span><span class="Special">]</span><span class="Special">*</span><span class="Constant"> &lt;embed </span><span class="Special">\s</span><span class="Special">+</span><span class="Constant"> type = </span><span class="Special">[</span><span class="Constant">'\&quot;</span><span class="Special">]</span><span class="Constant"> x-codnar</span><span class="Special">\/</span><span class="Constant"> </span><span class="Special">(</span><span class="Special">.</span><span class="Special">*?</span><span class="Special">)</span><span class="Constant"> </span><span class="Special">[</span><span class="Constant">'\&quot;</span><span class="Special">]</span><span class="Constant"> </span><span class="Special">\s</span><span class="Special">+</span><span class="Constant"> src = </span><span class="Special">[</span><span class="Constant">'\&quot;</span><span class="Special">]</span><span class="Constant"> \#</span><span class="Special">*</span><span class="Constant"> </span><span class="Special">(</span><span class="Special">.</span><span class="Special">*?</span><span class="Special">)</span><span class="Constant"> </span><span class="Special">[</span><span class="Constant">'\&quot;</span><span class="Special">]</span><span class="Constant"> </span><span class="Special">\s</span><span class="Special">*</span><span class="Constant"> </span><span class="Special">(?:</span><span class="Constant"> </span><span class="Special">\/</span><span class="Constant">&gt; </span><span class="Special">|</span><span class="Constant"> &gt; </span><span class="Special">\s</span><span class="Special">*</span><span class="Constant"> &lt;</span><span class="Special">\/</span><span class="Constant">embed&gt; </span><span class="Special">)</span><span class="Constant"> </span><span class="Special">[</span><span class="Constant"> </span><span class="Special">]</span><span class="Special">*</span><span class="Constant"> </span><span class="Special">/x</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Detect embedded chunks (<code>src</code> before <code>type</code>).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Type">SRC_TYPE_CHUNK</span> = <span class="Special">/</span><span class="Constant"> </span><span class="Special">[</span><span class="Constant"> </span><span class="Special">]</span><span class="Special">*</span><span class="Constant"> &lt;embed </span><span class="Special">\s</span><span class="Special">+</span><span class="Constant"> src = </span><span class="Special">[</span><span class="Constant">'\&quot;</span><span class="Special">]</span><span class="Constant"> \#</span><span class="Special">*</span><span class="Constant"> </span><span class="Special">(</span><span class="Special">.</span><span class="Special">*?</span><span class="Special">)</span><span class="Constant"> </span><span class="Special">[</span><span class="Constant">'\&quot;</span><span class="Special">]</span><span class="Constant"> </span><span class="Special">\s</span><span class="Special">+</span><span class="Constant"> type = </span><span class="Special">[</span><span class="Constant">'\&quot;</span><span class="Special">]</span><span class="Constant"> x-codnar</span><span class="Special">\/</span><span class="Constant"> </span><span class="Special">(</span><span class="Special">.</span><span class="Special">*?</span><span class="Special">)</span><span class="Constant"> </span><span class="Special">[</span><span class="Constant">'\&quot;</span><span class="Special">]</span><span class="Constant"> </span><span class="Special">\s</span><span class="Special">*</span><span class="Constant"> </span><span class="Special">(?:</span><span class="Constant"> </span><span class="Special">\/</span><span class="Constant">&gt; </span><span class="Special">|</span><span class="Constant"> &gt; </span><span class="Special">\s</span><span class="Special">*</span><span class="Constant"> &lt;</span><span class="Special">\/</span><span class="Constant">embed&gt; </span><span class="Special">)</span><span class="Constant"> </span><span class="Special">[</span><span class="Constant"> </span><span class="Special">]</span><span class="Special">*</span><span class="Constant"> </span><span class="Special">/x</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Recursively expand all embedded chunks inside a container chunk.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">expand_chunk_html</span>(chunk)
      html = chunk.html
      <span class="Identifier">@errors</span>.push(<span class="Special">&quot;</span><span class="Constant">No HTML in chunk: </span><span class="Special">#{</span>chunk.name<span class="Special">}</span><span class="Constant"> </span><span class="Special">#{</span><span class="Type">Weaver</span>.locations_message(chunk)<span class="Special">}</span><span class="Special">&quot;</span>) <span class="Statement">unless</span> html
      <span class="Comment">#! TRICKY: All &quot;container&quot; chunks are assumed to be whole-file chunks with</span>
      <span class="Comment">#! a single location. Which makes sense as these are documentation and not</span>
      <span class="Comment">#! code chunks. </span><span class="Todo">TODO</span><span class="Comment">: It would be nice to know the exact line number of</span>
      <span class="Comment">#! the chunk embedding directive for better pinpointing of any error.</span>
      <span class="Identifier">@errors</span>.in_path(chunk.locations[<span class="Constant">0</span>].file) <span class="Statement">do</span>
        chunk.expanded_html ||= expand_embedded_chunks(html || <span class="Special">&quot;&quot;</span>).chomp
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Recursively expand_embedded_chunks all embedded chunk inside an HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">expand_embedded_chunks</span>(html)
      <span class="Statement">return</span> html.gsub(<span class="Type">TYPE_SRC_CHUNK</span>) { |<span class="Identifier">match</span>| weave(<span class="Identifier">$1</span>, <span class="Identifier">$2</span>).chomp } \
                 .gsub(<span class="Type">SRC_TYPE_CHUNK</span>) { |<span class="Identifier">match</span>| weave(<span class="Identifier">$2</span>, <span class="Identifier">$1</span>).chomp }
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Process the chunk using an ERB template prior to inclusion in container
chunk.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">process_template</span>(chunk, template_name)
      template_text = <span class="Identifier">@templates</span>[template_name] ||= (
        <span class="Identifier">@errors</span> &lt;&lt; <span class="Special">&quot;</span><span class="Constant">Missing ERB template: </span><span class="Special">#{</span>template_name<span class="Special">}</span><span class="Special">&quot;</span>
        <span class="Special">&quot;</span><span class="Constant">&lt;%= chunk.expanded_html %&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
      )
      <span class="Statement">return</span> (
        (
          chunk.erb ||= {}
        )[template_name] ||= <span class="Type">ERB</span>.new(template_text, <span class="Constant">nil</span>, <span class="Special">&quot;</span><span class="Constant">%</span><span class="Special">&quot;</span>)
      ).result(binding)
    <span class="PreProc">end</span>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#processing-the-file-template'>Processing the file template</a>
</pre>
<pre class='ruby code syntax'>

</pre>
<pre class='nested chunk'>
    <a class='nested chunk' href='#processing-base64-embedded-data-images'>Processing Base64 embedded data images</a>
</pre>
<pre class='ruby code syntax'>

  end

end
</pre>
</div>
</div>
</p>
<p>
And here are the pre-defined weaving template configurations:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-weave-configurations-rb">
<span>lib/codnar/weave_configurations.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

  <span class="PreProc">module</span> <span class="Type">Configuration</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Weave configuration providing a single simple <code>include</code>
template.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Type">WEAVE_INCLUDE</span> = { <span class="Special">&quot;</span><span class="Constant">include</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;%= chunk.expanded_html %&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span> }

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Weave chunks in the plainest possible way.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Type">WEAVE_PLAIN_CHUNK</span> = {
      <span class="Special">&quot;</span><span class="Constant">plain_chunk</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent, <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
        <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;plain chunk&quot;</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">name</span><span class="Identifier">=</span><span class="Constant">&quot;&lt;%= chunk.name.to_id %&gt;&quot;</span><span class="Identifier">/&gt;</span>
        <span class="Identifier">&lt;%=</span><span class="Constant"> chunk.expanded_html</span><span class="Identifier"> %&gt;</span>
        <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
      EOF
</pre>
<pre class='ruby code syntax'>
    } <span class="Comment">#! ))) html</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Weave chunks with their name and the list of container chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="Type">WEAVE_NAMED_CHUNK_WITH_CONTAINERS</span> = {
      <span class="Special">&quot;</span><span class="Constant">named_chunk_with_containers</span><span class="Special">&quot;</span> =&gt; &lt;&lt;-<span class="Special">EOF</span>.unindent, <span class="Comment">#! ((( html</span>
</pre>
<pre class='html code syntax'>
        <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;named_with_containers chunk&quot;</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk name&quot;</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">name</span><span class="Identifier">=</span><span class="Constant">&quot;&lt;%= chunk.name.to_id %&gt;&quot;</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier">&gt;&lt;%=</span><span class="Constant"> CGI.escapeHTML(chunk.name)</span><span class="Identifier"> %&gt;</span><span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;/</span><span class="Statement">a</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk html&quot;</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;%=</span><span class="Constant"> chunk.expanded_html</span><span class="Identifier"> %&gt;</span>
        <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
        % if chunk.containers != []
        <span class="Identifier">&lt;</span><span class="Statement">div</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers&quot;</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">span</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers header&quot;</span><span class="Identifier">&gt;</span>Contained in:<span class="Identifier">&lt;/</span><span class="Statement">span</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">ul</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk containers&quot;</span><span class="Identifier">&gt;</span>
        % chunk.containers.each do |container|
        <span class="Identifier">&lt;</span><span class="Statement">li</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk container&quot;</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;</span><span class="Statement">a</span><span class="Identifier"> </span><span class="Type">class</span><span class="Identifier">=</span><span class="Constant">&quot;chunk container&quot;</span><span class="Identifier"> </span><span class="Type">href</span><span class="Identifier">=</span><span class="Constant">&quot;#&lt;%= container.to_id %&gt;&quot;</span><span class="Identifier">&gt;&lt;%=</span><span class="Constant"> CGI.escapeHTML(container)</span><span class="Identifier"> %&gt;</span><span class="Identifier">&lt;/</span><span class="Statement">a</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;/</span><span class="Statement">li</span><span class="Identifier">&gt;</span>
        % end
        <span class="Identifier">&lt;/</span><span class="Statement">ul</span><span class="Identifier">&gt;</span>
        <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
        % end
        <span class="Identifier">&lt;/</span><span class="Statement">div</span><span class="Identifier">&gt;</span>
      EOF
</pre>
<pre class='ruby code syntax'>
    } <span class="Comment">#! ))) html</span>

  end

end
</pre>
</div>
</div>
</p>
<h4>Embedding files</h4>
<p>
The template named <code>file</code> is special in two ways. First, the <code>src</code> is given
special treatment. If it begins with a "<code>.</code>", it is assumed to be a normal path
name relative to the current working directory; otherwise, it is assumed to be
a name of a file packaged inside some gem and is searched for in Ruby's
<code>$LOAD_PATH</code>. This allows gems (such as Codnar itself) to provide such files to
be used in the woven documentation.
</p>
<p>
Second, the content of the file is simply embedded into the generated
documentation. This allows the documentation to be a stand-alone file,
including all the CSS and Javascript required for proper display.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="processing-the-file-template">
<span>Processing the file template</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Process one of the magical file templates. The content of the file,
optionally processed, is directly embedded into the generated
documentation. If the file’s path begins with “.”, it is taken to be
relative to the current working directory. Otherwise, it is searched for in
Ruby’s load path, allowing easy access to files packaged inside gems.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Identifier">process_file_template</span>(template, path)
  <span class="Statement">begin</span>
    path = <span class="Type">Olag</span>::<span class="Type">DataFiles</span>.expand_path(path) <span class="Statement">unless</span> path[<span class="Constant">0</span>,<span class="Constant">1</span>] == <span class="Special">&quot;</span><span class="Constant">.</span><span class="Special">&quot;</span>
    <span class="Statement">return</span> <span class="Type">FILE_TEMPLATE_PROCESSORS</span>[template].call(path, <span class="Type">File</span>.read(path))
  <span class="Statement">rescue</span> <span class="Type">Exception</span> =&gt; exception
    <span class="Identifier">@errors</span>.push(<span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Reading file: </span><span class="Special">#{</span>path<span class="Special">}</span><span class="Constant"> exception: </span><span class="Special">#{</span>exception<span class="Special">}</span><span class="Constant"> </span><span class="Special">#{</span><span class="Type">Reader</span>.locations_message(<span class="Identifier">@last_chunk</span>)<span class="Special">}</span><span class="Special">&quot;</span>) \
      <span class="Statement">if</span> <span class="Identifier">@last_chunk</span>
    <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant">FILE: </span><span class="Special">#{</span>path<span class="Special">}</span><span class="Constant"> EXCEPTION: </span><span class="Special">#{</span>exception<span class="Special">}</span><span class="Special">&quot;</span>
  <span class="Statement">end</span>
<span class="Statement">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-weaver-rb">lib/codnar/weaver.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
See the <code>doc/root.html</code> file for plenty of examples of using this
functionality.
</p>
<h4>Embedding images</h4>
<p>
The <code>image</code> template is a specialization of the <code>file</code> template for dealing
with embedded images. The specified image file is embedded into the generated
HTML as an <code>img</code> tag, using a <a href="http://en.wikipedia.org/wiki/Data_URI_scheme">data
URL</a>. This is very useful for
small images, but is problematic when their size increase beyond
browser-specific limits.
</p>
<p>
Here is a simple test demonstrating processing embedded image files:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-embed-images-rb">
<span>test/embed_images.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test computing embedded image HTML tags.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestEmbedImages</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">def</span> <span class="Identifier">test_embed_image</span>
    <span class="Type">Codnar</span>::<span class="Type">Weaver</span>.embedded_base64_img_tag(<span class="Special">'</span><span class="Constant">fake file.png</span><span class="Special">'</span>, <span class="Special">'</span><span class="Constant">fake file content</span><span class="Special">'</span>).should \
      == <span class="Special">&quot;</span><span class="Constant">&lt;img src='data:image/png;base64,ZmFrZSBmaWxlIGNvbnRlbnQ=</span><span class="Special">\n</span><span class="Constant">'/&gt;</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
Here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="processing-base64-embedded-data-images">
<span>Processing Base64 embedded data images</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Create an <code>img</code> tag with an embedded data URL. Different
browsers have different constraints about the size of the resulting URL, so
YMMV.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">embedded_base64_img_tag</span>(name, data)
  extension = <span class="Type">File</span>.extname(name).sub(<span class="Special">&quot;</span><span class="Constant">.</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">/</span><span class="Special">&quot;</span>)
  <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant">&lt;img src='data:image</span><span class="Special">#{</span>extension<span class="Special">}</span><span class="Constant">;base64,</span><span class="Special">&quot;</span> \
       + <span class="Type">Base64</span>.encode64(data) \
       + <span class="Special">&quot;</span><span class="Constant">'/&gt;</span><span class="Special">&quot;</span>
<span class="PreProc">end</span>

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#lib-codnar-weaver-rb">lib/codnar/weaver.rb</a>
</li>
</ul>
</div>
</div>
</p>
<p>
And here is a sample embedded image:
</p>
<p>
<img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAMAAADVRocKAAAABGdBTUEAALGP
C/xhBQAAAwBQTFRFAAAAAAQACAgACAwACAgICAwIEBAAEBQAGBgAGBwAEBAQ
EBQQGBgYGBwYISAAISQAKSgAKSwAMTAAMTQAOTgAOTwAISAhISQhKSgpKSwp
MTAxMTQxOTg5OTw5QkEAQkUASkkASk0AUlEAUlUAWlkAWl0AY2EAY2UAa2kA
a20Ac3EAc3UAe3kAe30AQkFCQkVCSklKSk1KUlFSUlVSWllaWl1aY2Vja2lr
a21rc3Fzc3Vze3l7e317hIIAhIYAjIoAjI4AlJIAlJYAnJoAnJ4ApaIApaYA
raoAra4AtbIAtbYAvboAvb4AxsMAxscAzssAzs8A1tMA1tcA3tsA3t8A5+MA
5+cA7+sA7+8A9/MA9/cA//sA//8AhIKEhIaEjIqMjI6MlJKUlJaUnJqcpaKl
paalraqtra6ttbK1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAA6Ke7cwAAAQB0Uk5T////////////////////////
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////
////////////////AFP3ByUAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2
My41LjVJivzgAAAFm0lEQVRoQ+1ZaVsURxCe2dEFPGDRKCqKqHhExXgnKgQP
EFHkPndb3cSI+f9/YDLTVTPTVV093WMev1GfeNi36u3qrq1ro/QnS/ST7aeH
BN4bPryi/3FF/RczDcRJ5HyDgzhqIvddDE6Cc03MR1F84GBwEXxqZj+KzjUk
ON6UIPoiMzg8eNLYfnS8EcERTTAY9tAIeyoyyB7c0/aTxU6II/H8Lxp2JJzg
K9id6i20Ahgmu+8Bdk9iED04Cxe0obqX/QTJqupNAeybwCARvAD4rFJqJfEy
/JrBNgY0bCyQ4JhGj+xlmuqWj2BoO4fdBdgnm0Hw4JHGxm9zRbU1WM8Qv9Sw
3RENOxZEALE50dWaaq4+VE/vA+wNwB5bDLYH4xqZfARFtX+qzoXWEsK6E+C3
n+BvsHcLFZV6Vxeq13oF7iOEw0XOYHlwUuMGN0uC3hW3C+31EqauA+wrY+AE
z8DTuUpRrblD9bYB24RwOOshOKpRozpEC7ntcmFkx4TNwjs/owzMgwca01o0
FdX2kMwQvyawvVENO1pH8B0OcaV8OrDwWg7VMxjJBc0iwB4SBurBeY1or5GT
KdWFdMmktcxgvUmNoKFKCPpgIs8uVJakUJ1ifiq1CuEwbrpACE7ozyG7ECnS
penDwIYFUzcB0DcYTIKn4OErW1Gtt/kFxXcF2Nawhp1wEECdLLIL1Z/mBJ1d
gUC9BNgfFYPhAdTJ1ntJsUiXJU28IMIwcxnVsyL4BkFWZRdqYZ6G6mXrhQG+
BLCq0asIxvQnZnYhDJgu0YVkRXRAKcxcVaNXEszAC0tPB7Y+mCnphsO+UmtQ
PctGryTAOik+HVjDGMzVh7acBOoOOPkZ37kggFYunncrqk04Wy5msuUaOxCq
RaNXEECI8uxClTFd8mTLGTBzYaOHBBe1/WS5xgGlMF1G8bta2D5p9IAAW7nr
jtgr7C1ADE56YB/MRg8IoE5K2YWG6mQOa6/WOpCFKjZ6/+SmNcFzeOE/PYqY
Ls06KWuYjZ4mgBDtkDopq2ahOmwnWwuLmStv9HKCh+AAtHL1klVPKdlyJaPR
ywmwldvZC5DpU9sBqL1XYPOR9uCz/juKkxBpd0JQCaaV83BFkObC5OpiyEyC
tvKUlxNgog5hGFjvXQ3BASZP2jqKoNSEyJ0sXfpnErSkyw580SAT+WU4b+Wc
jR7X/70igHLvFUi2OzBseAVKPya7sMH+DEwbjkaPM0LzggR973kyQJFs5UaP
W7ig7ZdbR2ga62Wq+MJiuqxFFw1kUXC++6ybyVZq9Lj+A3Cg2ptC414n+dyM
gumyBl028VXb4gtVkmytRo9zlWNIRQDDk1NaJNnudurRJ/GCjCsqyppLcYLW
SayeLnQ1Chq9KQ6wsg5v5Wijx3WMYdZs32EEl8Vq5ZZrUpI545ABxL01sFu5
3g33abI6I71BmsIaRBBceZDK6F6TkJUI8SCFKdmWUVx5EIZZ13FmDAfYDxS4
iuKaLbGVKxo9jqZrKepBCss0LnxuRkdwLuZoulhjBNhDUh1XK4dzMSO4ZF4Q
+aLpDy4JDjhbuVVr9rSXm8wDqXrqOimLsNHj61mL4DF3ga08CJO9JrEWzBYB
NqoVjTw3I4+10ftCX8B+gzSFabCURJ6bkWD/NEXbS37bg5T+NGGvPMgl0TWJ
8DOFQHBgHmrA2MpJD003enkrx0QgSH8zGKZ9Df16NXvyZRetySZxVT1rQrRg
Nho9YwciZ9Piv2WjF7/xOWA2euYWp54ghc1UtV+upcGtchT9Zb+AFKY5qg/2
47mVAFmG0T7CVi7gkTMINnpxmMBppPO7PEj/FXKe5190m+l5gzS935SB7WO9
BM7q6SJ+Lt+Q+zd9T6PHefhO3O9BOj7WRPReIjxMXegf+L+Ui37AjFvlkMB7
nYdX5L2i/wAENTnBDcjR4QAAAABJRU5ErkJggg==
'/>
</p>
<h2>Invoking the functionality</h2>
<p>
There are two ways to invoke Codnar's functionality - from the command line,
and (for Ruby projects) as integrated Rake tasks.
</p>
<h3>Command Line Applications</h3>
<p>
Executable scripts (tests, command-line applications) start with a <code>require
'codnar'</code> line to access to the full Codnar code. This also serves as a
convenient list of all of Codnar's parts and dependencies:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-rb">
<span>lib/codnar.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">andand</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">base64</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">cgi</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">coderay</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">digest/sha2</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">erb</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">fileutils</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">irb</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">open3</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">rdiscount</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">rdoc</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">rdoc/markup/to_html</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">tempfile</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">yaml</span><span class="Special">&quot;</span>

<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/application</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/data_files</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/errors</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/hash_struct</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/string_unindent</span><span class="Special">&quot;</span>

<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/version</span><span class="Special">&quot;</span>

<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/coderay</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/haddock</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/hash_extensions</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/markdown</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/rdoc</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/string_extensions</span><span class="Special">&quot;</span>

<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/application</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/cache</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/formatter</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/graphviz</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/grouper</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/gvim</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/merger</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/split</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/reader</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/scanner</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/configuration/code</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/configuration/comments</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/configuration/documentation</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/configuration/highlighting</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/split_configurations</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/splitter</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/sunlight</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/weave</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/weave_configurations</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/weaver</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/writer</span><span class="Special">&quot;</span>
</pre>
</div>
</div>
</p>
<p>
The base command line Application class handles execution from the command
line, with the usual standard options, as well as some Codnar-specific ones:
the ability to specify configuration files and/or built-in configurations, and
the ability to include additional extension code triggered from these
configurations. Together, these allow configuring and extending Codnar's
behavior to cover the specific system's needs.
</p>
<p>
Here is a simple test demonstrating the standard Codnar application behavior:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-run-application-rb">
<span>test/run_application.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test running a Codnar Application.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">TestRunApplication</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

    <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>
    <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithTempfile</span>

    <span class="PreProc">def</span> <span class="Identifier">test_print_version</span>
      <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-o nested/stdout -v -h dummy</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Application</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
      <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">nested/stdout</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Version: </span><span class="Special">#{</span><span class="Type">Codnar</span>::<span class="Type">VERSION</span><span class="Special">}</span><span class="Special">\n</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">test_print_help</span>
      <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-o stdout -h -v dummy</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Application</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
      <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stdout</span><span class="Special">&quot;</span>).should.include?(<span class="Special">&quot;</span><span class="Constant">OPTIONS</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

    <span class="Type">USER_CONFIGURATION</span> = {
      <span class="Special">&quot;</span><span class="Constant">formatters</span><span class="Special">&quot;</span> =&gt; {
        <span class="Special">&quot;</span><span class="Constant">doc</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Formatter.lines_to_pre_html(lines, :class =&gt; :pre)</span><span class="Special">&quot;</span>,
      }
    }

    <span class="PreProc">def</span> <span class="Identifier">test_merge_configurations</span>
      write_fake_file(<span class="Special">&quot;</span><span class="Constant">user_configuration.yaml</span><span class="Special">&quot;</span>, <span class="Type">USER_CONFIGURATION</span>.to_yaml)
      <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-o stdout -c split_pre_documentation -c user_configuration.yaml -p</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Application</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
      <span class="Type">YAML</span>.load_file(<span class="Special">&quot;</span><span class="Constant">stdout</span><span class="Special">&quot;</span>).should == <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">SPLIT_PRE_DOCUMENTATION</span>.deep_merge(<span class="Type">USER_CONFIGURATION</span>)
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">test_require_missing_configuration</span>
      status = <span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-e stderr -c no-such-configuration</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Application</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">1</span>
      <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stderr</span><span class="Special">&quot;</span>).should \
        == <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Configuration: no-such-configuration is neither a disk file nor a known configuration</span><span class="Special">\n</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">test_require_module</span>
      <span class="Type">FakeFS</span>.deactivate! <span class="Comment"># The additional_module is read by Ruby and is not affected by FakeFS.</span>
      directory = create_tempdir
      write_fake_file(directory + <span class="Special">&quot;</span><span class="Constant">/additional_module.rb</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">puts 'HERE'</span><span class="Special">\n</span><span class="Special">&quot;</span>)
      <span class="Type">Application</span>.with_argv([<span class="Special">&quot;</span><span class="Constant">-o</span><span class="Special">&quot;</span>, stdout = directory + <span class="Special">&quot;</span><span class="Constant">/stdout</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">-I</span><span class="Special">&quot;</span>, directory, <span class="Special">&quot;</span><span class="Constant">-r</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">additional_module</span><span class="Special">&quot;</span> ]) { <span class="Type">Codnar</span>::<span class="Type">Application</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
      <span class="Type">File</span>.read(stdout).should == <span class="Special">&quot;</span><span class="Constant">HERE</span><span class="Special">\n</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

    <span class="PreProc">def</span> <span class="Identifier">test_require_missing_module</span>
      <span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-e stderr -I support -r no_such_module</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Application</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">1</span>
      <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stderr</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: no such file to load -- no_such_module</span><span class="Special">\n</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

  <span class="PreProc">end</span>

end
</pre>
</div>
</div>
</p>
<p>
And here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-application-rb">
<span>lib/codnar/application.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Base class for Codnar applications.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Application</span> &lt; <span class="Type">Olag</span>::<span class="Type">Application</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Create a Codnar application.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">initialize</span>(is_test = <span class="Constant">nil</span>)
      <span class="Statement">super</span>(is_test)
      <span class="Identifier">@configuration</span> ||= {}
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run the Codnar application, returning its status.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">run</span>(&amp;block)
      <span class="Statement">super</span>(<span class="Identifier">@configuration</span>, &amp;block)
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define Codnar application flags.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">define_flags</span>
      <span class="Statement">super</span>
      define_include_flag
      define_require_flag
      define_merge_flag
      define_print_flag
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return the application’s version - that is, Codnar’s version.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">version</span>
      <span class="Statement">return</span> <span class="Type">Codnar</span>::<span class="Type">VERSION</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define a flag for collecting module load path directories.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">define_include_flag</span>
      <span class="Identifier">@options</span>.on(<span class="Special">&quot;</span><span class="Constant">-I</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">--include DIRECTORY</span><span class="Special">&quot;</span>, <span class="Type">String</span>, <span class="Special">&quot;</span><span class="Constant">Add directory to Ruby's load path.</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">path</span>|
        <span class="Identifier">$LOAD_PATH</span>.unshift(path)
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define a flag for loading a Ruby module. This may be needed for
user-specified configurations to work.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">define_require_flag</span>
      <span class="Identifier">@options</span>.on(<span class="Special">&quot;</span><span class="Constant">-r</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">--require MODULE</span><span class="Special">&quot;</span>, <span class="Type">String</span>, <span class="Special">&quot;</span><span class="Constant">Load a Ruby module for user configurations.</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">path</span>|
        <span class="Statement">begin</span>
          <span class="PreProc">require</span>(path)
        <span class="Statement">rescue</span> <span class="Type">Exception</span> =&gt; exception
          <span class="Identifier">$stderr</span>.puts(<span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: </span><span class="Special">#{</span>exception<span class="Special">}</span><span class="Special">&quot;</span>)
          <span class="Statement">exit</span>(<span class="Constant">1</span>)
        <span class="Statement">end</span>
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define a flag for applying (merging) a Codnar configuration.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">define_merge_flag</span>
      <span class="Identifier">@options</span>.on(<span class="Special">&quot;</span><span class="Constant">-c</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">--configuration NAME-or-FILE</span><span class="Special">&quot;</span>, <span class="Type">String</span>, <span class="Special">&quot;</span><span class="Constant">Apply a named or disk file configuration.</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">name_or_path</span>|
        loaded_configuration = load_configuration(name_or_path)
        <span class="Identifier">@configuration</span> = <span class="Identifier">@configuration</span>.deep_merge(loaded_configuration)
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define a flag for printing the (merged) Codnar configuration.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">define_print_flag</span>
      <span class="Identifier">@options</span>.on(<span class="Special">&quot;</span><span class="Constant">-p</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">--print</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">Print the merged configuration.</span><span class="Special">&quot;</span>) <span class="Statement">do</span> |<span class="Identifier">name_or_path</span>|
        puts(<span class="Identifier">@configuration</span>.to_yaml)
      <span class="Statement">end</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Load a configuration either from the available builtin data or from a disk
file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">load_configuration</span>(name_or_path)
      <span class="Statement">return</span> <span class="Type">YAML</span>.load_file(name_or_path) <span class="Statement">if</span> <span class="Type">File</span>.exist?(name_or_path)
      name, *arguments = name_or_path.split(<span class="Special">'</span><span class="Constant">:</span><span class="Special">'</span>)
      value = configuration_value(name)
      value = value.call(*arguments) <span class="Statement">unless</span> <span class="Type">Hash</span> === value
      <span class="Statement">return</span> value
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Compute the value of a named built-in configuration.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">configuration_value</span>(name)
      <span class="Statement">begin</span>
        value = <span class="Type">Configuration</span>.const_get(name.upcase)
        <span class="Statement">return</span> value <span class="Statement">if</span> value
      <span class="Statement">rescue</span>
        value = <span class="Constant">nil</span>
      <span class="Statement">end</span>
      <span class="Identifier">$stderr</span>.puts(<span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Configuration: </span><span class="Special">#{</span>name<span class="Special">}</span><span class="Constant"> is neither a disk file nor a known configuration</span><span class="Special">&quot;</span>)
      <span class="Statement">exit</span>(<span class="Constant">1</span>)
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h4>Application for splitting files</h4>
<p>
Here is a simple test demonstrating invoking the command-line application for
splitting files:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-run-split-rb">
<span>test/run_split.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test running the Split Codnar Application.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestRunSplit</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>

  <span class="PreProc">def</span> <span class="Identifier">test_print_help</span>
    <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-o stdout -h</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Split</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
    help = <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stdout</span><span class="Special">&quot;</span>)
    [ <span class="Special">&quot;</span><span class="Constant">codnar-split</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">OPTIONS</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">DESCRIPTION</span><span class="Special">&quot;</span> ].each { |<span class="Identifier">text</span>| help.should.include?(text) }
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_run_split</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">input</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">&lt;foo&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>)
    <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-o stdout input</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Split</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
    <span class="Type">YAML</span>.load_file(<span class="Special">&quot;</span><span class="Constant">stdout</span><span class="Special">&quot;</span>).should == [ {
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">input</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">input</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">&lt;foo&gt;</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
    } ]
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
Here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-split-rb">
<span>lib/codnar/split.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Split application.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Split</span> &lt; <span class="Type">Application</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run the weaving Codnar application, returning its status.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">run</span>
      <span class="Statement">super</span> { split }
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Split the specified input file into chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">split</span>
      <span class="Identifier">@configuration</span> = <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">SPLIT_HTML_DOCUMENTATION</span> <span class="Statement">if</span> <span class="Identifier">@configuration</span> == {}
      splitter = <span class="Type">Splitter</span>.new(<span class="Identifier">@errors</span>, <span class="Identifier">@configuration</span>)
      print(splitter.chunks(<span class="Identifier">ARGV</span>[<span class="Constant">0</span>]).to_yaml)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Parse remaining command-line file arguments.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">parse_arguments</span>
      expect_exactly(<span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">files to split</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return the banner line of the help message.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">banner</span>
      <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant">codnar-split - Split documentation or code files to chunks.</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return the name and description of any final command-line file arguments.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">arguments</span>
      <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant">FILE</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">Documentation or code file to split.</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return a short description of the program.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">description</span>
      <span class="Statement">return</span> &lt;&lt;-<span class="Special">EOF</span>.unindent
<span class="Constant">        Split the documentation of file into chunks that are printed in YAML format to</span>
<span class="Constant">        the output (to be read by codnar-weave). Many file formats can be split</span>
<span class="Constant">        depending on the specified configuration. The default configuration is called</span>
<span class="Constant">        SPLIT_HTML_DOCUMENTATION, and it preserves the whole file as a single formatted</span>
<span class="Constant">        HTML documentation chunk. This isn't very useful.</span>

<span class="Constant">        The configuration needs to specify a set of line classification patterns,</span>
<span class="Constant">        parsing states and pattern-based transitions between them, the initial state,</span>
<span class="Constant">        and expressions for formatting classified lines to HTML. See the Codnar</span>
<span class="Constant">        documentation for details.</span>
<span class="Constant">      </span><span class="Special">EOF</span>
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<p>
And here is the actual command-line application script:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="bin-codnar-split">
<span>bin/codnar-split</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">#!/usr/bin/ruby -w</span>

<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>

<span class="Statement">exit</span> <span class="Type">Codnar</span>::<span class="Type">Split</span>.new.run
</pre>
</div>
</div>
</p>
<h4>Application for weaving chunks</h4>
<p>
Here is a simple test demonstrating invoking the command-line application for
weaving chunk to HTML:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-run-weave-rb">
<span>test/run_weave.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test running the Weave Codnar Application.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestRunWeave</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>

  <span class="PreProc">def</span> <span class="Identifier">test_print_help</span>
    <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-o stdout -h</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Weave</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
    help = <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stdout</span><span class="Special">&quot;</span>)
    [ <span class="Special">&quot;</span><span class="Constant">codnar-weave</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">OPTIONS</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">DESCRIPTION</span><span class="Special">&quot;</span> ].each { |<span class="Identifier">text</span>| help.should.include?(text) }
  <span class="PreProc">end</span>

  <span class="Type">ROOT_CHUNKS</span> = [ {
    <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
    <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Root</span><span class="Special">\n</span><span class="Constant">&lt;embed src='included' type='x-codnar/include'/&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  } ]

  <span class="Type">INCLUDED_CHUNKS</span> = [ {
    <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">included</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">included</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
    <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Included</span><span class="Special">&quot;</span>
  } ]

  <span class="PreProc">def</span> <span class="Identifier">test_run_weave</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>, <span class="Type">ROOT_CHUNKS</span>.to_yaml)
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">included</span><span class="Special">&quot;</span>, <span class="Type">INCLUDED_CHUNKS</span>.to_yaml)
    <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-o stdout root included</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Weave</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
    <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stdout</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">Root</span><span class="Special">\n</span><span class="Constant">Included</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_run_weave_missing_chunk</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>, <span class="Type">ROOT_CHUNKS</span>.to_yaml)
    <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-e stderr -o stdout root</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Weave</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">1</span>
    <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stderr</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Missing chunk: included in file: root</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_run_weave_unused_chunk</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>, <span class="Type">ROOT_CHUNKS</span>.to_yaml)
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">included</span><span class="Special">&quot;</span>, <span class="Type">INCLUDED_CHUNKS</span>.to_yaml)
    <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-e stderr -o stdout included root</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Weave</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">1</span>
    <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stderr</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Unused chunk: root in file: root at line: 1</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="Type">FILE_CHUNKS</span> = [ {
    <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>,
    <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
    <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">Root</span><span class="Special">\n</span><span class="Constant">&lt;embed src='included.file' type='x-codnar/file'/&gt;</span><span class="Special">\n</span><span class="Special">&quot;</span>
  } ]

  <span class="PreProc">def</span> <span class="Identifier">test_run_weave_missing_file</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>, <span class="Type">FILE_CHUNKS</span>.to_yaml)
    <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-e stderr -o stdout root</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Weave</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">1</span>
    <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stdout</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">Root</span><span class="Special">\n</span><span class="Constant">FILE: included.file EXCEPTION: No such file or directory - included.file</span><span class="Special">\n</span><span class="Special">&quot;</span>
    <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stderr</span><span class="Special">&quot;</span>).should \
      == <span class="Special">&quot;</span><span class="Special">#{</span><span class="Identifier">$0</span><span class="Special">}</span><span class="Constant">: Reading file: included.file exception: No such file or directory - included.file in file: root at line: 1</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_run_weave_existing_file</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">root</span><span class="Special">&quot;</span>, <span class="Type">FILE_CHUNKS</span>.to_yaml)
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">included.file</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">included file</span><span class="Special">\n</span><span class="Special">&quot;</span>)
    <span class="Type">Codnar</span>::<span class="Type">Application</span>.with_argv(<span class="Special">%w(</span><span class="Constant">-e stderr -o stdout root</span><span class="Special">)</span>) { <span class="Type">Codnar</span>::<span class="Type">Weave</span>.new(<span class="Constant">true</span>).run }.should == <span class="Constant">0</span>
    <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">stdout</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">Root</span><span class="Special">\n</span><span class="Constant">included file</span><span class="Special">\n</span><span class="Special">&quot;</span>
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
Here is the implementation:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-weave-rb">
<span>lib/codnar/weave.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Weave application.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">class</span> <span class="Type">Weave</span> &lt; <span class="Type">Application</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run the weaving Codnar application, returning its status.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">run</span>
      <span class="Statement">super</span> { weave }
    <span class="PreProc">end</span>

  <span class="Statement">protected</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Weave all the chunks together to a single HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">weave</span>
      <span class="Identifier">@configuration</span> = <span class="Type">Codnar</span>::<span class="Type">Configuration</span>::<span class="Type">WEAVE_INCLUDE</span> <span class="Statement">if</span> <span class="Identifier">@configuration</span> == {}
      weaver = <span class="Type">Weaver</span>.new(<span class="Identifier">@errors</span>, <span class="Identifier">ARGV</span>, <span class="Identifier">@configuration</span>)
      puts(weaver.weave(<span class="Special">&quot;</span><span class="Constant">include</span><span class="Special">&quot;</span>))
      weaver.collect_unused_chunk_errors
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Parse remaining command-line file arguments.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">parse_arguments</span>
      expect_at_least(<span class="Constant">1</span>, <span class="Special">&quot;</span><span class="Constant">chunk files to weave</span><span class="Special">&quot;</span>)
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return the banner line of the help message.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">banner</span>
      <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant">codnar-weave - Weave documentation chunks to a single HTML.</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return the name and description of any final command-line file arguments.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">arguments</span>
      <span class="Statement">return</span> <span class="Special">&quot;</span><span class="Constant">MAIN-CHUNK ADDITIONAL-CHUNKS</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">Chunk files to weave together.</span><span class="Special">&quot;</span>
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return a short description of the program.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Identifier">description</span>
      print(&lt;&lt;-<span class="Special">EOF</span>.unindent)
<span class="Constant">        Weave chunks in all chunk files (from codnar-split) to a single HTML that is</span>
<span class="Constant">        printed to the output. The first file is the main documentation file that is</span>
<span class="Constant">        expected to include all the rest of the chunks via directives of the format:</span>

<span class="Constant">          &lt;embed src=&quot;chunk-name&quot; type=&quot;x-codnar/template-name&quot;&gt;&lt;/embed&gt;</span>

<span class="Constant">        Where the template-name is a key in the configuration, whose value is an ERB</span>
<span class="Constant">        template for embedding the named chunk into the documentation.</span>

<span class="Constant">        If no configuration is specified, the WEAVE_INCLUDE configuration is assumed.</span>
<span class="Constant">        This configuration contains a single template named &quot;include&quot;, which simply</span>
<span class="Constant">        includes the named chunk into the generated HTML.</span>
<span class="Constant">      </span><span class="Special">EOF</span>
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<p>
And here is the actual command-line application script:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="bin-codnar-weave">
<span>bin/codnar-weave</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">#!/usr/bin/ruby -w</span>

<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>

<span class="Statement">exit</span> <span class="Type">Codnar</span>::<span class="Type">Weave</span>.new.run
</pre>
</div>
</div>
</p>
<h3>Rake Integration</h3>
<p>
For Ruby projects (or any other project using Rake), it is also possible to
invoke Codnar using Rake tasks. Here is a simple test demonstrating using the
Rake tasks:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="test-rake-tasks-rb">
<span>test/rake_tasks.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/rake</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/test</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">test/spec</span><span class="Special">&quot;</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Test rake tasks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="PreProc">class</span> <span class="Type">TestRakeTasks</span> &lt; <span class="Type">Test</span>::<span class="Type">Unit</span>::<span class="Type">TestCase</span>

  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithFakeFS</span>
  <span class="PreProc">include</span> <span class="Type">Test</span>::<span class="Type">WithRake</span>

  <span class="PreProc">def</span> <span class="Identifier">test_default</span>
    run_rake
    test_results
  <span class="PreProc">end</span>

<span class="Statement">protected</span>

  <span class="PreProc">def</span> <span class="Identifier">run_rake</span>
    write_fake_file(<span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">\n</span><span class="Special">&quot;</span>)
    <span class="Type">Codnar</span>::<span class="Type">Rake</span>::<span class="Type">SplitTask</span>.new([ <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span> ], [])
    <span class="Type">Codnar</span>::<span class="Type">Rake</span>::<span class="Type">WeaveTask</span>.new(<span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, [])
    <span class="Identifier">@rake</span>[<span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>].invoke
  <span class="PreProc">end</span>

  <span class="PreProc">def</span> <span class="Identifier">test_results</span>
    chunk_file = <span class="Type">Codnar</span>::<span class="Type">Rake</span>.chunks_dir + <span class="Special">&quot;</span><span class="Constant">/foo</span><span class="Special">&quot;</span>
    <span class="Type">YAML</span>.load_file(chunk_file).should == [ {
      <span class="Special">&quot;</span><span class="Constant">html</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">name</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>,
      <span class="Special">&quot;</span><span class="Constant">locations</span><span class="Special">&quot;</span> =&gt; [ { <span class="Special">&quot;</span><span class="Constant">file</span><span class="Special">&quot;</span> =&gt; <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant">line</span><span class="Special">&quot;</span> =&gt; <span class="Constant">1</span> } ],
      <span class="Special">&quot;</span><span class="Constant">containers</span><span class="Special">&quot;</span> =&gt; [],
      <span class="Special">&quot;</span><span class="Constant">contained</span><span class="Special">&quot;</span> =&gt; [],
    } ]
    <span class="Type">File</span>.read(<span class="Special">&quot;</span><span class="Constant">codnar.html</span><span class="Special">&quot;</span>).should == <span class="Special">&quot;</span><span class="Constant">foo</span><span class="Special">\n</span><span class="Special">&quot;</span>
    <span class="Type">Codnar</span>::<span class="Type">Rake</span>.chunk_files.should == [ chunk_file ]
  <span class="PreProc">end</span>

<span class="PreProc">end</span>
</pre>
</div>
</div>
</p>
<p>
To use these tasks in a Rakefile, one needs to <code>require 'codnar/rake'</code>. The
code implements a singleton that holds the global state shared between tasks:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-rake-rb">
<span>lib/codnar/rake.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">rake</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">rake/tasklib</span><span class="Special">&quot;</span>

<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/rake/split_task</span><span class="Special">&quot;</span>
<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">codnar/rake/weave_task</span><span class="Special">&quot;</span>

<span class="PreProc">module</span> <span class="Type">Codnar</span>

</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
This module contains all the Codnar Rake tasks code.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="PreProc">module</span> <span class="Type">Rake</span>

    <span class="PreProc">class</span> &lt;&lt; <span class="Constant">self</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
The root folder to store all chunk files under.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="Statement">attr_accessor</span> <span class="Constant">:chunks_dir</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
The list of split chunk files for later weaving.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="Statement">attr_accessor</span> <span class="Constant">:chunk_files</span>

    end

    <span class="Type">Rake</span>.chunk_files = []
    <span class="Type">Rake</span>.chunks_dir = <span class="Special">&quot;</span><span class="Constant">chunks</span><span class="Special">&quot;</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Compute options for invoking an application.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">application_options</span>(output, configurations)
      options = [ <span class="Special">&quot;</span><span class="Constant">-o</span><span class="Special">&quot;</span>, output ]
      options += configurations.map { |<span class="Identifier">configuration</span>| [ <span class="Special">&quot;</span><span class="Constant">-c</span><span class="Special">&quot;</span>, configuration.to_s ] }.flatten
      <span class="Statement">return</span> options
    <span class="PreProc">end</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Return the list of actual configuration files (as opposed to names of
built-in configurations) for use as dependencies.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">configuration_files</span>(configurations)
      <span class="Statement">return</span> configurations.find_all { |<span class="Identifier">configuration</span>| <span class="Type">File</span>.exists?(configuration.to_s) }
    <span class="PreProc">end</span>

  end

end
</pre>
</div>
</div>
</p>
<h4>Task for splitting files</h4>
<p>
To split one or more files to chunks, create a new SplitTask. Multiple such
tasks may be created; this is required if different files need to be split
using different configurations.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-rake-split-task-rb">
<span>lib/codnar/rake/split_task.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

  <span class="PreProc">module</span> <span class="Type">Rake</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
A Rake task for splitting source files to chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">class</span> <span class="Type">SplitTask</span> &lt; ::<span class="Type">Rake</span>::<span class="Type">TaskLib</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Create a new Rake task for splitting source files to chunks. Each of the
specified disk files is split using the specified set of configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">initialize</span>(paths, configurations)
        <span class="Identifier">@configurations</span> = configurations
        paths.each <span class="Statement">do</span> |<span class="Identifier">path</span>|
          define_tasks(path)
        <span class="Statement">end</span>
      <span class="PreProc">end</span>

    <span class="Statement">protected</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define the tasks for splitting a single source file to chunks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">define_tasks</span>(path)
        output = <span class="Type">Rake</span>.chunks_dir + <span class="Special">&quot;</span><span class="Constant">/</span><span class="Special">&quot;</span> + path
        define_split_file_task(path, output)
        <span class="Type">SplitTask</span>.define_common_tasks
        <span class="Type">SplitTask</span>.connect_common_tasks(output)
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define the actual task for splitting the source file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">define_split_file_task</span>(path, output)
        ::<span class="Type">Rake</span>::<span class="Type">FileTask</span>.define_task(output =&gt; [ path ] + <span class="Type">Rake</span>.configuration_files(<span class="Identifier">@configurations</span>)) <span class="Statement">do</span>
          run_split_application(path, output)
        <span class="Statement">end</span>
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run the Split application for a single source file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">run_split_application</span>(path, output)
        options = <span class="Type">Rake</span>.application_options(output, <span class="Identifier">@configurations</span>)
        options &lt;&lt; path
        status = <span class="Type">Application</span>.with_argv(options) { <span class="Type">Split</span>.new.run }
        <span class="Statement">raise</span> <span class="Special">&quot;</span><span class="Constant">Codnar split errors</span><span class="Special">&quot;</span> <span class="Statement">unless</span> status == <span class="Constant">0</span>
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define common Rake split tasks. This method may be invoked several times,
only the first invocation actually defined the tasks. The common tasks are
codnar_split (for splitting all the source files) and clean_codnar (for
getting rid of the chunks directory).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">define_common_tasks</span>
        <span class="Identifier">@defined_common_tasks</span> ||= <span class="Type">SplitTask</span>.create_common_tasks
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Actually create common Rake split tasks.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">create_common_tasks</span>
        desc <span class="Special">&quot;</span><span class="Constant">Split all files into chunks</span><span class="Special">&quot;</span>
        ::<span class="Type">Rake</span>::<span class="Type">Task</span>.define_task(<span class="Special">&quot;</span><span class="Constant">codnar_split</span><span class="Special">&quot;</span>)
        desc <span class="Special">&quot;</span><span class="Constant">Clean all split chunks</span><span class="Special">&quot;</span>
        ::<span class="Type">Rake</span>::<span class="Type">Task</span>.define_task(<span class="Special">&quot;</span><span class="Constant">clean_codnar</span><span class="Special">&quot;</span>) { <span class="Type">FileUtils</span>.rm_rf(<span class="Type">Rake</span>.chunks_dir) }
        ::<span class="Type">Rake</span>::<span class="Type">Task</span>.define_task(<span class="Constant">:clean</span> =&gt; <span class="Special">&quot;</span><span class="Constant">clean_codnar</span><span class="Special">&quot;</span>)
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
For some reason, <code>include ::Rake::DSL</code> doesn’t give us this
and life is too short…
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">desc</span>(description)
        ::<span class="Type">Rake</span>.application.last_description = description
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Connect the task for splitting a single source file to the common task of
splitting all source files.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Constant">self</span>.<span class="Identifier">connect_common_tasks</span>(output)
        ::<span class="Type">Rake</span>::<span class="Type">Task</span>.define_task(<span class="Special">&quot;</span><span class="Constant">codnar_split</span><span class="Special">&quot;</span> =&gt; output)
        <span class="Type">Rake</span>::chunk_files &lt;&lt; output
      <span class="PreProc">end</span>

    end

  end

end
</pre>
</div>
</div>
</p>
<h4>Task for weaving chunks</h4>
<p>
To weave the chunks together, create a single WeaveTask.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-rake-weave-task-rb">
<span>lib/codnar/rake/weave_task.rb</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="PreProc">module</span> <span class="Type">Codnar</span>

  <span class="PreProc">module</span> <span class="Type">Rake</span>

</pre>
    <table class='layout'>
<tr>
<td class='indentation'>
<pre>    </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
A Rake task for weaving chunks to a single HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
    <span class="PreProc">class</span> <span class="Type">WeaveTask</span> &lt; ::<span class="Type">Rake</span>::<span class="Type">TaskLib</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Create a Rake task for weaving chunks to a single HTML. The root source
file is expected to embed all the chunks into the output HTML. The chunks
are loaded from the results of all the previous created SplitTask-s.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">initialize</span>(root, configurations, output = <span class="Special">&quot;</span><span class="Constant">codnar.html</span><span class="Special">&quot;</span>)
        <span class="Identifier">@root</span> = <span class="Type">Rake</span>.chunks_dir + <span class="Special">&quot;</span><span class="Constant">/</span><span class="Special">&quot;</span> + root
        <span class="Identifier">@output</span> = output
        <span class="Identifier">@configurations</span> = configurations
        define_tasks
      <span class="PreProc">end</span>

    <span class="Statement">protected</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define the tasks for weaving the chunks to a single HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">define_tasks</span>
        define_weave_task
        connect_common_tasks
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Define the actual task for weaving the chunks to a single HTML.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">define_weave_task</span>
        desc <span class="Special">&quot;</span><span class="Constant">Weave chunks into HTML</span><span class="Special">&quot;</span> <span class="Statement">unless</span> ::<span class="Type">Rake</span>.application.last_comment
        ::<span class="Type">Rake</span>::<span class="Type">Task</span>.define_task(<span class="Special">&quot;</span><span class="Constant">codnar_weave</span><span class="Special">&quot;</span> =&gt; <span class="Identifier">@output</span>)
        ::<span class="Type">Rake</span>::<span class="Type">FileTask</span>.define_task(<span class="Identifier">@output</span> =&gt; <span class="Type">Rake</span>.chunk_files + <span class="Type">Rake</span>.configuration_files(<span class="Identifier">@configurations</span>)) <span class="Statement">do</span>
          run_weave_application
        <span class="Statement">end</span>
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Run the Weave application for a single source file.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">run_weave_application</span>
        options = <span class="Type">Rake</span>.application_options(<span class="Identifier">@output</span>, <span class="Identifier">@configurations</span>)
        options &lt;&lt; <span class="Identifier">@root</span>
        options += <span class="Type">Rake</span>.chunk_files.reject { |<span class="Identifier">chunk</span>| chunk == <span class="Identifier">@root</span> }
        status = <span class="Type">Application</span>.with_argv(options) { <span class="Type">Weave</span>.new.run }
        <span class="Statement">raise</span> <span class="Special">&quot;</span><span class="Constant">Codnar weave errors</span><span class="Special">&quot;</span> <span class="Statement">unless</span> status == <span class="Constant">0</span>
      <span class="PreProc">end</span>

</pre>
      <table class='layout'>
<tr>
<td class='indentation'>
<pre>      </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Connect the task for cleaning up after weaving
(<code>clobber_codnar</code>) to the common task of cleaning up everything
(<code>clobber</code>).
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
      <span class="PreProc">def</span> <span class="Identifier">connect_common_tasks</span>
        desc <span class="Special">&quot;</span><span class="Constant">Build the code narrative HTML</span><span class="Special">&quot;</span>
        ::<span class="Type">Rake</span>::<span class="Type">Task</span>.define_task(<span class="Constant">:codnar</span> =&gt; <span class="Special">&quot;</span><span class="Constant">codnar_weave</span><span class="Special">&quot;</span>)
        desc <span class="Special">&quot;</span><span class="Constant">Remove woven HTML documentation</span><span class="Special">&quot;</span>
        ::<span class="Type">Rake</span>::<span class="Type">Task</span>.define_task(<span class="Special">&quot;</span><span class="Constant">clobber_codnar</span><span class="Special">&quot;</span>) { rm_rf(<span class="Identifier">@output</span>) }
        ::<span class="Type">Rake</span>::<span class="Type">Task</span>.define_task(<span class="Constant">:clobber</span> =&gt; <span class="Special">&quot;</span><span class="Constant">clobber_codnar</span><span class="Special">&quot;</span>)
      <span class="PreProc">end</span>

    end

  end

end
</pre>
</div>
</div>
</p>
<h2>Building the Codnar gem</h2>
<p>
The following Rakefile is in charge of building the gem, with the help of some
tools described below.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="rakefile">
<span>Rakefile</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>
<span class="Identifier">$LOAD_PATH</span>.unshift(<span class="Type">File</span>.dirname(<span class="Constant">__FILE__</span>) + <span class="Special">&quot;</span><span class="Constant">/lib</span><span class="Special">&quot;</span>)

<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">olag/rake</span><span class="Special">&quot;</span>

</pre>
<pre class='nested chunk'>
<a class='nested chunk' href='#codnar-configurations'>Codnar configurations</a>
</pre>
<pre class='ruby code syntax'>

spec = <span class="Type">Gem</span>::<span class="Type">Specification</span>.new <span class="Statement">do</span> |<span class="Identifier">spec</span>|
  spec.name = <span class="Special">&quot;</span><span class="Constant">codnar</span><span class="Special">&quot;</span>
  spec.version = <span class="Type">Codnar</span>::<span class="Type">VERSION</span>
  spec.title = <span class="Special">&quot;</span><span class="Constant">Code Narrator</span><span class="Special">&quot;</span>
  spec.author = <span class="Special">&quot;</span><span class="Constant">Oren Ben-Kiki</span><span class="Special">&quot;</span>
  spec.email = <span class="Special">&quot;</span><span class="Constant">rubygems-oren@ben-kiki.org</span><span class="Special">&quot;</span>
  spec.homepage = <span class="Special">&quot;</span><span class="Constant"><a href="https://rubygems.org/gems/codnar">https://rubygems.org/gems/codnar</a></span><span class="Special">&quot;</span>
  spec.summary = <span class="Special">&quot;</span><span class="Constant">Code narrator - an inverse literate programming tool.</span><span class="Special">&quot;</span>
  spec.description = (&lt;&lt;-<span class="Special">EOF</span>).gsub(<span class="Special">/</span><span class="Special">^</span><span class="Special">\s</span><span class="Special">+</span><span class="Special">/</span>, <span class="Special">&quot;&quot;</span>).chomp.gsub(<span class="Special">&quot;</span><span class="Special">\n</span><span class="Special">&quot;</span>, <span class="Special">&quot;</span><span class="Constant"> </span><span class="Special">&quot;</span>)
<span class="Constant">    Code Narrator (Codnar) is an inverse literate programming tool. It splits the</span>
<span class="Constant">    source files into &quot;chunks&quot; (including structured comments) and weaves them back</span>
<span class="Constant">    into a narrative that describes the overall system.</span>
<span class="Constant">  </span><span class="Special">EOF</span>
  spec.add_dependency(<span class="Special">&quot;</span><span class="Constant">andand</span><span class="Special">&quot;</span>)
  spec.add_dependency(<span class="Special">&quot;</span><span class="Constant">coderay</span><span class="Special">&quot;</span>)
  spec.add_dependency(<span class="Special">&quot;</span><span class="Constant">rdiscount</span><span class="Special">&quot;</span>)
<span class="Statement">end</span>

<span class="Type">Olag</span>::<span class="Type">Rake</span>.new(spec)
</pre>
</div>
</div>
</p>
<p>
The generated HTML requires some tweaking to yield aesthetic, readable results.
This tweaking consists of using Javascript to control chunk visibility,
generating a table of content, and using CSS to make the HTML look better.
</p>
<p>
Here are the modified configurations for generating the correct HTML:
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="codnar-configurations">
<span>Codnar configurations</span>
</a>
</div>
<div class="chunk html">
<pre class='ruby code syntax'>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Override the default Codnar configurations.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
<span class="Type">Olag</span>::<span class="Type">Rake</span>::<span class="Type">CODNAR_CONFIGURATIONS</span>.unshift([
</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Exclude the data files and images from the generated documentation.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Special">&quot;</span><span class="Constant">lib/codnar/data/.*/.*|.*\.png</span><span class="Special">&quot;</span>,
], [
</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Tests should not have chunks detected in them. They may however contain
HTML islands.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Special">&quot;</span><span class="Constant">test/.*\.rb</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_source_code:ruby</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_code_gvim_css:ruby</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_nested_code:ruby:html</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_nested_code:ruby:dot</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_nested_code:ruby:svg</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_code_gvim_css:html</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_code_gvim_css:dot</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_code_gvim_css:svg</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_shell_comments</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_rdoc_comments</span><span class="Special">&quot;</span>,
], [
</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
Ruby sources contain HTML islands.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Special">&quot;</span><span class="Constant">Rakefile|.*\.rb|bin/.*</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_source_code:ruby</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_code_gvim_css:ruby</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_nested_code:ruby:html</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_code_gvim_css:html</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_shell_comments</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_rdoc_comments</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">chunk_by_vim_regions</span><span class="Special">&quot;</span>,
], [
</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
We also have Javascript sources.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Special">&quot;</span><span class="Constant">.*\.js</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_source_code:javascript</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_code_gvim_css:javascript</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_c_comments</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_markdown_comments</span><span class="Special">&quot;</span>
], [
</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='rdoc comment markup'>
<p>
We also have CSS sources.
</p>
</div>
</td>
</tr>
</table>
<pre class='ruby code syntax'>
  <span class="Special">&quot;</span><span class="Constant">.*\.css</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_source_code:css</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_code_gvim_css:css</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">classify_c_comments</span><span class="Special">&quot;</span>,
  <span class="Special">&quot;</span><span class="Constant">format_markdown_comments</span><span class="Special">&quot;</span>
])

</pre>
</div>
<div class="chunk containers">
<span class="chunk containers header">Contained in:</span>
<ul class="chunk containers">
<li class="chunk container">
<a class="chunk container" href="#rakefile">Rakefile</a>
</li>
</ul>
</div>
</div>
</p>
<h3>Javascript chunk visibilty control</h3>
<p>
The following code injects visibility controls ("+"/"-" toggles) next to each
embedded code chunk. It also hides all the chunks by default; this increases
the readability of the overall narrative, turning it into a high-level summary.
Expanding the embedded code chunks allows the reader to delve into the details.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-data-control-chunks-js">
<span>lib/codnar/data/control_chunks.js</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Quick-and-dirty JS for inserting a "+"/"-" control for chunk visibility next
to each chunk's name. By default, all chunks are hidden.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> inject_chunk_controls() <span class="Identifier">{</span>
  <span class="Identifier">var</span> name_div;
  foreach_chunk_elements(<span class="Identifier">function</span>(div) <span class="Identifier">{</span>
    name_div = div;
  <span class="Identifier">}</span>, <span class="Identifier">function</span>(html_div) <span class="Identifier">{</span>
    <span class="Identifier">var</span> control_span = <span class="Statement">document</span>.createElement(<span class="Constant">&quot;span&quot;</span>);
    <span class="Identifier">var</span> hide = <span class="Identifier">function</span>() <span class="Identifier">{</span>
      control_span.innerHTML = <span class="Constant">&quot;+&quot;</span>;
      html_div.style.display = <span class="Constant">&quot;none&quot;</span>;
    <span class="Identifier">}</span>
    <span class="Identifier">var</span> show = <span class="Identifier">function</span>() <span class="Identifier">{</span>
      control_span.innerHTML = <span class="Constant">&quot;&amp;#8211;&quot;</span>; <span class="Comment">// Vertical bar.</span>
      html_div.style.display = <span class="Constant">&quot;block&quot;</span>;
    <span class="Identifier">}</span>
    name_div.onclick = <span class="Identifier">function</span>() <span class="Identifier">{</span>
      html_div.style.display == <span class="Constant">&quot;block&quot;</span> ? hide() : show();
    <span class="Identifier">}</span>
    hide(); <span class="Comment">// Initializes html_div.style.display</span>
    control_span.className = <span class="Constant">&quot;control chunk&quot;</span>;
    name_div.insertBefore(control_span, name_div.firstChild);
  <span class="Identifier">}</span>)
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Loop on all DIV elements that contain a chunk name, or that contain chunk
HTML. Assumes that they come in pairs - name first, HTML second.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> foreach_chunk_elements(name_lambda, html_lambda) <span class="Identifier">{</span>
  <span class="Identifier">var</span> div_elements = <span class="Statement">document</span>.getElementsByTagName(<span class="Constant">&quot;div&quot;</span>);
  <span class="Statement">for</span> (<span class="Identifier">var</span> e <span class="Statement">in</span> div_elements) <span class="Identifier">{</span>
    <span class="Identifier">var</span> div = div_elements<span class="Identifier">[</span>e<span class="Identifier">]</span>;
    classes = <span class="Constant">&quot; &quot;</span> + div.className + <span class="Constant">&quot; &quot;</span>;
    <span class="Statement">if</span> (!<span class="Constant">/ chunk /</span>.test(classes)) <span class="Statement">continue</span>;
    <span class="Statement">if</span> (<span class="Constant">/ name /</span>.test(classes)) name_lambda(div);
    <span class="Statement">if</span> (<span class="Constant">/ html /</span>.test(classes)) html_lambda(div);
  <span class="Identifier">}</span>
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Only invoke it after all helper functions are defined.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
inject_chunk_controls();
</pre>
</div>
</div>
</p>
<h3>Javascript table of content</h3>
<p>
The following code is not very efficient or elegant but it does a basic job of
iunjecting a table of content into the generated HTML.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-data-contents-js">
<span>lib/codnar/data/contents.js</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Quick-and-dirty JS for inserting a table of content inside a DIV with the id
"contents". The table of content is a series of nested UL and LI elements,
prefixed with an H1 containing the text "0 Contents". This H1 comes in
addition to the single static H1 expected by HTML best practices. It looks
"right" and should not confuse search engines etc. since they do not execute
Javascript code.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> inject_contents() <span class="Identifier">{</span>
  <span class="Identifier">var</span> contents = <span class="Statement">document</span>.getElementById(<span class="Constant">&quot;contents&quot;</span>);
  <span class="Identifier">var</span> lists = contents_lists();
  contents.appendChild(contents_header()); <span class="Comment">// TRICKY: Must be done after contents_lists().</span>
  contents.appendChild(lists);
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Create a table of contents H1.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> contents_header() <span class="Identifier">{</span>
  <span class="Identifier">var</span> h = <span class="Statement">document</span>.createElement(<span class="Constant">&quot;h1&quot;</span>);
  <span class="Identifier">var</span> text = <span class="Statement">document</span>.createTextNode(<span class="Constant">&quot;Contents&quot;</span>);
  h.appendChild(text);
  <span class="Statement">return</span> h;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Create nested UL/LI lists for the table of content.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> contents_lists() <span class="Identifier">{</span>
  <span class="Identifier">var</span> container;
  <span class="Identifier">var</span> indices = <span class="Identifier">[]</span>;
  <span class="Identifier">var</span> h_elements = all_h_elements();
</pre>
  <table class='layout'>
<tr>
<td class='indentation'>
<pre>  </pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Using "for (var e in h_elements)" is too sensitive to other libraries
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
  <span class="Statement">for</span> (<span class="Identifier">var</span> e = 0; e &lt; h_elements.length; e++) <span class="Identifier">{</span>
    h = h_elements<span class="Identifier">[</span>e<span class="Identifier">]</span>;
    <span class="Identifier">var</span> level = h.tagName.substring(1, 2) - 1;
    container = pop_container(container, indices, level);
    container = push_container(container, indices, level);
    <span class="Identifier">var</span> id = indices.join(<span class="Constant">&quot;.&quot;</span>);
    container.appendChild(list_element(id, h));
    h.insertBefore(header_anchor(id), h.firstChild);
  <span class="Identifier">}</span>
  <span class="Statement">return</span> pop_container(container, indices, 1);
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Get a list of all H elements in the DOM. We skip the single H1 element;
otherwise it would just have the index "1" which would be prefixed to all
other headers.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> all_h_elements() <span class="Identifier">{</span>
  <span class="Identifier">var</span> elements = <span class="Statement">document</span>.getElementsByTagName(<span class="Constant">&quot;*&quot;</span>);
  <span class="Identifier">var</span> h_elements = <span class="Identifier">[]</span>;
  <span class="Statement">for</span> (<span class="Identifier">var</span> e <span class="Statement">in</span> elements) <span class="Identifier">{</span>
    <span class="Identifier">var</span> h = elements<span class="Identifier">[</span>e<span class="Identifier">]</span>;
    <span class="Statement">if</span> (<span class="Constant">/^h[2-9]$/i</span>.test(h.tagName)) h_elements.push(h);
  <span class="Identifier">}</span>
  <span class="Statement">return</span> h_elements;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Pop indices (and UL containers) until reaching up to a given level.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> pop_container(container, indices, level) <span class="Identifier">{</span>
  <span class="Statement">while</span> (indices.length &gt; level) <span class="Identifier">{</span>
    container = container.parentNode;
    indices.pop();
  <span class="Identifier">}</span>
  <span class="Statement">return</span> container;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Push indices (and UL containers) until reaching doen to a given level.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> push_container(container, indices, level) <span class="Identifier">{</span>
  <span class="Statement">while</span> (indices.length &lt; level) <span class="Identifier">{</span>
    <span class="Comment">// TRICKY: push a 0 for the very last new level, so the ++ at the end</span>
    <span class="Comment">// will turn it into a 1.</span>
    indices.push(indices.level &lt; level - 1);
    <span class="Identifier">var</span> ul = <span class="Statement">document</span>.createElement(<span class="Constant">&quot;ul&quot;</span>);
    <span class="Statement">if</span> (container) <span class="Identifier">{</span>
      container.appendChild(ul);
    <span class="Identifier">}</span>
    container = ul;
  <span class="Identifier">}</span>
  indices<span class="Identifier">[</span>indices.length - 1<span class="Identifier">]</span>++;
  <span class="Statement">return</span> container;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Create a LI for an H element with some id.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> list_element(id, h) <span class="Identifier">{</span>
  <span class="Identifier">var</span> a = <span class="Statement">document</span>.createElement(<span class="Constant">&quot;a&quot;</span>);
  a.href = <span class="Constant">&quot;#&quot;</span> + id;
  a.innerHTML = id + <span class="Constant">&quot;&amp;nbsp;&quot;</span> + h.innerHTML;
  <span class="Identifier">var</span> li = <span class="Statement">document</span>.createElement(<span class="Constant">&quot;li&quot;</span>);
  li.appendChild(a);
  <span class="Statement">return</span> li;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Create an anchor for an H element with some id.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
<span class="Identifier">function</span> header_anchor(id) <span class="Identifier">{</span>
  <span class="Identifier">var</span> text = <span class="Statement">document</span>.createTextNode(id + <span class="Constant">&quot; &quot;</span>);
  <span class="Identifier">var</span> a = <span class="Statement">document</span>.createElement(<span class="Constant">&quot;a&quot;</span>);
  a.id = id;
  a.appendChild(text);
  <span class="Statement">return</span> a;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Only invoke it after all helper functions are defined.
</p>
</div>
</td>
</tr>
</table>
<pre class='javascript code syntax'>
inject_contents();
</pre>
</div>
</div>
</p>
<h3>CSS style</h3>
<p>
To avoid dealing with the different default styles used by different browsers,
we employ the YUI CSS <a href="http://developer.yahoo.com/yui/reset/">reset</a> and
<a href="http://developer.yahoo.com/yui/base/">base</a> files. Resetting and restoring the
default CSS styles is inelegant, but it is the only current way to get a
consistent presentation of HTML. Once this is out of the way, we apply styles
specific to our HTML. Some of these override the default styles established by
the base CSS file above. We do this instead of directly tweaking the base CSS
file, to allow easy upgrade to new versions if/when YUI release any.
</p>
<p>
<div class="named_with_containers chunk">
<div class="chunk name">
<a name="lib-codnar-data-style-css">
<span>lib/codnar/data/style.css</span>
</a>
</div>
<div class="chunk html">
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Margin &amp; Padding
</p>
</div>
</td>
</tr>
</table>
<pre class='css code syntax'>

<span class="Statement">div</span><span class="Identifier">.chunk.name</span>,
<span class="Statement">div</span><span class="Identifier">.chunk.html</span>,
<span class="Statement">div</span><span class="Identifier">.chunk.containers</span>,
<span class="Statement">div</span><span class="Identifier">.chunk</span> <span class="Statement">table</span>,
<span class="Statement">div</span><span class="Identifier">.chunk</span> <span class="Statement">td</span>,
<span class="Statement">div</span><span class="Identifier">.chunk</span> <span class="Statement">pre</span> <span class="Identifier">{</span>
  <span class="Type">margin</span>: <span class="Constant">0</span>;
  <span class="Type">padding</span>: <span class="Constant">0</span>;
<span class="Identifier">}</span>
<span class="Statement">div</span><span class="Identifier">.chunk</span> <span class="Statement">*</span>:last-child <span class="Identifier">{</span>
  <span class="Type">margin-bottom</span>: <span class="Constant">0</span>;
<span class="Identifier">}</span>
<span class="Statement">h4</span>, <span class="Statement">h5</span>, <span class="Statement">h6</span>,
<span class="Statement">div</span><span class="Identifier">.chunk</span>,
<span class="Statement">div</span><span class="Identifier">.comment</span> <span class="Statement">pre</span> <span class="Identifier">{</span>
  <span class="Type">margin</span>: <span class="Constant">1em</span> <span class="Constant">0</span>;
<span class="Identifier">}</span>
<span class="Statement">pre</span>,
<span class="Statement">div</span><span class="Identifier">.comment</span>,
<span class="Statement">div</span><span class="Identifier">.chunk.html</span> <span class="Identifier">{</span>
  <span class="Type">padding</span>: <span class="Constant">0.33em</span>;
<span class="Identifier">}</span>

<span class="Statement">span</span><span class="Identifier">.control.chunk</span> <span class="Identifier">{</span>
  <span class="Type">padding-left</span>: <span class="Constant">0.25em</span>;
  <span class="Type">padding-right</span>: <span class="Constant">0.25em</span>;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Table of content
</p>
</div>
</td>
</tr>
</table>
<pre class='css code syntax'>

<span class="Statement">div</span><span class="Identifier">#contents</span> <span class="Statement">ul</span> <span class="Identifier">{</span>
  <span class="Type">margin-top</span>: <span class="Constant">0</span>;
  <span class="Type">margin-bottom</span>: <span class="Constant">0</span>;
  <span class="Type">padding</span>: <span class="Constant">0</span>;
<span class="Identifier">}</span>

<span class="Statement">div</span><span class="Identifier">#contents</span> <span class="Statement">li</span> <span class="Identifier">{</span>
  <span class="Type">list-style-type</span>: <span class="Type">none</span>;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Lists
</p>
</div>
</td>
</tr>
</table>
<pre class='css code syntax'>

<span class="Statement">ul</span><span class="Identifier">.chunk.containers</span> <span class="Identifier">{</span>
  <span class="Type">padding</span>: <span class="Constant">0</span>;
  <span class="Type">margin</span>: <span class="Constant">0</span>;
  <span class="Type">display</span>: <span class="Type">inline</span>;
<span class="Identifier">}</span>
<span class="Statement">ul</span><span class="Identifier">.chunk.containers</span> <span class="Statement">li</span> <span class="Identifier">{</span>
  <span class="Type">display</span>: <span class="Type">inline</span>;
  <span class="Type">list-style-type</span>: <span class="Type">none</span>;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Borders
</p>
</div>
</td>
</tr>
</table>
<pre class='css code syntax'>

<span class="Statement">pre</span>,
<span class="Statement">span</span><span class="Identifier">.control.chunk</span>,
<span class="Statement">div</span><span class="Identifier">.chunk.html</span> <span class="Identifier">{</span>
  <span class="Type">border</span>: <span class="Constant">1px</span> <span class="Type">solid</span> <span class="Constant">#000</span>;
<span class="Identifier">}</span>

<span class="Statement">table</span><span class="Identifier">.layout</span> <span class="Statement">td</span><span class="Identifier">.indentation</span>,
<span class="Statement">div</span><span class="Identifier">.chunk</span> <span class="Statement">pre</span> <span class="Identifier">{</span>
  <span class="Type">border</span>: <span class="Type">none</span>;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Colors
</p>
</div>
</td>
</tr>
</table>
<pre class='css code syntax'>

<span class="Statement">span</span><span class="Identifier">.control.chunk</span>,
<span class="Statement">table</span><span class="Identifier">.layout</span> <span class="Statement">td</span><span class="Identifier">.html</span> <span class="Identifier">{</span>
  <span class="Type">background-color</span>: Beige;
<span class="Identifier">}</span>

</pre>
<table class='layout'>
<tr>
<td class='indentation'>
<pre></pre>
</td>
<td class='html'>
<div class='markdown comment markup'>
<p>
Fonts
</p>
</div>
</td>
</tr>
</table>
<pre class='css code syntax'>

<span class="Statement">body</span> <span class="Identifier">{</span>
  <span class="Type">font-family</span>: <span class="Type">Sans-Serif</span>;
<span class="Identifier">}</span>
<span class="Statement">pre</span> <span class="Identifier">{</span>
  <span class="Type">font-family</span>: Consolas, Inconsolata, Monaco, <span class="Constant">&quot;Courier New&quot;</span>, <span class="Type">Monospace</span>;
<span class="Identifier">}</span>
<span class="Statement">div</span><span class="Identifier">.chunk.name</span> <span class="Identifier">{</span>
  <span class="Type">font-weight</span>: <span class="Type">bold</span>;
<span class="Identifier">}</span>
</pre>
</div>
</div>
</p>
<h3>Using Sunlight</h3>
<p>
When using Sunlight for syntax highlighting, we also need to include some CSS
and Javascript files to convert the classified <code>pre</code> elements into properly
marked-up HTML. We also need to invoke this Javascript code (a one-line
operations). Here is what such code might look like inside a Javascript block
of the generated HTML:
</p>
<p>
  &lt;embed src="codnar/data/sunlight/min.js" type="x-codnar/file"/&gt;
  &lt;embed src="codnar/data/sunlight/ruby-min.js" type="x-codnar/file"/&gt;
  Sunlight.globalOptions.lineNumbers = false;
  Sunlight.highlightAll();
</p>
</div>
<script type="text/javascript">
/*
 * Quick-and-dirty JS for inserting a table of content inside a DIV with the id
 * "contents". The table of content is a series of nested UL and LI elements,
 * prefixed with an H1 containing the text "0 Contents". This H1 comes in
 * addition to the single static H1 expected by HTML best practices. It looks
 * "right" and should not confuse search engines etc. since they do not execute
 * Javascript code.
 */
function inject_contents() {
  var contents = document.getElementById("contents");
  var lists = contents_lists();
  contents.appendChild(contents_header()); // TRICKY: Must be done after contents_lists().
  contents.appendChild(lists);
}

/*
 * Create a table of contents H1.
 */
function contents_header() {
  var h = document.createElement("h1");
  var text = document.createTextNode("Contents");
  h.appendChild(text);
  return h;
}

/*
 * Create nested UL/LI lists for the table of content.
 */
function contents_lists() {
  var container;
  var indices = [];
  var h_elements = all_h_elements();
  /* Using "for (var e in h_elements)" is too sensitive to other libraries */
  for (var e = 0; e < h_elements.length; e++) {
    h = h_elements[e];
    var level = h.tagName.substring(1, 2) - 1;
    container = pop_container(container, indices, level);
    container = push_container(container, indices, level);
    var id = indices.join(".");
    container.appendChild(list_element(id, h));
    h.insertBefore(header_anchor(id), h.firstChild);
  }
  return pop_container(container, indices, 1);
}

/*
 * Get a list of all H elements in the DOM. We skip the single H1 element;
 * otherwise it would just have the index "1" which would be prefixed to all
 * other headers.
 */
function all_h_elements() {
  var elements = document.getElementsByTagName("*");
  var h_elements = [];
  for (var e in elements) {
    var h = elements[e];
    if (/^h[2-9]$/i.test(h.tagName)) h_elements.push(h);
  }
  return h_elements;
}

/*
 * Pop indices (and UL containers) until reaching up to a given level.
 */
function pop_container(container, indices, level) {
  while (indices.length > level) {
    container = container.parentNode;
    indices.pop();
  }
  return container;
}

/*
 * Push indices (and UL containers) until reaching doen to a given level.
 */
function push_container(container, indices, level) {
  while (indices.length < level) {
    // TRICKY: push a 0 for the very last new level, so the ++ at the end
    // will turn it into a 1.
    indices.push(indices.level < level - 1);
    var ul = document.createElement("ul");
    if (container) {
      container.appendChild(ul);
    }
    container = ul;
  }
  indices[indices.length - 1]++;
  return container;
}

/*
 * Create a LI for an H element with some id.
 */
function list_element(id, h) {
  var a = document.createElement("a");
  a.href = "#" + id;
  a.innerHTML = id + "&nbsp;" + h.innerHTML;
  var li = document.createElement("li");
  li.appendChild(a);
  return li;
}

/*
 * Create an anchor for an H element with some id.
 */
function header_anchor(id) {
  var text = document.createTextNode(id + " ");
  var a = document.createElement("a");
  a.id = id;
  a.appendChild(text);
  return a;
}

/* Only invoke it after all helper functions are defined. */
inject_contents();
/*
 * Quick-and-dirty JS for inserting a "+"/"-" control for chunk visibility next
 * to each chunk's name. By default, all chunks are hidden.
 */
function inject_chunk_controls() {
  var name_div;
  foreach_chunk_elements(function(div) {
    name_div = div;
  }, function(html_div) {
    var control_span = document.createElement("span");
    var hide = function() {
      control_span.innerHTML = "+";
      html_div.style.display = "none";
    }
    var show = function() {
      control_span.innerHTML = "&#8211;"; // Vertical bar.
      html_div.style.display = "block";
    }
    name_div.onclick = function() {
      html_div.style.display == "block" ? hide() : show();
    }
    hide(); // Initializes html_div.style.display
    control_span.className = "control chunk";
    name_div.insertBefore(control_span, name_div.firstChild);
  })
}

/*
 * Loop on all DIV elements that contain a chunk name, or that contain chunk
 * HTML. Assumes that they come in pairs - name first, HTML second.
 */
function foreach_chunk_elements(name_lambda, html_lambda) {
  var div_elements = document.getElementsByTagName("div");
  for (var e in div_elements) {
    var div = div_elements[e];
    classes = " " + div.className + " ";
    if (!/ chunk /.test(classes)) continue;
    if (/ name /.test(classes)) name_lambda(div);
    if (/ html /.test(classes)) html_lambda(div);
  }
}

/* Only invoke it after all helper functions are defined. */
inject_chunk_controls();
</script>
</body>
</html>
